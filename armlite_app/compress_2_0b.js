var maxHeight,maxWidth,lastKey=0,noKeyEffects=!1;function startIt(){getDimensions(),main()}function getDimensions(){"number"==typeof window.innerWidth?(maxWidth=window.innerWidth,maxHeight=window.innerHeight):(maxWidth=document.documentElement.clientWidth,maxHeight=document.documentElement.clientHeight)}function randomInt(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function getMilliseconds(){return(new Date).getTime()}function delay(e,t){for(var a=t+"(",r=2;r<arguments.length;r++)r>2&&(a+=","),a+=arguments[r];return a+=")",setTimeout(a,e)}var chrsToMatch=[],dnFnCall=[],upFnCall=[],chrsDown=[];function trapKey(e,t,a){var r=chrsToMatch.indexOf(e);-1==r&&(r=chrsToMatch.push(e)-1,chrsDown[r]=0),dnFnCall[r]=t,upFnCall[r]=a}function keyDown(e){var t=e.keyCode;if(8==t){var a,r=e.srcElement||e.target;switch(r.tagName.toUpperCase()){case"TEXTAREA":a=r.readOnly||r.disabled;break;case"INPUT":a=r.readOnly||r.disabled||r.attributes.type&&["radio","checkbox","submit","button"].indexOf(r.attributes.type.value.toLowerCase())>=0;break;case"DIV":a=r.readOnly||r.disabled||!(r.attributes.contentEditable&&"true"==r.attributes.contentEditable.value);break;default:a=!0;break}a&&e.preventDefault()}var n=String.fromCharCode(t);27!=t&&9!=t||(n=t);var s=chrsToMatch.indexOf(n);if(-1==s){if(noKeyEffects){if(0==(4&keyboardMask)){if(t>90)return;if(0==(2&keyboardMask)){if(t<48)return}else if(t<37||t>40&&t<48)return}lastKey=t,testKeyInterrupt(),e.preventDefault()}}else chrsDown[s]=1,dnFnCall[s]&&window[dnFnCall[s]](e)}function keyUp(e){var t=e.keyCode,a=String.fromCharCode(t);27!=t&&9!=t||(a=t);var r=chrsToMatch.indexOf(a);-1!=r&&1==chrsDown[r]&&(chrsDown[r]=0,upFnCall[r]&&window[upFnCall[r]](e))}var speed,inst,addr,stopping,oneStep,runTimer,lineNo,myTimeout=!1,scrollTimeout=!1,register=[],flags=0,pCounter=0,programText="",programHTML="",programEdit="",programSave="",output1="",fileRead="",fileResult=-1,address=[],v1address=[],v2address=[],instructionTxt=[],addrToLine=[],lineToByteAddress=[],slowSpeed=40,delayTime=4,comment_align=24,dynamicProgramWidth=!1,fileWriteBuffer=[],waitingForInput=!1,registerToInput=0,modifyingProgram=!1,running=!1,lastCodeHighlight=-1,lastMemHighlight=-1,breakpointAddr=-1,errorLineNum=-1,memOpt=2,maxUsableMem=1048576,overlay=0,lastPixelClick=-1,waitingForOverlay=!1,byteCount=0,instructionCount=0,measureSpeed=0,breakPoint=-1,hex=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],debug=0,xTime=0,interruptCnt=0,dotDataAddress=0,firstDataDefn=0,dontDisplay=0,binarySize=100,lastMessage="",oldPCMarker=-1,stepTxt="",step1Code=0,halted="Program HALTED. STOP, LOAD or EDIT",IOBase=4294967040,fakeBig=4294963968,charMax=512,charBase=4294963424,pixelBase=4294914048,vaddressBase=pixelBase,pixelAreaSize=3072,IOVectorBase=4294967168,IOVectors=[-1,-1,-1,-1,-1],interruptMask=0,keyboardMask=0,pinMask=0,clockIntFreq=0,pixelMask=0,interruptRequest=0,canSave=!1,haveSaved=!1,saveSeq=0,autoRun=0,serviceMode=!0,dotLabelNames=[".WriteSignedNum",".WriteUnsignedNum",".WriteHex",".WriteChar",".WriteString",".InputNum",".LastKey",".LastKeyAndReset",".Random",".InstructionCount",".Time",".PinISR",".SysISR",".KeyboardISR",".ClockISR",".InterruptRegister",".PinMask",".KeyboardMask",".ClockInterruptFrequency",".CodeLimit",".PixelScreen",".CharScreen",".OpenFile",".FileLength",".ReadFileChar",".ReadString",".InputFP",".WriteFP",".PixelAreaSize",".WriteFileChar",".WriteFile",".ClearScreen",".ReadSecret",".PixelISR",".LastPixelClicked",".LastPixelAndReset",".PixelMask",".Resolution"],dotLabelValues=[IOBase+16,IOBase+20,IOBase+24,IOBase+28,IOBase+32,IOBase+8,IOBase+16,IOBase+20,IOBase+32,IOBase+64,IOBase+68,IOVectorBase+4,IOVectorBase,IOVectorBase+8,IOVectorBase+12,IOBase+72,IOBase+76,IOBase+52,IOBase+56,IOBase+80,pixelBase,charBase,IOBase+84,IOBase+88,IOBase+92,IOBase+96,IOBase+100,IOBase+104,IOBase+108,IOBase+112,IOBase+116,IOBase+108,IOBase+36,IOVectorBase+16,IOBase+40,IOBase+44,IOBase+48,IOBase+60],dotLabelMode=[1,1,1,3,1,4,12,12,4,4,4,5,21,5,5,5,5,5,5,4,31,31,4,4,12,1,4,1,4,3,1,1,1,5,4,4,5,5];function matchDotLabel(e){var t;for(t=0;t<dotLabelNames.length;++t)if(e==dotLabelNames[t])return t;if(e.length>6&&e.startsWith(".Pixel")){var a=parseIntGen(e.substring(6));return isNaN(a)||a<0||a>767?-1:fakeBig+4*a}return-1}function matchIOAddress(e){var t;for(t=0;t<dotLabelValues.length;++t)if(e==dotLabelValues[t])return t;return-1}function main(){serviceMode=!1;var e=new URL(location),t=e.searchParams.get("slow_delay");t&&((a=parseInt(t))>1&&a<1e3&&(slowSpeed=a));(t=e.searchParams.get("fast_delay"))&&((a=parseInt(t))>0&&a<251&&(delayTime=a));((t=e.searchParams.get("data"))&&((t=t.toLowerCase()).startsWith("sig")&&(memOpt=0),t.startsWith("dec")&&(memOpt=0),t.startsWith("uns")&&(memOpt=1),t.startsWith("hex")&&(memOpt=2),t.startsWith("bin")&&(memOpt=3,addClass("xxbody","binary"))),t=e.searchParams.get("mem_k"))&&((a=parseInt(t))>=1&&a<=1024&&(maxUsableMem=1024*a));if(t=e.searchParams.get("debug")){var a=parseInt(t);debug=a}if(t=e.searchParams.get("profile"))addClass("xxbody","profile-"+t);else{dynamicProgramWidth=!0;var r=maxWidth-834;if(t=e.searchParams.get("progw"))(a=parseInt(t))>=300&&a<=3e3&&(r=a,dynamicProgramWidth=!1);setProgramWidth(r)}(t=e.searchParams.get("alcom"))&&((a=parseInt(t))>5&&a<301&&(comment_align=a));(binarySize=navigator.platform.indexOf("Win32")>-1?100:92,t=e.searchParams.get("binsiz"))&&((a=parseInt(t))>79&&a<101&&(binarySize=a));(t=e.searchParams.get("load"))?autoRun=1:(t=e.searchParams.get("submit"))?autoRun=2:(t=e.searchParams.get("run"))&&(autoRun=3),t&&(programText=decodeURIComponent(t),textToHtml()),window.document.title="ARMlite Assembly Language Simulator by Peter Higginson",trapKey(9,"tabKey",null),trapKey(27,"escKey",null),setupDivs(),updateR(0,0),updateR(1,0),updateR(2,0),updateR(3,0),updateR(4,0),updateR(5,0),updateR(6,0),updateR(7,0),updateR(8,0),updateR(9,0),updateR(10,0),updateR(11,0),updateR(12,0),updateR(13,maxUsableMem),updateR(14,0),updateFlags(0),updatePC(0),clearIR(),output1="System Messages",message("LOAD, EDIT a program or modify memory"),removeClass("program","edit"),setStateReady();for(var n=0;n<maxUsableMem;n+=4)setAddress(n,0);0!=autoRun&&(1==autoRun?openProgram2():(assemble(),0!=address[0]&&3==autoRun&&delay(100,"runOrig")))}function escKey(e){if(waitingForInput&&!myTimeout&&!myMaybe){if(e.preventDefault(),waitingForInput=!1,setStateReady(),savOpenAddress){var t=parseInt(savOpenAddress.id[1]);savOpenAddress.id.length>=3&&(t=10*t+parseInt(savOpenAddress.id[2])),savOpenAddress.id.length>=4&&(t=10*t+parseInt(savOpenAddress.id[3])),5==savOpenAddress.id.length&&(t=10*t+parseInt(savOpenAddress.id[4])),setAddress(4*(t+=64*overlay),address[t]),savOpenAddress=!1}else modifyingProgram&&(modifyingProgram=!1,textToHtml());message("ESC pressed to abort input")}}function tabKey(e){if(e.preventDefault(),waitingForInput&&!myTimeout&&!myMaybe)if(savOpenAddress){var t=parseInt(savOpenAddress.id[1]);savOpenAddress.id.length>=3&&(t=10*t+parseInt(savOpenAddress.id[2])),savOpenAddress.id.length>=4&&(t=10*t+parseInt(savOpenAddress.id[3])),5==savOpenAddress.id.length&&(t=10*t+parseInt(savOpenAddress.id[4]));var a=document.getElementById("aForm"),r=checkInput(a.value);loseAddress(a),t<127?(++t,r&&message("Modifying memory contents"),savOpenAddress=openNextMem(t),waitingForInput=!0,setStateEdit()):(waitingForInput=!1,setStateReady())}else modifyingProgram&&insertTabInProgramArea()}function openProgram(){waitingForInput||myTimeout||myMaybe||openProgram2()}function openProgram2(){message("Modifying Program Area");var e=document.getElementById("source"),t=Math.floor(e.scrollTop);setStateEdit(),openProgramArea(programEdit),waitingForInput=!0,modifyingProgram=!0,t&&(document.getElementById("pForm").scrollTop=t)}function programSubmit(){if(!waitingForInput)return debug&&alert("Bad - Submit when not waiting for input"),!1;programSubmit2(!0)}function programSubmit2(e){if((waitingForInput=!1,modifyingProgram=!1,removeClass("program","edit"),programText=getProgramArea(),e&&programText.length<10)&&programText.toLowerCase().startsWith("demo"))return demoSetup(),textToHtml(),assemble(),void delay(100,"runOrig");textToHtml(),assemble()}function demoSetup(){programText="MOV R11,#.black// Constant\nMOV R12,#.white// Constant\nMOV R1,#screen2 \nADD R3,R1,#12288// End\nclearPixel:\nSTR R12,[R1]// set everything white\nADD R1,R1,#4\nCMP R1,R3\nBLT clearPixel\n// Initialise 2nd screen with random pattern\nMOV R2,#screen2// 1st pixel\nADD R3,R2,#12288// End\nrandLoop:LDR R0,.Random\nAND R0,R0,#3// start with 25% set only\nCMP R0,#0\nBNE skip// only need to set blacks\nSTR R11,[R2]// set black\nskip:\nADD R2,R2,#4\nCMP R2,R3\nBLT randLoop\ncopyScreen2to1:\nMOV R1,#.PixelScreen\nMOV R2,#screen2\nADD R3,R1,#12288\ncopyLoop:\nLDR R0,[R2]\nSTR R0,[R1]\nADD R1,R1,#4\nADD R2,R2,#4\nCMP R1,R3\nBLT copyLoop\n// Next generation\nMOV R3,#0// R3 is cell offset,0 to 12288 (incr by 4)\nnextGenLoop:\nBL countBlock// count neighbours in R6\n// Now decide fate of cell\nMOV R2,#screen2\nADD R2,R2,R3\nCMP R6,#4\nBLT .+3 \nSTR R12,[R2]// Cell dies (or remains empty) if 4 or more neighbours\nB continue\nCMP R6,#3\nBLT .+3 \nSTR R11,[R2]// Cell born (or remains) if 3 or 4 neighbours\nB continue\nCMP R6,#2\nBEQ continue// Cell remains in present state if 2 neighbours\nSTR R12,[R2]// Cell dies (or remains empty) if < 2 neighbours\ncontinue:\nADD R3,R3,#4\nCMP R3,#12288\nBLT nextGenLoop\nB copyScreen2to1\n\n// R3 is pixel index,R6 return count\n// R11,R12 do not change,R5 used by countIfLive()\n// we use R1,R4 and R10 (as temp for LR!!!!)\ncountBlock:\nMOV R10,LR\nMOV R6,#0// Reset live count\nMOV R1,#.PixelScreen\nADD R1,R1,R3\nAND R4,R3,#255// index in row\nCMP R3,#256\nBLT topRow// remove all the special cases\nCMP R3,#12032\nBEQ leftBot// because BGE not in AQA set\nBGT botRow// and #12028 is > 8 bits\nCMP R4,#0\nBEQ leftCol\nCMP R4,#252\nBEQ rightCol\n// now can do original count neighbours\nSUB R1,R1,#256// North \nBL countIfLive\nADD R1,R1,#4// Northeast\nBL countIfLive\nADD R1,R1,#256// East\nBL countIfLive\nADD R1,R1,#256// Southeast\nBL countIfLive\nSUB R1,R1,#4// South\nBL countIfLive\nSUB R1,R1,#4// Southwest\nBL countIfLive\nSUB R1,R1,#256// West\nBL countIfLive\nSUB R1,R1,#256// Northwest\nBL countIfLive\nMOV PC,R10// RET\nrightCol:// but not top or bottom\nSUB R1,R1,#256// North \nBL countIfLive\nSUB R1,R1,#252// Northeast\nBL countIfLive\nADD R1,R1,#256// East\nBL countIfLive\nADD R1,R1,#256// Southeast\nBL countIfLive\nADD R1,R1,#252// South\nBL countIfLive\nSUB R1,R1,#4// Southwest\nBL countIfLive\nSUB R1,R1,#256// West\nBL countIfLive\nSUB R1,R1,#256// Northwest\nBL countIfLive\nMOV PC,R10// RET\nleftCol:// but not top or bottom\nSUB R1,R1,#256// North \nBL countIfLive\nADD R1,R1,#4// Northeast\nBL countIfLive\nADD R1,R1,#256// East\nBL countIfLive\nADD R1,R1,#256// Southeast\nBL countIfLive\nSUB R1,R1,#4// South\nBL countIfLive\nADD R1,R1,#252// Southwest\nBL countIfLive\nSUB R1,R1,#256// West\nBL countIfLive\nSUB R1,R1,#256// Northwest\nBL countIfLive\nMOV PC,R10// RET\ntopRow:\nCMP R4,#0// note R3=R4\nBEQ leftTop\nCMP R4,#252\nBEQ rightTop\n// now top but not sides\nADD R1,R1,#12032// North \nBL countIfLive\nADD R1,R1,#4// Northeast\nBL countIfLive\nSUB R1,R1,#12032// East\nBL countIfLive\nADD R1,R1,#256// Southeast\nBL countIfLive\nSUB R1,R1,#4// South\nBL countIfLive\nSUB R1,R1,#4// Southwest\nBL countIfLive\nSUB R1,R1,#256// West\nBL countIfLive\nADD R1,R1,#12032// Northwest\nBL countIfLive\nMOV PC,R10// RET\nbotRow:// removed leftBot already\nCMP R4,#252\nBEQ rightBot\nSUB R1,R1,#256// North \nBL countIfLive\nADD R1,R1,#4// Northeast\nBL countIfLive\nADD R1,R1,#256// East\nBL countIfLive\nSUB R1,R1,#12032// Southeast\nBL countIfLive\nSUB R1,R1,#4// South\nBL countIfLive\nSUB R1,R1,#4// Southwest\nBL countIfLive\nADD R1,R1,#12032// West\nBL countIfLive\nSUB R1,R1,#256// Northwest\nBL countIfLive\nMOV PC,R10// RET\n// There must be a way to improve this but I'm not short of space! \nleftTop:\nADD R1,R1,#12032// North \nBL countIfLive\nADD R1,R1,#4// Northeast\nBL countIfLive\nSUB R1,R1,#12032// East\nBL countIfLive\nADD R1,R1,#256// Southeast\nBL countIfLive\nSUB R1,R1,#4// South\nBL countIfLive\nADD R1,R1,#252// Southwest\nBL countIfLive\nSUB R1,R1,#256// West\nBL countIfLive\nADD R1,R1,#12032// Northwest\nBL countIfLive\nMOV PC,R10// RET\nrightTop:\nADD R1,R1,#12032// North \nBL countIfLive\nSUB R1,R1,#252// Northeast\nBL countIfLive\nMOV R1,#.PixelScreen// East (SUB is > 8 bits)\nBL countIfLive\nADD R1,R1,#256// Southeast\nBL countIfLive\nADD R1,R1,#252// South\nBL countIfLive\nSUB R1,R1,#4// Southwest\nBL countIfLive\nSUB R1,R1,#256// West\nBL countIfLive\nADD R1,R1,#12032// Northwest\nBL countIfLive\nMOV PC,R10// RET\nleftBot:\nSUB R1,R1,#256// North \nBL countIfLive\nADD R1,R1,#4// Northeast\nBL countIfLive\nADD R1,R1,#256// East\nBL countIfLive\nSUB R1,R1,#12032// Southeast\nBL countIfLive\nSUB R1,R1,#4// South (=#.PixelScreen)\nBL countIfLive\nADD R1,R1,#252// Southwest\nBL countIfLive\nADD R1,R1,#12032// West\nBL countIfLive\nSUB R1,R1,#256// Northwest\nBL countIfLive\nMOV PC,R10// RET\nrightBot:\nSUB R1,R1,#256// North \nBL countIfLive\nSUB R1,R1,#252// Northeast\nBL countIfLive\nADD R1,R1,#256// East\nBL countIfLive\nSUB R1,R1,#12032// Southeast (=#.PixelScreen)\nBL countIfLive\nADD R1,R1,#252// South\nBL countIfLive \nSUB R1,R1,#4// Southwest\nBL countIfLive\nADD R1,R1,#12032// West\nBL countIfLive\nSUB R1,R1,#256// Northwest\nBL countIfLive\nMOV PC,R10// RET\n// Subroutines\ncountIfLive:LDR R5,[R1]// Sub\nCMP R5,R12\nBEQ .+2\nADD R6,R6,#1\nRET\nHALT\n.ALIGN 1024\nscreen2:.DATA\n"}function programCancel(){if(!waitingForInput)return debug&&alert("Bad - Cancel when not waiting for input"),!1;waitingForInput=!1,modifyingProgram=!1,message(""==programText?"LOAD or EDIT a program":"RUN/STEP your program or LOAD/EDIT a program"),removeClass("program","edit"),resetProgramArea(programHTML),setStateReady()}function saveProgram(){1==modifyingProgram&&programSubmit2(!1),saveFile(programSave,"myprog.txt"),message("Saving File")}function iclick(){0!=(1&pinMask)&&IOVectors[1]>=0?(interruptRequest|=1,intButtonGrey()):0!=(2&pinMask)?(pinMask|=4,intButtonGrey()):debug&&alert("clicked but not enabled")}function checkClickColour(){2==(6&pinMask)?intButtonShow():1==(1&pinMask)&&IOVectors[1]>=0&&0==(3&IOVectors[1])&&IOVectors[1]<maxUsableMem?0!=(1&interruptMask)?intButtonShow():intButtonSetup():IOVectors[1]>=0||0!=(2&pinMask)?(intButtonSetup(),intButtonGrey()):intButtonReset()}function testKeyInterrupt(){1==(1&keyboardMask)&&IOVectors[2]>=0&&0==(3&IOVectors[2])&&IOVectors[2]<maxUsableMem&&(interruptRequest|=2)}function checkClockEnabled(){0==xTime&&0!=clockIntFreq&&0!=(1&interruptMask)&&IOVectors[3]>=0&&0==(3&IOVectors[3])&&IOVectors[3]<maxUsableMem&&(xTime=Date.now()+clockIntFreq)}function clearMem(){reset2(),overlay=0,rewriteSide();for(var e=0;e<maxUsableMem;e+=4)setAddress(e,0);byteCount=0,programText="",textToHtml(),message("System Cleared")}function op2(){var e=document.getElementById("data").value;if(3==memOpt){if("bin"==e)return;removeClass("xxbody","binary"),setMemBinary(!1)}switch(e){case"sig":memOpt=0;break;case"uns":memOpt=1;break;case"bin":memOpt=3,addClass("xxbody","binary"),setMemBinary(!0);break;default:memOpt=2;break}var t=dontDisplay;dontDisplay=0,rewriteMemoryAndRegs(!1),dontDisplay=t}function rewriteMemoryAndRegs(e){updateFlags(flags);for(var t=64*overlay,a=0;a<128;++a)setAddress(4*(a+t),address[a+t]);if(!e){for(a=0;a<15;++a)updateR(a,register[a]);updatePC(pCounter)}}function read_chg(e){1==modifyingProgram&&programCancel(),reset2();var t=e.files;if(t){var a=new FileReader;a.readAsText(t[0],"utf-8"),a.onload=function(){programText=a.result,textToHtml(),assemble(),resetLoadButton()}}else message("BAD FILE SELECTION RETURN")}function read_file(e){var t=e.files;if(consoleReset(),!t)return message("BAD FILE SELECTION RETURN"),fileResult>=0&&updateR(fileResult,4294967295),fileResult=-1,void(waitingForInput=!1);var a=new FileReader;a.onload=function(){fileRead=a.result,fileResult>=0&&updateR(fileResult,fileRead.length),waitingForInput=!1,fileResult=-1},a.readAsText(t[0],"utf-8")}function do_count(e){for(var t=0,a=0;t<e.length;)"\t"==e[t]?a=a+4&1048572:++a,++t;return a}function textToHtml(){programHTML="",programEdit="",programSave="";var e=1,t=1,a=0,r="",n="",s=!1,i="",o="",d=!1,l=programText.length;"\n"!=programText[l-1]&&(programText+="\n",++l);for(var u=0;u<l;++u){var f=programText[u];if("\t"==f){if(s){for(var c=4-(3&do_count(n));c>0;)r+="&nbsp;",--c;n+="\t";continue}f=" "}if(!(f<" "&&"\n"!=f)){if(0==d){for(d=!0,m=u;m<l;++m){if("|"==programText[m]){u=m;break}if(" "!=programText[m]&&"\t"!=programText[m]&&(programText[m]<"0"||programText[m]>"9")){m=-1;break}}if(u==m)continue}if(i){if(n+=f,r+=" "==f?"&nbsp;":"&"==f?"&amp;":"<"==f?"&lt;":">"==f?"&gt;":f,"\\"==o){o="";continue}if(o=f,i==f){i="";continue}if("\n"!=f)continue;i=""}if(s||'"'!=f&&"'"!=f)if(" "==f&&u+1<l&&(" "==programText[u+1]||"\t"==programText[u+1]))s&&(r+="&nbsp;",n+=" ");else{if(0==a){if("\n"==f){d=!1;continue}if(" "==f)continue;if("/"==f||";"==f){a=11,s=!0,r+='<span class="comment">',r+=f,n+=f;continue}for(var m=1;u+m<l&&programText[u+m]>" "&&(programText[u+m],":"!=programText[u+m]);)++m;":"!=programText[u+m]&&(r+="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",n+="      ",a=5)}for(;a<5&&" "==f&&programText[u+1]>" ";)n+=" ",r+="&nbsp;",++a;if("\n"==f)programHTML+='<div id="lin'+t+'" class="selectable"><span class="line">',++t,e<10&&(programHTML+="&nbsp;",programEdit+=" "),e<100&&(programHTML+="&nbsp;",programEdit+=" "),programHTML+=e+"|</span>"+r,s&&(programHTML+="</span>"),programEdit+=e+"|",++e,programHTML+="</div>",r="",programEdit+=n+"\n",programSave+=n+"\r\n",n="",a=0,s=!1,d=!1;else{if(++a,!s&&("/"==f||";"==f)){s=!0;var p=programText[u-1];if(" "!=p&&"\t"!=p||(r=";"==r[r.length-1]?r.slice(0,-6):r.slice(0,-1),n=n.slice(0,-1)),(c=do_count(n))>=comment_align)n+=" ",r+="&nbsp;";else for(;c<comment_align;)r+="&nbsp;",n+=" ",++c;r+='<span class="comment">'}r+="&"==f?"&amp;":"<"==f?"&lt;":">"==f?"&gt;":f,n+=f}}else i=f,n+=f,r+=f}}serviceMode||resetProgramArea(programHTML)}function assemble(){if(!waitingForInput){reset2();for(var e=0;e<maxUsableMem;e+=4)setAddress(e,0);var t=[],a=programText.length;"\n"!=programText[a-1]&&(programText+="\n",++a);var r=0;byteCount=0,dotDataAddress=-1,firstDataDefn=-1;var n=0,s="",i="",o=[],d=[],l=[],u=!1,f=!1,c=!1,m=!1,p=!1,g=1;addrToLine=[],lineToByteAddress=[];for(var b=!1,v=0;v<a;++v){var y=programText[v];if("\r"!=y){if(0==b){for(b=!0,e=v;e<a;++e){if("|"==programText[e]){v=e;break}if(" "!=programText[e]&&"\t"!=programText[e]&&(programText[e]<"0"||programText[e]>"9")){e=-1;break}}if(v==e)continue}if(!u||"\n"==y)if("\t"==y&&(y=" "),p){if("\n"==y)return message("Closing quotes missing at line "+(r+g)),void showError(r+g);if("\\"==i){s+=y,i="";continue}if(i=y,y!=(s+=y)[0])continue;l[r]=s,s="",++n,p=!1}else if("/"!=y&&";"!=y){if(","==y)f=!0;else if(f){if(" "==y)continue;f=!1}if(":"!=y){if(c){if(" "==y)continue;if("\n"==y){(m||u)&&(++g,m=!1),u=!1,b=!1;continue}if("."==y&&v<a-5&&".DATA"==programText.substring(v,v+5).toUpperCase()){dotDataAddress=byteCount,u=!0,v+=4,m=!1;continue}c=!1,m=!1}if(" "==y||"\n"==y){if(".DATA"==s.toUpperCase()){if(-1!=dotDataAddress)return message("cannot have more than one .data"),void showError(r+g);dotDataAddress=byteCount,s="","\n"==y?(++g,b=!1):u=!0;continue}""!=s&&(0==n&&(o[r]=0,++n),1==n&&(instruction(s.toUpperCase())<200?d[r]=s.toUpperCase():(d[r]=".WORD",++n)),2==n?l[r]=s:n>2&&(l[r]+=s),s="",++n)}if(2!=n||""!=s||'"'!=y&&"'"!=y){if("\n"==y){if(n>0){1==n&&(d[r]=0),n<3&&(l[r]=0),n=0;var R=getLen(d[r],l[r],byteCount);if(-2==R)return message("bad ascii string at line "+(r+g)),void showError(r+g);if(R<-1)return message("bad .block or .align count at line "+(r+g)),void showError(r+g);R<0&&0!=(3&byteCount)&&(byteCount=4+(268435452&byteCount)),0==(3&byteCount)&&(addrToLine[byteCount/4]=r+g),t[r]=r+g,lineToByteAddress[r]=byteCount,++r,byteCount+=R>=0?R:4}else u&&++g;u=!1,b=!1}y>" "&&(s+=y)}else s=y,p=!0}else{if(0!=n)return o[r]?message("cannot have two labels at one address at line "+(r+g)):message("label must be first item at line "+(r+g)),void showError(r+g);var x=RegExp("^(r([0-9]|1[0-5])|pc|lr|sp)$"),h=x.test(s.toLowerCase());if(h)return message("cannot use a register as a label  at line "+(r+g)),void showError(r+g);if(h=(x=RegExp("^(ret|rfe|halt|hlt|svc)$")).test(s.toLowerCase()))return message("cannot use "+s+" as a label at line "+(r+g)),void showError(r+g);if(!RegExp("^[a-zA-Z_][0-9a-zA-Z_]*$").test(s))return message("bad character in label at line "+(r+g)),void showError(r+g);for(O=0;O<r&&s!=o[O];++O);if(O<r)return message("duplicate label at lines "+t[O]+" and "+(r+g)+" &nbsp;"+s),void showError(r+g);if(-1!=matchDotLabel(s))return message("invalid label at line "+(r+g)+" &nbsp;"+s),void showError(r+g);o[r]=s,c=!0,m=!0,s="",++n}}else u=!0}}if(n&&(1!=n?debug&&alert("Simulator bug - wordCount = "+n):(d[r]=".WORD",l[r]=0,t[r]=r+g-1,lineToByteAddress[r]=byteCount,++r)),byteCount>=maxUsableMem)return message("program too long - found "+Math.floor((byteCount+3)/4)+" words. Max is "+maxUsableMem),void showError(r+g);-1==dotDataAddress&&(dotDataAddress=-1==firstDataDefn?byteCount:firstDataDefn);for(var B=0,I=!1;B<r;){var C=instruction(d[B]);if(200==C){I="unknown instruction at line "+X(B,d[B]);break}var k=instKey[C],L=inst1[C];if(l[B]){if('"'==l[B][0]||"'"==l[B][0]){if(0==(4096&k)){I="syntax error at line "+X(B,d[B]);break}e=1;for(var S=0;e<l[B].length&&l[B][e]!=l[B][0];){var M=l[B].charCodeAt(e);"\\"==l[B][e]&&(++e,M="n"==l[B][e]?10:"r"==l[B][e]?13:"t"==l[B][e]?8:l[B].charCodeAt(e)),setAddressByte(lineToByteAddress[B]+S,M),++e,++S}if(l[B][e]!=l[B][0]){I="bad string at line "+X(B,d[B]);break}if(l[B].length>e+1){I="syntax error at line "+X(B,d[B]);break}29==C?setAddressByte(lineToByteAddress[B]+S,0):--S,setData(t[B],"0x"+padHex(lineToByteAddress[B],5)+"-0x"+padHex(lineToByteAddress[B]+S,5)),++B;continue}if("{"==l[B][0]){if(22!=C&&23!=C){I="syntax error at line "+X(B,d[B]);break}for(e=1;e<l[B].length;++e){if("}"==l[B][e]){l[B].length>e+1&&(I="syntax error at line "+X(B,d[B]));break}if(" "!=l[B][e]&&","!=l[B][e]){var A=2;l[B][e+2]>="0"&&l[B][e+2]<="9"&&++A;var T=regDecode(l[B].substring(e,e+A));if(e>l[B].length-A||T>15||"-"!=l[B][e+A]&&","!=l[B][e+A]&&" "!=l[B][e+A]&&"}"!=l[B][e+A]){I="syntax error at line "+X(B,d[B]);break}if("-"!=l[B][e+A])e+=A-1,L|=1<<T;else{e+=A+1,A=2,l[B][e+2]>="0"&&l[B][e+2]<="9"&&++A;var D=regDecode(l[B].substring(e,e+A));if(e>l[B].length-A||D>15||","!=l[B][e+A]&&" "!=l[B][e+A]&&"}"!=l[B][e+A]||T>D){I="syntax error at line "+X(B,d[B]);break}for(e+=A-1;T<=D;)L|=1<<T,++T}}}if(I)break}else{var w=l[B].indexOf(",",0),O=0;if(-1==w){var N=regDecode(l[B]);if(21==N){if(0==(1024&k)||isNaN(O=parseIntGen(l[B]))||O>4294967295||O<-4294967296){I="syntax error at line "+X(B,d[B]);break}if(27==C){if(O>255||O<0){I="illegal byte value at line "+X(B,"");break}setAddressByte(lineToByteAddress[B],O),setData(t[B],"0x"+padHex(lineToByteAddress[B],5)),++B;continue}if(19==C){if(O<=0||O+lineToByteAddress[B]>maxUsableMem){I="illegal .block count "+X(B,"");break}for(e=0;e<O;++e)setAddressByte(lineToByteAddress[B]+e,0);setData(t[B],"0x"+padHex(lineToByteAddress[B],5)+"-0x"+padHex(lineToByteAddress[B]+O-1,5)),++B;continue}if(35==C){++B;continue}L+=O}else{if(20!=N){I="syntax error at line "+X(B,d[B]);break}var P=l[B].substring(0,1);if(0==(128&k)||"#"==P){I="syntax error at line "+X(B,d[B]);break}if("."==P){if(-1!=(G=matchDotLabel(l[B]))&&0==L)L=2147483648&G?G:dotLabelValues[G];else if(-1!=(G=getColourVal(l[B]))&&0==L)L=G;else{if(1==l[B].length)O=0;else{P=l[B].substring(1,2);var V=l[B].substring(2,3);if(O=parseIntGen(l[B].substring(2)),"+"!=P&&"-"!=P||V<"0"||V>"9"||isNaN(O)){I="bad address offset at line "+X(B,"");break}"-"==P&&(O=-O)}if((U=(lineToByteAddress[B]>>2)+O)<0||U>=maxUsableMem/4){I="bad address offset at line "+X(B,"");break}if(0==L)L=4*U;else{var E=O-2;if(E<-8388607||E>8388607){I="bad address offset at line "+X(B,"");break}L+=16777215&E}}}else{for(O=0;O<r&&l[B]!=o[O];++O);if(O>=r){I="unknown address label at line "+X(B,"");break}if(0==L)L=lineToByteAddress[O];else{if(0!=(3&lineToByteAddress[O])){I="unaligned address at line "+X(B,d[B]);break}if((U=(lineToByteAddress[O]>>2)-(lineToByteAddress[B]>>2)-2)<-8388607||U>8388607){I="address out of range at line "+X(B,"");break}L+=16777215&U}}}}else{var F=l[B].indexOf(",",w+1);T=regDecode(l[B].substring(0,w));if("["==l[B].substring(w+1,w+2)&&(F=-1),-1==F){D=regDecode(l[B].substring(w+1));if(T>15){I="syntax error at line "+X(B,d[B]);break}if(D<16){if(0==(2&k)){I="syntax error at line "+X(B,d[B]);break}2==C&&(T*=16),L+=(T<<12)+D}else if(21==D){if(O=parseIntGen(l[B].substring(w+1)),!isNaN(O)&&O>=2147483648&&(O-=4294967296),0==(16&k)||isNaN(O)||!(O<maxUsableMem)){I="syntax error at line "+X(B,d[B]);break}if(0!=(3&O)&&(14==C||15==C)){I="Unaligned access at line "+X(B,d[B]);break}if((O-=lineToByteAddress[B]+8)>4095||O<-4095){I="range error at line "+X(B,d[B]);break}L+=O>=0?8388608+O:-O,L+=T<<12}else{if(20!=D){I="unknown problem at line "+X(B,"");break}if("#"==(P=l[B].substring(w+1,w+2))){if(0==(4&k)){I="syntax error at line "+X(B,d[B]);break}if((P=l[B].substring(w+2,w+3))>="0"&&P<="9"||"+"==P||"-"==P)if(-2==(O=checkImm(l[B].substring(w+2)))&&3==C){if(O=parseIntGen(l[B].substring(w+2)),isNaN(O)){I="syntax error at line "+X(B,d[B]);break}if(O>2147483648&&(O-=4294967296),O<0&&O>=-65535)L=3810525184+(T<<12)+(4095&(O=-O))+(O<<4&983040);else if(O>=0&&O<=65535)L=3808428032+(T<<12)+(4095&O)+(O<<4&983040);else{if(O<-33554432||O>33554431||T>=13&&O<0){I="immediate out of range at line "+X(B,d[B]);break}L=201326592+(T<<28)+(67108863&O)}}else{if(O<0){I="syntax error at line "+X(B,d[B]);break}2==C&&(T*=16),L+=(T<<12)+O+33554432}else{var U;if("."==(c=l[B].substring(w+2)).substring(0,1)){if(-1!=(G=matchDotLabel(c)))U=2147483648&G?G:dotLabelValues[G];else if(-1==(U=getColourVal(c))){I="unknown dot label at line "+X(B,"");break}}else{for(O=0;O<r&&c!=o[O];++O);if(O>=r||0==(4&k)){I="unknown address label at line "+X(B,"");break}U=lineToByteAddress[O]}if(-2==(O=checkImm(""+U))&&3==C)if(U>2147483648&&(U-=4294967296),U<0&&U>=-65535)L=3810525184+(T<<12)+(4095&(U=-U))+(U<<4&983040);else if(U>=0&&U<=65535)L=3808428032+(T<<12)+(4095&U)+(U<<4&983040);else{if(U<-33554432||U>33554431||T>=13&&U<0){I="too many bits in address at line "+X(B,d[B]);break}L=201326592+(T<<28)+(67108863&U)}else{if(O<0){I="too many bits in address at line "+X(B,d[B]);break}2==C&&(T*=16),L+=(T<<12)+O+33554432}}}else if("["==P){var H=l[B].indexOf("]",w+1),W=l[B].indexOf("+",w+1),K=l[B].indexOf("-",w+1);if(-1==H||0==(512&k)||-1!=W&&-1!=K||l[B].length>H+1){I="syntax error at line "+X(B,d[B]);break}var q=1;-1!=K&&(W=K,q=-1);var z=l[B].indexOf(",",w+1);if(-1!=z&&(-1==W||z<W)&&(W=z),-1!=W&&W>H&&(W=-1),-1==W)D=regDecode(l[B].substring(w+2,H)),O=0;else if(D=regDecode(l[B].substring(w+2,W)),"#"==(P=l[B].substring(W+1,W+2))?(++W,"+"!=(P=l[B].substring(W+1,W+2))&&"-"!=P||(++W,P=l[B].substring(W+1,W+2))):"-"==P&&++W,21==(j=regDecode(l[B].substring(W+1,H)))){if(O=parseIntGen(l[B].substring(W+1,H)),isNaN(O)||O<0||O>4095){I="syntax error at line "+X(B,d[B]);break}}else if(20==j){if(-1!=(G=matchDotLabel(c=l[B].substring(W+1,H))))O=2147483648&G?G:dotLabelValues[G];else{for(O=0;O<r&&c!=o[O];++O);if(O>=r){I="unknown address label at line "+X(B,"");break}O=lineToByteAddress[O]}if(-1==q){I="cannot subtract a label at line "+X(B,"");break}if(O>4294963200&&(q=-1,O=4294967296-O),isNaN(O)||O<0||O>4095){I="label out of range at line "+X(B,d[B]);break}}else{if(j>15||j<0){I="unknown 2nd indirect register at line "+X(B,"");break}O=j,L+=33554432}if(D>15){I="unknown indirect register at line "+X(B,"");break}if(O>4095||O<0){I="problem with offset calculation at line "+X(B,"");break}L=(4293918720&L)+(D<<16)+(T<<12)+O,q>0&&(L+=8388608)}else{var G;P=l[B].substring(w+1,w+2);if(0==(16&k)||"#"==P){I="syntax error at line "+X(B,d[B]);break}if(-1!=(G=matchDotLabel(c=l[B].substring(w+1)))){if(2147483648&G){if(O=G,14!=C&&15!=C){I="bad I/O address for operation at line "+X(B,"");break}}else{O=dotLabelValues[G];var _=dotLabelMode[G];if(14==C?_&=4:15==C?_&=1:25==C?_&=8:26==C?_&=2:_=0,0==_){I="bad I/O address for operation at line "+X(B,"");break}}O>2147483648&&(O-=4294967296)}else{for(O=0;O<r&&c!=o[O];++O);if(O>=r){I="unknown address label at line "+X(B,"");break}if(O=lineToByteAddress[O],isNaN(O)||O<0||O>=maxUsableMem){I="label out of range at line "+X(B,d[B]);break}}if(0==(4194304&L)&&0!=(3&O)){I="label not word aligned at line "+X(B,d[B]);break}if((O-=lineToByteAddress[B]+8)<-4095||O>4095){I="label out of range at line "+X(B,d[B]);break}L+=O>=0?8388608+O:-O,L+=T<<12}}}else{D=regDecode(l[B].substring(w+1,F));var j=regDecode(l[B].substring(F+1));if(D>15){I="2nd parameter not a valid register at line "+X(B,"");break}if(j<16){if(0==(256&k)){I="syntax error at line "+X(B,d[B]);break}L+=T<<12,L+=27262976==(266338304&L)?16+(j<<8)+D:(D<<16)+j}else{if(20!=j||"#"!=l[B].substring(F+1,F+2)){I="syntax error at line "+X(B,d[B]);break}if(0==(2056&k)){I="syntax error at line "+X(B,d[B]);break}if((P=l[B].substring(F+2,F+3))>="0"&&P<="9")O=checkImm(l[B].substring(F+2));else{for(O=0;O<r&&l[B].substring(F+2)!=o[O];++O);if(O>=r){I="unknown address label at line "+X(B,"");break}if(-1==(O=checkImm(""+lineToByteAddress[O]))){I="too many bits in address at line "+X(B,d[B]);break}}if(-1==O){I="syntax error at line "+X(B,d[B]);break}if(0==(8&k))if(0==(96&L)||96==(96&L)){if(0==O||O>31){I="immediate must be 1-31 at line "+X(B,d[B]);break}}else{if(0==O||O>32){I="immediate must be 1-32 at line "+X(B,d[B]);break}32==O&&(O=0)}if(O<0){I="immediate more than 8 bits at line "+X(B,d[B]);break}L+=T<<12,L+=27262976==(266338304&L)?(O<<7)+D:(D<<16)+O+33554432}}}}}else if(0==(1&k)){I="parameters needed at line "+X(B,d[B]);break}0!=(3&lineToByteAddress[B])&&debug&&alert("issue: line "+B+" badly aligned "+lineToByteAddress[B]),setAddress(lineToByteAddress[B],L),setCode(t[B],"0x"+padHex(lineToByteAddress[B],5)),++B}if(I){var Q=Math.floor((byteCount+3)/4);for(e=0;e<=Q;++e)setAddress(4*e,0);byteCount=0,message(I),showError(t[B])}else updateR(13,maxUsableMem),message("Program assembled. Run or Step to execute")}function X(e,a){return".WORD"==a&&(a=""),""!==a&&(a=" "+a),t[e]+a}}function convert2(e){return 4*e>=byteCount?"unknown (PC=0x"+padHex(4*e,5)+")":addrToLine[e]}function regDecode(e){if("PC"==e||"pc"==e)return 15;if("SP"==e||"sp"==e)return 13;if("LR"==e||"lr"==e)return 14;var t;if(2==e.length&&("R"==e[0]||"r"==e[0])&&((t=e[1]-"0")>=0&&t<10))return t;if(3==e.length&&("R"==e[0]||"r"==e[0])&&"1"==e[1]&&((t=e[2]-"0")>=0&&t<6))return t+10;return isNaN(e)?20:21}function checkImm(e){var t=parseIntGen(e);if(isNaN(t))return-1;if(t<0&&(t+=4294967296)<0)return-2;if(0==(4294967040&t))return 255&t;for(var a=0;++a<16;){var r=t>>30&3;if(t<<=2,0==(4294967040&(t|=r)))return(255&t)+(a<<8)}return-2}function parseIntGen(e){var t=1,a=10;if(0==e.length)return NaN;if("-"==e[0]?(t=-1,e=e.substring(1)):"+"==e[0]&&(e=e.substring(1)),0==e.length)return NaN;if(e[0]<"0"||e[0]>"9")return NaN;if(e.length>2&&"0"==e[0]&&(e=e.substring(1)),"b"==e[0]||"B"==e[0]?(a=2,e=e.substring(1)):"x"!=e[0]&&"X"!=e[0]||(a=16,e=e.substring(1)),0==e.length)return NaN;for(var r=0;r<e.length;){if(e[r]<"0")return NaN;if(2==a){if(e[r]>"1")return NaN}else if(10==a){if(e[r]>"9")return NaN}else if(e[r]>"9"&&e[r]<"A"||e[r]>"F"&&e[r]<"a"||e[r]>"f")return NaN;++r}return t*parseInt(e,a)}function decodeImm(e){var t=e>>8&15;for(e&=255;t>0;){var a=3&e;e=e>>2&1073741823,e|=a<<30,--t}return e}function updatePC(e){for(;e<0;)e+=4294967296;for(;e>=maxUsableMem;)e-=maxUsableMem;pCounter=e,0!=dontDisplay||serviceMode||updateRDisplay(15,e)}function updateR(e,t){if(15!=e){if(e>=0&&e<15){for(;t<0;)t+=4294967296;for(;t>4294967295;)t-=4294967296;register[e]=t,0!=dontDisplay||serviceMode||updateRDisplay(e,t)}}else updatePC(t)}var instructions=["ADD","SUB","CMP","MOV","AND","ORR","EOR","LSR","LSL","B","BEQ","BNE","BLT","BGT","LDR","STR","HALT","MVN","RFE",".BLOCK",".WORD","BL","PUSH","POP","RET","LDRB","STRB",".BYTE",".ASCII",".ASCIZ","ADDS","SUBS","BCS","BVS","BMI",".ALIGN","SVC","ASR","ROR","RRX","LSRS","LSLS","ASRS","RORS","RRXS","BIS","XOR","OR","JMS","HLT","ASL","ASLS"],instKey=[264,264,6,6,264,264,264,2304,2304,128,128,128,128,128,528,528,1,6,1,1024,1153,128,64,64,1,528,528,1024,4096,4096,264,264,128,128,128,1024,1025,2304,2304,2,2304,2304,2304,2304,2],inst1=[3766484992,3762290688,3780116480,3785359360,3758096384,3783262208,3759144960,3785359392,3785359360,3925868544,167772160,436207616,3120562176,3388997632,3844014080,3842965504,3774873712,3789553664,4173138432,0,0,3942645760,3912040448,3904700416,3785420814,3848208384,3847159808,0,0,0,3767533568,3763339264,704643072,1778384896,1241513984,0,4009754624,3785359424,3785359456,3785359456,3786407968,3786407936,3786408e3,3786408032,3786408032];function instruction(e){for(var t=0;t<52&&e!=instructions[t];++t);return t<45?t:45==t?5:46==t?6:47==t?5:48==t?21:49==t?16:50==t?8:51==t?41:200}function getLen(e,t,a){var r=instruction(e);if(19==r){-1==firstDataDefn&&(firstDataDefn=a);var n=parseIntGen(t);return isNaN(n)||n<=0||n+a>maxUsableMem?-3:n}if(35==r){n=parseIntGen(t);return isNaN(n)||n<=0||n>268435455?-3:(0==a%n?n=a:n+=a-a%n,n>maxUsableMem?-3:n-a)}if(r<27||r>29)return 20==r&&-1==firstDataDefn&&(firstDataDefn=a),-1;if(27==r)return-1==firstDataDefn&&(firstDataDefn=a),1;if('"'!=t[0]&&"'"!=t[0])return debug&&alert("Bad call to getLen, offset = "+t),-2;for(var s=1,i=0;s<t.length&&t[s]!=t[0];)"\\"==t[s]&&++s,++s,++i;return t[s]!=t[0]?(debug&&alert("Bad call to getLen, offset = "+t),-2):28==r?i:29==r?i+1:(debug&&alert("Bad call to getLen, inst = "+r+" i = "+s),-1)}var savOpenAddress=!1;function openAddress(e){waitingForInput||myTimeout||myMaybe||(message("Modifying memory contents"),openAddressToEdit(e),waitingForInput=!0,savOpenAddress=e,setStateEdit())}function pixelInt(e){if("p"==e.id[0]){if(0!=(1&pixelMask)&&IOVectors[4]>=0)interruptRequest|=4;else{if(0==(2&pixelMask))return lastPixelClick=parseInt(e.id.substring(1)),void(debug&&alert("Pixel click when not enabled "+lastPixelClick));pixelMask|=4}lastPixelClick=parseInt(e.id.substring(1))}else debug&&alert("Bad pixel click decode")}function checkInput(e){if(!waitingForInput)return!1;if(3==memOpt&&(e=e.replace(" ","")),""==e)return!1;var t=parseIntGen(e);return!(isNaN(t)||t>4294967295||t<-2147483648)}function addressSubmit(){if(waitingForInput){var e=getAddressValue();if(""!=e){var t=parseIntGen(e);if(isNaN(t)||t>4294967295||t<-2147483648)message("Bad number format or value");else{document.getElementById("aForm").removeAttribute("onblur");var a=parseInt(savOpenAddress.id[1]);savOpenAddress.id.length>=3&&(a=10*a+parseInt(savOpenAddress.id[2])),savOpenAddress.id.length>=4&&(a=10*a+parseInt(savOpenAddress.id[3])),5==savOpenAddress.id.length&&(a=10*a+parseInt(savOpenAddress.id[4])),setAddress(4*(a+=64*overlay),t),waitingForInput=!1,setStateReady(),savOpenAddress=!1,message(""==programText?"LOAD or EDIT a program":"RUN/STEP your program or LOAD/EDIT a program")}}else message("Bad input - must be a number")}else debug&&alert("Bad input - not waiting for input")}function loseAddress(e){if(waitingForInput)if(checkInput(e.value))addressSubmit();else{resetAddressInput();var t=parseInt(savOpenAddress.id[1]);savOpenAddress.id.length>=3&&(t=10*t+parseInt(savOpenAddress.id[2])),savOpenAddress.id.length>=4&&(t=10*t+parseInt(savOpenAddress.id[3])),5==savOpenAddress.id.length&&(t=10*t+parseInt(savOpenAddress.id[4])),setAddress(4*(t+=64*overlay),address[t]),waitingForInput=!1,setStateReady(),savOpenAddress=!1,message("BAD input ignored")}}function setAddressByte(e,t){var a=255<<8*(3&e);setAddress(268435452&e,t<<8*(3&e)&a|address[Math.floor(e/4)]&(4294967295^a))}function setAddress(e,t){if(isNaN(t))debug&&alert("attempt to store NaN at "+e);else if(e<0||e>=maxUsableMem)debug&&alert("store at bad address "+e);else if(0==(3&e)){for(e/=4;t<0;)t+=4294967296;for(;t>4294967295;)t-=4294967296;if(address[e]=t,1!=dontDisplay&&!serviceMode){var a=64*overlay;e<a||(e-=a)>=128||updateDisplayedMemory(e,t)}}else debug&&alert("store at unaligned address "+e+" caller should trap this")}function step3(){oneStep=!0,speed=11,1==dontDisplay?(myMaybe&&clearTimeout(myMaybe),myMaybe=!1,dontDisplay=0,rewriteMemoryAndRegs(!1)):(myTimeout&&clearTimeout(myTimeout),myTimeout=!1),run2(),setValue("counter",""+instructionCount)}function runSlow(){myTimeout?speed=Math.floor((speed+2)/2):0!=pCounter||0!=address[0]?(oneStep=!1,speed=slowSpeed,setStateSlow(),1==dontDisplay?(myMaybe&&clearTimeout(myMaybe),myMaybe=!1,dontDisplay=0,rewriteMemoryAndRegs(!1),waitingForInput||(myTimeout=delay(speed,"runContinue"))):run2()):message("No program to run")}function runOrig(){waitingForInput||myMaybe||(myTimeout&&(clearTimeout(myTimeout),myTimeout=!1),0!=pCounter||0!=address[0]?(oneStep=!1,measureSpeed=instructionCount,setValue("counter","0"),runTimer=getMilliseconds(),speed=1,setStateRunning(),message(""),dontDisplay=1,removeCodeHighlight(),removeMemHighlight(),clearIR(),myMaybe=delay(delayTime,"maybeRunContinue"),run2()):message("No program to run"))}function run2(){waitingForInput||(stopping=!1,noKeyEffects=!0,IEKeyEnable(),runContinue())}function runContinuey(){1==dontDisplay&&(myMaybe&&clearTimeout(myMaybe),myMaybe=!1,dontDisplay=0,rewriteMemoryAndRegs(!1)),running=!1,setStatePaused(),noKeyEffects=!1,message(halted),myTimeout=!1}function runContinuez(){if(waitingForInput){if(myTimeout=delay(speed,"runContinuez"),fileResult>=20)fileResult-=20,document.getElementById("read-file").click()}else{if(lastKey=0,breakpointAddr==pCounter)return myMaybe&&alert("BUG - myMaybe"),dontDisplay&&(dontDisplay=0,rewriteMemoryAndRegs(!1),message(lastMessage),4*lineNo<byteCount&&showExecuteStop(addrToLine[lineNo]),setMemHighlight(4*lineNo),setValue("counter",""+instructionCount)),message("Breakpoint detect at PC = 0x"+padHex(pCounter,5)),running=!1,setStatePaused(),void(noKeyEffects=!1);message(stepTxt),1==speed&&0==oneStep?(message(""),dontDisplay=1,clearIR(),maybeWaiting=0,myMaybe=delay(delayTime,"maybeRunContinue"),runContinue()):myTimeout=delay(speed,"runContinue")}}function badStack(){var e=(4294967292&register[13])-4;return(e>=maxUsableMem||e<0)&&(1!=dontDisplay||serviceMode||(myMaybe&&clearTimeout(myMaybe),myMaybe=!1,dontDisplay=0,rewriteMemoryAndRegs(!1)),message("Bad SP value on interrupt"),running=!1,setStatePaused(),noKeyEffects=!1,!0)}function doClockInt(){if(xTime=0,!(0==clockIntFreq||IOVectors[3]<0||0!=(3&IOVectors[3])||IOVectors[3]>=maxUsableMem)){interruptMask&=4294967294;var e=(4294967292&register[13])-4;setAddress(e,flags<<28|1),setAddress(e-=4,pCounter),updateR(13,e),updatePC(IOVectors[3]),message("Accepted interrupt from the timer")}}function doInterrupt(){if(!0&++interruptCnt||0==xTime||xTime>=Date.now()){var e=(4294967292&register[13])-4;if(0!=(1&interruptRequest)&&0!=(1&pinMask)&&IOVectors[1]>=0&&0==(3&IOVectors[1])&&IOVectors[1]<maxUsableMem)return interruptMask&=4294967294,interruptRequest&=4294967294,setAddress(e,flags<<28|1),setAddress(e-=4,pCounter),updateR(13,e),updatePC(IOVectors[1]),void message("Accepted interrupt from the push button");if(0!=(2&interruptRequest)&&0!=(1&keyboardMask)&&IOVectors[2]>=0&&0==(3&IOVectors[2])&&IOVectors[2]<maxUsableMem)return interruptMask&=4294967294,interruptRequest&=4294967293,setAddress(e,flags<<28|1),setAddress(e-=4,pCounter),updateR(13,e),updatePC(IOVectors[2]),void message("Accepted interrupt from the keyboard");if(0!=(4&interruptRequest)&&0!=(1&pixelMask)&&IOVectors[4]>=0&&0==(3&IOVectors[4])&&IOVectors[4]<maxUsableMem)return interruptMask&=4294967294,interruptRequest&=4294967291,setAddress(e,flags<<28|1),setAddress(e-=4,pCounter),updateR(13,e),updatePC(IOVectors[4]),void message("Accepted interrupt from the pixel click")}!serviceMode&&xTime&&xTime<Date.now()&&doClockInt()}var myMaybe=0,maybeWaiting=0;function maybeRunContinue(){0==myMaybe&&debug&&alert("myMaybe == 0 should not happen"),0!=maybeWaiting?(maybeWaiting=0,myMaybe=delay(delayTime,"maybeRunContinue"),runContinue()):myMaybe=0}var DC=[4e3,750,750,300,100,40,20,10,5,2,1];function runContinue(){if(myTimeout=!1,stopping){if(1==dontDisplay){myMaybe&&clearTimeout(myMaybe),myMaybe=!1,dontDisplay=0,rewriteMemoryAndRegs(!1),4*lineNo<byteCount&&showExecuteStop(addrToLine[lineNo]),setMemHighlight(4*lineNo),setValue("counter",""+instructionCount),measureSpeed=instructionCount-measureSpeed,runTimer=getMilliseconds()-runTimer;var e=Math.floor(measureSpeed/runTimer/10),t=Math.floor(runTimer/100);2!=step1Code&&message("Program paused. "+measureSpeed+" ins in "+t/10+" secs, "+e/100+"M ins/sec")}else oneStep?2!=step1Code&&message(stepTxt):2!=step1Code&&message("Program paused. RUN or STEP to continue, STOP to abort.");return running=!1,setStatePaused(),void(noKeyEffects=!1)}if(oneStep&&(stopping=!0),0!=(1&interruptMask)&&(0!=interruptRequest||xTime&&xTime<Date.now())){if(badStack())return;doInterrupt()}if(step1Code=0,0==dontDisplay){var a=Math.floor(pCounter/4);return 4*a<byteCount&&showExecuteStop(addrToLine[a]),setMemHighlight(pCounter),step1(1)||breakpointAddr==pCounter?(setValue("counter",""+instructionCount),waitingForInput?void(myTimeout=delay(speed,"runContinuez")):(breakpointAddr==pCounter&&message("Breakpoint detect at PC = 0x"+padHex(pCounter,5)),running=!1,setStatePaused(),void(noKeyEffects=!1))):(message(stepTxt),setValue("counter",""+instructionCount),void(myTimeout=delay(4*(speed-10),"runContinue")))}if(step1(751)){if(breakpointAddr==pCounter&&5==step1Code&&(step1Code=2),step1Code<3)return myMaybe&&clearTimeout(myMaybe),myMaybe=!1,dontDisplay=0,rewriteMemoryAndRegs(!1),message(lastMessage),2==step1Code&&message("Stopped on Breakpoint at PC = 0x"+padHex(pCounter,5)),4*lineNo<byteCount&&showExecuteStop(addrToLine[lineNo]),setMemHighlight(4*lineNo),setValue("counter",""+instructionCount),running=!1,setStatePaused(),void(noKeyEffects=!1);if(waitingForInput)return myMaybe&&clearTimeout(myMaybe),myMaybe=!1,dontDisplay=0,rewriteMemoryAndRegs(!1),message(lastMessage),setValue("counter",""+instructionCount),void(myTimeout=delay(speed,"runContinuez"))}maybeWaiting=1,0==myMaybe&&debug&&alert("myMaybe == 0 - interlock went wrong"),setValue("counter",""+instructionCount),1!=speed&&(dontDisplay=0,rewriteMemoryAndRegs(!1),dontDisplay=1)}function stop(){stopping=!0}function stop2(){myMaybe&&clearTimeout(myMaybe),myMaybe=!1,myTimeout&&clearTimeout(myTimeout),myTimeout=!1,running=!1,noKeyEffects=!1,fileResult=-1,consoleReset(),removeCodeHighlight(),removeMemHighlight(),removeError()}function reset1(){reset2(),message("Stop done, edit &amp; Submit, RUN/STEP or alter memory")}function reset2(){if(dontDisplay=0,stop2(),reset3(),savOpenAddress){var e=parseInt(savOpenAddress.id[1]);savOpenAddress.id.length>=3&&(e=10*e+parseInt(savOpenAddress.id[2])),savOpenAddress.id.length>=4&&(e=10*e+parseInt(savOpenAddress.id[3])),5==savOpenAddress.id.length&&(e=10*e+parseInt(savOpenAddress.id[4])),setAddress(4*(e+=64*overlay),address[e]),waitingForInput=!1,savOpenAddress=!1}modifyingProgram&&(modifyingProgram=!1,textToHtml(),waitingForInput=!1,removeClass("program","edit")),setValue("counter","0"),rewriteMemoryAndRegs(!1),intButtonReset()}function reset3(){updateR(0,0),updateR(1,0),updateR(2,0),updateR(3,0),updateR(4,0),updateR(5,0),updateR(6,0),updateR(7,0),updateR(8,0),updateR(9,0),updateR(10,0),updateR(11,0),updateR(12,0),updateR(13,maxUsableMem),updateR(14,0),updatePC(0),updateFlags(0),output1="",clearIR(),lastKey=0,waitingForInput&&(waitingForInput=!1),clearInputArea(),interruptRequest=0,interruptMask=0,keyboardMask=0,pinMask=0,clockIntFreq=0,pixelMask=0,IOVectors[0]=-1,IOVectors[1]=-1,IOVectors[2]=-1,IOVectors[3]=-1,IOVectors[4]=-1,pixelAreaSize=3072,clearPixelArea(),lastPixelClick=-1,instructionCount=0,setStateReady()}function clearPixelArea(){setPixelAreaSize(pixelAreaSize);for(var e=pixelAreaSize,t=0;t<e;++t)v1address[t]=16777215;e=charMax/4;for(t=0;t<e;)v2address[t]=0,++t;for(clearCharMap(),e=(IOBase-charBase)/4;t<e;)v2address[t]=16777215,++t}var startFm=[0,6,0,13,40,19,40,23,27,29,30,38,40,40,40,39],newIValue=[3766484992,3762290688,3758096384,3759144960,3767533568,3763339264,3785359360,3785359392,3785359360,3785359424,3785359456,3785359456,3774873712,3783262208,3785359360,3789553664,3780116480,3810525184,3808428032,3843031040,3841982464,3847225344,3846176768,3876585472,3875536896,3880779776,3879731200,3904700416,4173138432,3912040448,3925868544,167772160,436207616,3120562176,3388997632,704643072,1778384896,1241513984,3942645760,4009754624,201326592,0],newIMask=[4260364288,4260364288,4260364288,4260364288,4260364288,4260364288,4294905840,4293853280,4293853280,4293853280,4293857264,4293853280,4294967295,4260364288,4261347328,4261347328,4260425728,4293918720,4293918720,4285530112,4285530112,4285530112,4285530112,4285530112,4285530112,4285530112,4285530112,4294901760,4294967295,4294901760,4278190080,4278190080,4278190080,4278190080,4278190080,4278190080,4278190080,4278190080,4278190080,4278190080,201326592,0],newINmame=["ADD","SUB","AND","EOR","ADDS","SUBS","MOV","LSR","LSL","ASR","RRX","ROR","HALT","ORR","MOV","MVN","CMP","MOV","MOV","LDR","STR","LDRB","STRB","LDR","STR","LDRB","STRB","POP","RFE","PUSH","B","BEQ","BNE","BLT","BGT","BCS","BVS","BMI","BL","SVC","MOV","ILLEGAL"],newIDecode=[7,7,7,7,7,7,3,5,5,5,5,5,0,7,3,3,4,8,8,2,2,2,2,1,1,1,1,9,0,9,6,6,6,6,6,6,6,6,6,0,10,0];function step1(e){var t,a,r,n,s,i,o,d,l,u,f,c,m="";if(waitingForInput)return 0;setStateForceRunning();for(var p=0;p<e;++p){for(var g=0;g<201;++g){for(lineNo=Math.floor(pCounter/4),inst=address[lineNo],0==dontDisplay?(setIR(padHex(inst,8)),updatePC(pCounter+4)):(pCounter+=4)>=maxUsableMem&&(pCounter=0),++instructionCount,t=startFm[inst>>24&15];t<41&&(inst&newIMask[t])!=(4294967295&newIValue[t]);++t);switch(a=newINmame[t],r="",n=100,s=100,i=NaN,L=1e4,newIDecode[t]){case 0:break;default:debug&&alert("step1() fault on decode "+newIDecode[t]+" "+t),m="emulator fault";case 1:n=inst>>12&15,L=(s=inst>>16&15)<15?register[s]:pCounter+4;var b=15&inst;b=b<15?register[b]:pCounter+4,0!=(8388608&inst)?(L+=b,r="&nbsp;Rd,[Rn+Rm]"):(L-=b,r="&nbsp;Rd,[Rn-Rm]"),L>2147483648&&(L-=4294967296),(L<vaddressBase-4294967296||L>=maxUsableMem)&&(m="bad address");break;case 2:L=4095&inst,n=inst>>12&15,15==(s=inst>>16&15)?(r=" Rd,addr",0!=(8388608&inst)?L+=4+(268435452&pCounter):L=4+(268435452&pCounter)-L):(r="&nbsp;Rd,[Rn+nn]",0!=(8388608&inst)?L+=register[s]:L=register[s]-L),L>2147483648&&(L-=4294967296),(L<vaddressBase-4294967296||L>=maxUsableMem)&&(m="bad address");break;case 3:n=inst>>12&15,0!=(33554432&inst)?(r=" Rd,#im",i=decodeImm(4095&inst)):(r=" Rd,Rm",i=(15&inst)<15?register[15&inst]:pCounter+4);break;case 4:s=inst>>16&15,0!=(33554432&inst)?(r=" Rn,#im",i=decodeImm(4095&inst)):(r=" Rn,Rm",i=(15&inst)<15?register[15&inst]:pCounter+4);break;case 5:n=inst>>12&15,s=15&inst,0!=(1048576&inst)&&(a+="S"),0!=(16&inst)?(r=" Rd,Rn,Rm",i=(inst>>8&15)<15?register[inst>>8&15]:pCounter+4,(i&=255)>32&&(i=32)):(r=" Rd,Rn,#im",0==(i=inst>>7&31)&&(0!=(96&inst)&&(i=32),96==(96&inst)&&(r=" Rd,Rn")));break;case 6:r=" addr",0!=(8388608&(L=16777215&inst))&&(L-=16777216),((L=4*L+pCounter+4)<0||L>maxUsableMem)&&(m="bad address");break;case 7:n=inst>>12&15,s=inst>>16&15,0!=(33554432&inst)?(r=" Rd,Rn,#im",i=decodeImm(4095&inst)):(r=" Rd,Rn,Rm",i=(15&inst)<15?register[15&inst]:pCounter+4);break;case 8:n=inst>>12&15,r=" Rd,#im",i=(4095&inst)+(inst>>4&61440);break;case 9:n=inst>>16&15,i=65535&inst,r=" {regs}";break;case 10:r=" Rd,#im",i=67108863&inst,0!=(33554432&inst)&&(i|=4227858432),(n=inst>>28&15)>=13&&(0!=(3&i)||i<0||i>maxUsableMem)&&(m="bad address");break}if(0==dontDisplay&&addIR(a+r),""!=m)return message("Error: "+m+" at line "+convert2(lineNo)),1;switch(t){case 38:updateR(14,pCounter);case 30:updatePC(L);break;case 31:0!=(4&flags)?updatePC(L):r+=" Branch not taken";break;case 32:0==(4&flags)?updatePC(L):r+=" Branch not taken";break;case 33:8==(9&flags)||1==(9&flags)?updatePC(L):r+=" Branch not taken";break;case 34:0!=(4&flags)||9!=(9&flags)&&0!=(9&flags)?r+=" Branch not taken":updatePC(L);break;case 7:o=s<15?register[s]:pCounter+4,i>0?(d=o>>1&2147483647,i>1&&(d>>=i-1)):d=o,updateR(n,d),0!=(1048576&inst)&&(l=1&flags,0==i?l+=2&flags:0!=(o&1<<i-1)&&(l+=2),0==(4294967295&d)&&(l|=4),0!=(2147483648&d)&&(l|=8),updateFlags(l));break;case 8:o=s<15?register[s]:pCounter+4,updateR(n,d=i>31?0:o<<i),0!=(1048576&inst)&&(l=1&flags,0==i?l+=2&flags:0!=(o<<i-1&2147483648)&&(l+=2),0==(4294967295&d)&&(l|=4),0!=(2147483648&d)&&(l|=8),updateFlags(l));break;case 9:o=s<15?register[s]:pCounter+4,updateR(n,d=i>31?o>>31:o>>i),0!=(1048576&inst)&&(l=1&flags,0==i?l+=2&flags:0!=(o&1<<i-1)&&(l+=2),0==(4294967295&d)&&(l|=4),0!=(2147483648&d)&&(l|=8),updateFlags(l));break;case 10:d=(o=s<15?register[s]:pCounter+4)>>1&2147483647,0!=(2&flags)&&(d+=2147483648),updateR(n,d),0!=(1048576&inst)&&(l=1&flags,0!=(1&o)&&(l+=2),0==(4294967295&d)&&(l|=4),0!=(2147483648&d)&&(l|=8),updateFlags(l));break;case 11:for(o=s<15?register[s]:pCounter+4,d=i;i>31;)i-=32;for(;i>0;)o=0==(1&o)?o>>1&2147483647:2147483648+(o>>1&2147483647),--i;updateR(n,o),0!=(1048576&inst)&&(l=1&flags,0==d?l+=2&flags:0!=(2147483648&o)&&(l+=2),0==(4294967295&o)&&(l|=4),0!=(2147483648&o)&&(l|=8),updateFlags(l));break;case 12:return step1Code=1,message(halted),1;break;case 28:if((L=4294967292&register[13])>=maxUsableMem-4||L<0)return message("Bad SP value at line = "+convert2(lineNo)),1;if((d=address[L/4])>=maxUsableMem||d<0)return message("Bad return address at line = "+convert2(lineNo)),1;updatePC(d),updateFlags((d=address[(L+=4)/4])>>28&15),0!=(1&d)&&(interruptMask|=1),updateR(13,L+4),checkClickColour(),checkClockEnabled(),dontDisplay&&0!=(1&interruptMask)&&(0!=interruptRequest||xTime&&xTime<Date.now())&&doInterrupt();break;case 6:case 14:case 18:case 40:if(updateR(n,i),dontDisplay&&3785359360==inst)return step1Code=5,1;break;case 17:updateR(n,4294967296-i);break;case 15:updateR(n,4294967295^i);break;case 16:l=0,0==(4294967295&(o=(s<15?register[s]:pCounter+4)-i))&&(l|=4),0!=(u=o>>31&1)&&(l|=8),c=-i>>31&1,0==(f=(s<15?register[s]:pCounter+4)>>31&1)?1==c&&0==u&&(l|=2):1!=c&&0!=u||(l|=2),f+c!=1&&f!=u&&(l|=1),updateFlags(l);break;case 23:case 19:if(0!=(3&L))return message("Unaligned access on LDR at line "+convert2(lineNo)),1;if(L<0)if((L+=4294967296)<pixelBase+4*pixelAreaSize&&L>=pixelBase)updateR(n,v1address[(L-pixelBase)/4]);else if(L<IOBase&&L>=charBase)updateR(n,v2address[(L-charBase)/4]);else{if(L==dotLabelValues[5])return inputNum(n,0),step1Code=4,stepTxt="Done instruction "+a+r+" at line "+convert2(lineNo),1;if(L==dotLabelValues[26])return inputNum(n,1),step1Code=4,stepTxt="Done instruction "+a+r+" at line "+convert2(lineNo),1;if(L==dotLabelValues[6])updateR(n,lastKey);else if(L==dotLabelValues[7])updateR(n,lastKey),lastKey=0;else if(L==dotLabelValues[34])updateR(n,lastPixelClick);else if(L==dotLabelValues[35])updateR(n,lastPixelClick),pixelMask&=4294967291,lastPixelClick=-1;else if(L==dotLabelValues[8])updateR(n,4294967296*Math.random()&4294967295);else if(L==dotLabelValues[9])updateR(n,instructionCount);else if(L==dotLabelValues[10])updateR(n,Math.floor(Date.now()/1e3)-946684800);else if(L==dotLabelValues[11])updateR(n,IOVectors[1]);else if(L==dotLabelValues[12])updateR(n,IOVectors[0]);else if(L==dotLabelValues[13])updateR(n,IOVectors[2]);else if(L==dotLabelValues[14])updateR(n,IOVectors[3]);else if(L==dotLabelValues[33])updateR(n,IOVectors[4]);else if(L==dotLabelValues[15])updateR(n,interruptMask);else if(L==dotLabelValues[16])updateR(n,pinMask);else if(L==dotLabelValues[17])updateR(n,keyboardMask);else if(L==dotLabelValues[18])updateR(n,clockIntFreq);else if(L==dotLabelValues[36])updateR(n,pixelMask);else if(L==dotLabelValues[37])updateR(n,12288==pixelAreaSize?2:3072==pixelAreaSize?1:0);else if(L==dotLabelValues[19])updateR(n,byteCount);else{if(L==dotLabelValues[22])return fileRead="",fileResult=n,fileOpen(),waitingForInput=!0,inst=0,step1Code=4,stepTxt="Done instruction "+a+r+" at line "+convert2(lineNo),1;if(L==dotLabelValues[23])updateR(n,fileRead?fileRead.length:0);else if(L==dotLabelValues[24])fileRead?(updateR(n,fileRead.charCodeAt(0)),fileRead=fileRead.substr(1)):updateR(n,4294967295);else{if(L!=dotLabelValues[28])return message("Bad I/O address for LDR at line "+convert2(lineNo)),1;updateR(n,pixelAreaSize)}}}else updateR(n,address[L/4]);break;case 24:case 20:if(0!=(3&L))return message("Unaligned access on STR at line "+convert2(lineNo)),1;if(L>=0&&L<dotDataAddress)return message("Attempt to STR into the code area at line "+convert2(lineNo)),1;if(o=n<15?register[n]:pCounter+4,L<0)if((L+=4294967296)<IOBase&&L>=vaddressBase){var v=(L-vaddressBase)/4;if(v<pixelAreaSize){if(v1address[v]==o)break;v1address[v]=o,serviceMode||videoWrite(v,o)}else if(v=(L-charBase)/4,L>charBase&&v<charMax/4){if(v2address[v]==o)break;v2address[v]=o,showChar(L-=charBase,255&o),showChar(L+1,o>>8&255),showChar(L+2,o>>16&255),showChar(L+3,o>>24&255)}else{if(!(L>=fakeBig))return message("Bad I/O address for STR at line "+convert2(lineNo)),1;v2address[v]=o,v=(L-fakeBig)/2;var y=!0;if(3072==pixelAreaSize?(y=videoProc(y,v+=16777152&v,o),y=videoProc(y,++v,o),y=videoProc(y,v+=63,o),y=videoProc(y,++v,o)):(v*=2,y=videoProc(y,v+=3*(268435328&v),o),y=videoProc(y,++v,o),y=videoProc(y,++v,o),y=videoProc(y,++v,o),y=videoProc(y,v+=125,o),y=videoProc(y,++v,o),y=videoProc(y,++v,o),y=videoProc(y,++v,o),y=videoProc(y,v+=125,o),y=videoProc(y,++v,o),y=videoProc(y,++v,o),y=videoProc(y,++v,o),y=videoProc(y,v+=125,o),y=videoProc(y,++v,o),y=videoProc(y,++v,o),y=videoProc(y,++v,o)),y)break}g=1e3}else if(L==dotLabelValues[0])outputNum(o,4),g=1e3;else if(L==dotLabelValues[1])outputNum(o,5),g=1e3;else if(L==dotLabelValues[2])outputNum(o,6),g=1e3;else if(L==dotLabelValues[3])outputNum(o,7),g=1e3;else if(L==dotLabelValues[4])outputNum(o,8),g=1e3;else{if(L==dotLabelValues[25]||L==dotLabelValues[32])return n>14||o<0||o>maxUsableMem-128?(message("Bad address for .ReadString at line "+convert2(lineNo)),1):o<dotDataAddress?(message("Attempt to .ReadString into the code area at line "+convert2(lineNo)),1):(L==dotLabelValues[25]?inputNum(n,-1):inputNum(n,-2),step1Code=4,stepTxt="Done instruction "+a+r+" at line "+convert2(lineNo),1);if(L==dotLabelValues[27])outputNum(o,3),g=1e3;else if(L==dotLabelValues[15]){if(interruptMask=o,checkClickColour(),checkClockEnabled(),dontDisplay&&0!=(1&interruptMask)&&(0!=interruptRequest||xTime&&xTime<Date.now()))return step1Code=3,1}else if(L==dotLabelValues[16])pinMask=o,checkClickColour();else if(L==dotLabelValues[17])keyboardMask=o;else if(L==dotLabelValues[18])clockIntFreq=o,checkClockEnabled();else if(L==dotLabelValues[36]){var R=!1;(0==(3&pixelMask)&&0!=(3&o)||0!=(3&pixelMask)&&0==(3&o))&&(R=!0),pixelMask=o,R&&clearPixelArea()}else if(L==dotLabelValues[37])pixelAreaSize=2==o?12288:3072,v1address=[],clearPixelArea();else if(L==dotLabelValues[28])clearPixelArea();else if(L==dotLabelValues[29])fileWriteBuffer+=String.fromCharCode(255&o),fileWriteBuffer+=String.fromCharCode(o>>8&255),fileWriteBuffer+=String.fromCharCode(o>>16&255),fileWriteBuffer+=String.fromCharCode(o>>24&255);else if(L==dotLabelValues[30]){if(-1!=o){if(o<0||o>=maxUsableMem)return message("Bad I/O data or address for STR at line "+convert2(lineNo)),1;for(var x="",h=0;h<64;++h){var B=address[Math.floor(o/4)]>>8*(3&o)&255;if(B<32||B>127)break;if(x+=String.fromCharCode(B),++o>=maxUsableMem)break}return saveFile(fileWriteBuffer,x),fileWriteBuffer=[],stepTxt="Done instruction "+a+r+" at line "+convert2(lineNo),0;return step1Code=4,stepTxt="Writing File",message("Saving File"),1}fileWriteBuffer=[]}else{if(o<0||o>=maxUsableMem||0!=(3&o))return message("Bad I/O data or address for STR at line "+convert2(lineNo)),1;if(L==dotLabelValues[11])IOVectors[1]=o,checkClickColour();else if(L==dotLabelValues[12])IOVectors[0]=o;else if(L==dotLabelValues[13])IOVectors[2]=o;else if(L==dotLabelValues[14])IOVectors[3]=o,checkClockEnabled();else{if(L!=dotLabelValues[33])return message("Bad I/O address for STR at line "+convert2(lineNo)),1;IOVectors[4]=o}}}else setAddress(L,o);break;case 0:updateR(n,(s<15?register[s]:pCounter+4)+i);break;case 1:updateR(n,(s<15?register[s]:pCounter+4)-i);break;case 4:l=0,0==(4294967295&(o=(s<15?register[s]:pCounter+4)+i))&&(l|=4),0!=(u=o>>31&1)&&(l|=8),c=i>>31&1,0==(f=(s<15?register[s]:pCounter+4)>>31&1)?1==c&&0==u&&(l|=2):1!=c&&0!=u||(l|=2),f+c!=1&&f!=u&&(l|=1),updateFlags(l),updateR(n,o);break;case 5:l=0,0==(4294967295&(o=(s<15?register[s]:pCounter+4)-i))&&(l|=4),0!=(u=o>>31&1)&&(l|=8),c=-i>>31&1,0==(f=(s<15?register[s]:pCounter+4)>>31&1)?1==c&&0==u&&(l|=2):1!=c&&0!=u||(l|=2),f+c!=1&&f!=u&&(l|=1),updateFlags(l),updateR(n,o);break;case 35:0!=(2&flags)?updatePC(L):r+=" Branch not taken";break;case 36:0!=(1&flags)?updatePC(L):r+=" Branch not taken";break;case 37:0!=(8&flags)?updatePC(L):r+=" Branch not taken";break;case 2:updateR(n,(s<15?register[s]:pCounter+4)&i);break;case 13:updateR(n,(s<15?register[s]:pCounter+4)|i);break;case 3:updateR(n,(s<15?register[s]:pCounter+4)^i);break;case 29:for(L=4294967292&register[n],s=15;s>=0;){if(i&1<<s){if(L>maxUsableMem||L<4)return message("Bad SP value at line = "+convert2(lineNo)),1;if((L-=4)<byteCount)return message("Stack overflow error at line = "+convert2(lineNo)),1;setAddress(L,15==s?pCounter+4:register[s])}--s}updateR(n,L);break;case 27:for(L=4294967292&register[n],s=0;s<16;){if(i&1<<s){if(L>=maxUsableMem||L<0)return message("Bad SP value at line = "+convert2(lineNo)),1;updateR(s,address[L/4]),L+=4}++s}updateR(n,L);break;case 25:case 21:if(L<0)if((L+=4294967296)<pixelBase+4*pixelAreaSize&&L>=pixelBase)updateR(n,v1address[Math.floor((L-pixelBase)/4)]>>8*(3&L)&255);else if(L<IOBase&&L>=charBase)updateR(n,v2address[Math.floor((L-charBase)/4)]>>8*(3&L)&255);else if(L==dotLabelValues[6])updateR(n,255&lastKey);else if(L==dotLabelValues[7])updateR(n,255&lastKey),lastKey=0;else{if(L!=dotLabelValues[19])return message("Bad I/O address for LDRB at line "+convert2(lineNo)),1;fileRead?(updateR(n,255&fileRead.charCodeAt(0)),fileRead=fileRead.substr(1)):updateR(n,255)}else updateR(n,address[Math.floor(L/4)]>>8*(3&L)&255);break;case 26:case 22:if(L>=0&&L<dotDataAddress)return message("Attempt to STRB into the code area at line "+convert2(lineNo)),1;if(o=255&(n<15?register[n]:pCounter+4),L<0)if((L+=4294967296)<charBase+charMax&&L>=charBase){var I=255<<8*(3&L),C=o<<8*(3&L)&I,k=Math.floor((L-charBase)/4);v2address[k]&=4294967295^I,v2address[k]|=C,showChar(L-charBase,o),g=1e3}else if(L==dotLabelValues[3])outputNum(o,7),g=1e3;else{if(L!=dotLabelValues[29])return message("Bad I/O address for STRB at line "+convert2(lineNo)),1;fileWriteBuffer+=String.fromCharCode(255&o)}else setAddressByte(L,o);break;case 39:if((L=(4294967292&register[13])-4)>=maxUsableMem||L<0)return message("Bad SP address for SVC at line "+convert2(lineNo)),1;if(!(IOVectors[0]>=0&&0==(3&IOVectors[0])&&IOVectors[0]<maxUsableMem))return message("Bad vector address for SVC at line "+convert2(lineNo)),1;setAddress(L,flags<<28|255&interruptMask),setAddress(L-=4,pCounter),updateR(13,L),updatePC(IOVectors[0]),interruptMask&=4294967294;break;default:return message("Bad instruction at line "+convert2(lineNo)),1;break}if(breakpointAddr==pCounter)return step1Code=2,1;if(serviceMode)return 0;if(!dontDisplay){return stepTxt="Done instruction "+a+r+" at line "+convert2(lineNo),0;break}}if(xTime&&xTime<Date.now()&&0!=(1&interruptMask)){var L;if((L=(4294967292&register[13])-4)>=maxUsableMem||L<0)return stepTxt="Done instruction "+a+r+" at line "+convert2(lineNo),0;doClockInt()}}return stepTxt="Done instruction "+a+r+" at line "+convert2(lineNo),0}function videoProc(e,t,a){return v1address[t]==a?e:(v1address[t]=a,serviceMode||videoWrite(t,a),!1)}function inputNum(e,t){registerToInput=e,waitingForInput=!0,inst=t,noKeyEffects=!1,serviceMode||enableInput(-2==t)}function outputNum(e,t){if(8!=t){switch(7!=t&&output1.length>0&&" "!=output1[output1.length-1]&&"\n"!=output1[output1.length-1]&&(output1+=" "),t){case 3:if(0==(4294967040&e))output1+="0";else{for(var a=(4294967040&e)/2147483648,r=255&e;r>127;)a/=2,++r,r&=255;for(;r>0;)a*=2,--r;e=a.toPrecision(6),output1+=e}break;case 4:output1+=e>2147483647?"-"+(e=4294967296-e)+" ":e+" ";break;case 5:output1+=e+" ";break;case 6:output1+="0x",0!=(4026531840&e)&&(output1+=hex[e>>28&15]),0!=(4278190080&e)&&(output1+=hex[e>>24&15]),0!=(4293918720&e)&&(output1+=hex[e>>20&15]),0!=(4294901760&e)&&(output1+=hex[e>>16&15]),0!=(4294963200&e)&&(output1+=hex[e>>12&15]),0!=(4294967040&e)&&(output1+=hex[e>>8&15]),0!=(4294967280&e)&&(output1+=hex[e>>4&15]),output1+=hex[e%16]+" ";break;case 7:s=String.fromCharCode(e);10==e?output1+="\n":e>31&&(output1+=s);break}serviceMode||justConsole()}else{for(var n;!(e<0||e>=maxUsableMem)&&0!=(n=address[Math.floor(e/4)]>>8*(3&e)&255);){var s=String.fromCharCode(n);10==n?output1+="\n":n>31&&(output1+=s),++e}serviceMode||justConsole()}}function clearCharMap(){for(var e=0;e<charMax;++e)showChar(e,0)}function inputSubmit(){var e=getInput();!1!==e&&(waitingForInput?""!=e?processInput(e):message("Bad input - must not be empty"):debug&&alert("Bad input - not waiting for input"))}function processInput(e){var t;if(0==inst){if(t=parseIntGen(e),isNaN(t)||t>4294967295||t<-2147483648)return message("Bad number format or value"),!1}else{if(inst<0){var a=(t=e).length;if(registerToInput>14||0==a)return!1;var r=register[registerToInput];if(a>127&&(a=127),r>=0&&r<maxUsableMem-a){var n;for(n=0;n<a;++n)setAddressByte(r,t.charCodeAt(n)),++r;setAddressByte(r,0)}return serviceMode||inputRestore(-2==inst?"":e),noKeyEffects=!0,waitingForInput=!1,!0}var s=parseFloat(e);if(isNaN(s))return message("Bad input - must be a floating point number"),!1;for(var i=0;(s>=1||s<-1)&&(s/=2,!(++i>127)););for(;s<.5&&s>=-.5&&0!=s&&(s*=2,!(--i<-128)););if(i>127)return message("Bad input - number out of range"),!1;0==s||i<-128?t=0:(tmp=2147483648*s,t=(4294967040&tmp)+(255&i))}return serviceMode||inputRestore(e),noKeyEffects=!0,updateR(registerToInput,t),waitingForInput=!1,!0}var coloursNam=[".background",".aliceblue",".antiquewhite",".aqua",".aquamarine",".azure",".beige",".bisque",".black",".blanchedalmond",".blue",".blueviolet",".brown",".burlywood",".cadetblue",".chartreuse",".chocolate",".coral",".cornflowerblue",".cornsilk",".crimson",".cyan",".darkblue",".darkcyan",".darkgoldenrod",".darkgray",".darkgreen",".darkgrey",".darkkhaki",".darkmagenta",".darkolivegreen",".darkorange",".darkorchid",".darkred",".darksalmon",".darkseagreen",".darkslateblue",".darkslategray",".darkslategrey",".darkturquoise",".darkviolet",".deeppink",".deepskyblue",".dimgray",".dimgrey",".dodgerblue",".firebrick",".floralwhite",".forestgreen",".fuchsia",".gainsboro",".ghostwhite",".gold",".goldenrod",".gray",".green",".greenyellow",".grey",".honeydew",".hotpink",".indianred",".indigo",".ivory",".khaki",".lavender",".lavenderblush",".lawngreen",".lemonchiffon",".lightblue",".lightcoral",".lightcyan",".lightgoldenrodyellow",".lightgray",".lightgreen",".lightgrey",".lightpink",".lightsalmon",".lightseagreen",".lightskyblue",".lightslategray",".lightslategrey",".lightsteelblue",".lightyellow",".lime",".limegreen",".linen",".magenta",".maroon",".mediumaquamarine",".mediumblue",".mediumorchid",".mediumpurple",".mediumseagreen",".mediumslateblue",".mediumspringgreen",".mediumturquoise",".mediumvioletred",".midnightblue",".mintcream",".mistyrose",".moccasin",".navajowhite",".navy",".oldlace",".olive",".olivedrab",".orange",".orangered",".orchid",".palegoldenrod",".palegreen",".paleturquoise",".palevioletred",".papayawhip",".peachpuff",".peru",".pink",".plum",".powderblue",".purple",".red",".rosybrown",".royalblue",".saddlebrown",".salmon",".sandybrown",".seagreen",".seashell",".sienna",".silver",".skyblue",".slateblue",".slategray",".slategrey",".snow",".springgreen",".steelblue",".tan",".teal",".thistle",".tomato",".turquoise",".violet",".wheat",".white",".whitesmoke",".yellow",".yellowgreen",""],coloursVal=["0xffffff","0xf0f8ff","0xfaebd7","0x00ffff","0x7fffd4","0xf0ffff","0xf5f5dc","0xffe4c4","0x000000","0xffebcd","0x0000ff","0x8a2be2","0xa52a2a","0xdeb887","0x5f9ea0","0x7fff00","0xd2691e","0xff7f50","0x6495ed","0xfff8dc","0xdc143c","0x00ffff","0x00008b","0x008b8b","0xb8860b","0xa9a9a9","0x006400","0xa9a9a9","0xbdb76b","0x8b008b","0x556b2f","0xff8c00","0x9932cc","0x8b0000","0xe9967a","0x8fbc8f","0x483d8b","0x2f4f4f","0x2f4f4f","0x00ced1","0x9400d3","0xff1493","0x00bfff","0x696969","0x696969","0x1e90ff","0xb22222","0xfffaf0","0x228b22","0xff00ff","0xdcdcdc","0xf8f8ff","0xffd700","0xdaa520","0x808080","0x008000","0xadff2f","0x808080","0xf0fff0","0xff69b4","0xcd5c5c","0x4b0082","0xfffff0","0xf0e68c","0xe6e6fa","0xfff0f5","0x7cfc00","0xfffacd","0xadd8e6","0xf08080","0xe0ffff","0xfafad2","0xd3d3d3","0x90ee90","0xd3d3d3","0xffb6c1","0xffa07a","0x20b2aa","0x87cefa","0x778899","0x778899","0xb0c4de","0xffffe0","0x00ff00","0x32cd32","0xfaf0e6","0xff00ff","0x800000","0x66cdaa","0x0000cd","0xba55d3","0x9370db","0x3cb371","0x7b68ee","0x00fa9a","0x48d1cc","0xc71585","0x191970","0xf5fffa","0xffe4e1","0xffe4b5","0xffdead","0x000080","0xfdf5e6","0x808000","0x6b8e23","0xffa500","0xff4500","0xda70d6","0xeee8aa","0x98fb98","0xafeeee","0xdb7093","0xffefd5","0xffdab9","0xcd853f","0xffc0cb","0xdda0dd","0xb0e0e6","0x800080","0xff0000","0xbc8f8f","0x4169e1","0x8b4513","0xfa8072","0xf4a460","0x2e8b57","0xfff5ee","0xa0522d","0xc0c0c0","0x87ceeb","0x6a5acd","0x708090","0x708090","0xfffafa","0x00ff7f","0x4682b4","0xd2b48c","0x008080","0xd8bfd8","0xff6347","0x40e0d0","0xee82ee","0xf5deb3","0xffffff","0xf5f5f5","0xffff00","0x9acd32"];function getColourVal(e){for(i=0;i<200;++i){if(""==coloursNam[i])return-1;if(e==coloursNam[i])return coloursVal[i]}return-1}var plhtmp,editWin=296;function setupDivs(){resetLoadButton(),consoleReset();for(var e="",t=0,a=0;a<32;++a){e+='<div class="row"><div class="address" id="meml'+a+'">0x'+padHex(a,4)+"</div>";for(var r=0;r<4;++r)e+='<div class="word" id="a'+t+'" onclick="openAddress(this)" >0x0</div>',++t;e+="</div>"}setValue("memory",e),setPixelAreaSize(pixelAreaSize),e="";for(a=0;a<512;++a)e+='<div id="c'+a+'"></div>';setValue("chars",e)}function setPixelAreaSize(e){var t="";if(12288==e?(pixelAreaSize=12288,removeClass("pixels","pixels1"),addClass("pixels","pixels2")):(pixelAreaSize=3072,removeClass("pixels","pixels2"),addClass("pixels","pixels1")),!serviceMode){if(0!=(5&pixelMask)){document.getElementById("chars").style.display="none";for(var a=0;a<pixelAreaSize;++a)t+='<div id="p'+a+'" onclick="pixelInt(this)"></div>'}else{document.getElementById("chars").style.display="block";for(a=0;a<pixelAreaSize;++a)t+='<div id="p'+a+'"></div>'}setValue("pixels",t)}}function padHex(e,t){var a=Number(e).toString(16);for(t=null==t?t=2:t;a.length<t;)a="0"+a;return a}function message(e){if(0==dontDisplay&&!serviceMode){var t=document.getElementById("console");t.innerHTML=e?output1+"\n"+e:output1,scrollTimeout||(scrollTimeout=setTimeout(scroll_to_max,10),plhtmp=0)}lastMessage=e}function justConsole(){document.getElementById("console").innerHTML=output1,scrollTimeout||(scrollTimeout=setTimeout(scroll_to_max,10),plhtmp=0)}function scroll_to_max(){++plhtmp;var e=document.getElementById("console"),t=e.scrollTop;e.scrollTop=t+4e3,e.scrollTop!=t?scrollTimeout=setTimeout(scroll_to_max,10):(scrollTimeout=!1,debug&&plhtmp>100&&alert("Scroll attempts are "+plhtmp))}function videoWrite(e,t){e<0||e>=pixelAreaSize||(t&=16777215,document.getElementById("p"+e).style.background="#"+padHex(t,6))}function openNextMem(e){var t=document.getElementById("a"+e);return t.innerHTML=addressInputText(t.innerHTML),document.getElementById("aForm").focus(),document.getElementById("aForm").setAttribute("onblur","loseAddress(this)"),t}function insertTabInProgramArea(){var e=document.getElementById("pForm"),t=e.selectionStart;e.value=e.value.substring(0,e.selectionStart)+"\t"+e.value.substring(e.selectionEnd),e.selectionEnd=t+1}function openProgramArea(e){addClass("program","edit");var t=document.getElementById("source");t.style.overflow="initial",t.style.whiteSpace="normal",t.innerHTML='<form action="javascript:programSubmit()"><textarea id="pForm" rows="36" cols="36"  spellcheck="false" >'+e.replace(/&/g,"&amp;"),(t=document.getElementById("pForm")).style.width=editWin+"px",t.focus()}function getProgramArea(){return document.getElementById("pForm").value}function resetProgramArea(e){setValue("source",e);var t=document.getElementById("source");t.style.overflow="auto",t.style.whiteSpace="nowrap",t.scrollTop=0,lastCodeHighlight=-1,breakpointAddr=-1,errorLineNum=-1}var lastState=0;function setStateReady(){changeState(1)}function setStateEdit(){changeState(2)}function setStateRunning(){changeState(4)}function setStateForceRunning(){5!=lastState&&changeState(4)}function setStateSlow(){changeState(5)}function setStatePaused(){changeState(6)}var plhComCnt=0;function changeState(e){if(serviceMode)lastState=e;else{if(lastState==e)return++plhComCnt,void(2==debug&&setValue("credits","New state "+t(e)+" == Old state "+t(lastState)+" == Dup "+plhComCnt));if(plhComCnt=0,2==debug&&setValue("credits","New state "+t(e)+" == Old state "+t(lastState)),0!=lastState){if(6==lastState&&(removeClass("xxbody","paused"),lastState=4),5==lastState&&(removeClass("xxbody","slow"),lastState=4),lastState==e)return;if(4==lastState&&e>=4){if(lastState=e,4==e)return;return 5==e&&addClass("xxbody","slow"),void(6==e&&addClass("xxbody","paused"))}4==lastState&&removeClass("xxbody","running"),2==lastState&&removeClass("xxbody","edit"),1==lastState&&removeClass("xxbody","ready")}if(lastState=e,e>=4)return addClass("xxbody","running"),5==e&&addClass("xxbody","slow"),void(6==e&&addClass("xxbody","paused"));2==lastState&&addClass("xxbody","edit"),1==lastState&&addClass("xxbody","ready")}function t(e){return 1==e?"ready":2==e?"edit":4==e?"running":5==e?"running+slow":6==e?"running+paused":e}}function intButtonReset(){removeClass("irq","enabled"),removeClass("irq","active")}function intButtonSetup(){serviceMode||addClass("irq","enabled")}function intButtonGrey(){serviceMode||removeClass("irq","active")}function intButtonShow(){serviceMode||(addClass("irq","enabled"),addClass("irq","active"))}function rewriteSide(){for(var e=16*overlay,t=0;t<32;++t)setValue("meml"+t,"0x"+padHex(e+t,4));setValue("page",padHex(overlay,3))}function changePage(){if(myMaybe||myTimeout)return!1;message("Modifying memory overlay"),setValue("page",overlayForm),document.getElementById("oForm").focus(),waitingForOverlay=!0}var overlayForm='<form action="javascript:pageSubmit()"><input id="oForm" type="text"></form>';function pageSubmit(){var e=document.getElementById("oForm");if(!e||!waitingForOverlay)return debug&&alert("Bad pageSubmit call"),!1;waitingForOverlay=!1;var t=parseInt(e.value,16);if(isNaN(t)||256*t>=maxUsableMem)return setValue("page",padHex(overlay,3)),void message("Bad page value");256*t==maxUsableMem-256&&--t;var a=lastMemHighlight;removeMemHighlight(),overlay=t;var r=dontDisplay;dontDisplay=0,rewriteSide(),rewriteMemoryAndRegs(!0),a>=0&&setMemHighlight(a),dontDisplay=r,message("Page value set")}function resetLoadButton(){setValue("program-controls",loadText)}var loadText='<input type="file" id="read-input" onchange="read_chg(this)" autocomplete="off"><button id="load" onclick="document.getElementById(&#39;read-input&#39;).click()">Load</button><button  id="save" onclick="saveProgram()">Save</button><button  id="edit" onclick="openProgram()">Edit</button><button  id="submit" onclick="programSubmit()">Submit</button><button  id="revert" onclick="programCancel()">Revert</button>';function setLabel(e){var t=document.getElementById("lin"+e);t?t.classList.add("label"):debug&&alert("could not find line "+e+" to set label class")}function setCode(e,t){var a=document.getElementById("lin"+e);a?(a.classList.add("selectable"),a.title=t,a.setAttribute("onclick","javascript:setBreakpoint(this);")):debug&&alert("could not find line "+e+" to set code options")}function setData(e,t){var a=document.getElementById("lin"+e);a?a.title=t:debug&&alert("could not find line "+e+" to set data options")}function setBreakpoint(e){if(!waitingForInput&&!myTimeout&&!myMaybe){var t=parseInt(e.id.substring(3)),a=parseInt(e.title);isNaN(t)||isNaN(a)?debug&&alert("could not parse breakpoint id "+e.id+" title "+a):a==breakpointAddr?(e.classList.remove(breakpoint),breakpointAddr=-1,message("Breakpoint removed at line "+t+" address 0x"+padHex(a,5))):(breakpointAddr>=0&&removeClassFromLineNumber(addrToLine[breakpointAddr/4],breakpoint),breakpointAddr=a,e.classList.add(breakpoint),message("Breakpoint set at line "+t+" address 0x"+padHex(a,5)))}}function updateRDisplay(e,t){Math.floor(t)!=t&&(debug&&alert("Attempt to put non-integer value into register "+t),t=Math.floor(t));var a=""+t,r=a;t>2147483647&&(r="-"+(4294967296-t));for(var n="0b",s=0;s<32;++s)n+=t<<s&2147483648?"1":"0";var i="0x"+padHex(t,8),o="";0==memOpt?(t=r,o=a==r?i+" "+n:"("+a+") "+i+" "+n):1==memOpt?(t=a,o=a==r?i+" "+n:r+" "+i+" "+n):3==memOpt?(t=n,o=a==r?r+" "+i:r+" ("+a+") "+i):(t=i,o=a==r?r+" "+n:r+" ("+a+") "+n);var d=document.getElementById("R"+e);d?(d.innerHTML=t,d.title=o):debug&&alert("Simulator bug - cannot find R"+e+" to set new contents "+t)}function updateFlags(e){if(flags=15&e,1!=dontDisplay){var t=0!=(8&e)?"1":"0";t+=0!=(4&e)?"1":"0",t+=0!=(2&e)?"1":"0",setValue("flags",t+=0!=(1&e)?"1":"0")}}function addressInputText(e){return"0"!=e&&"0x00000000"!=e&&"0b00000000000000000000000000000000"!=e||(e=""),'<form action="javascript:addressSubmit()"><input id="aForm" type="text" style="padding:0; border:0; font-family: monospace; width:'+(3==memOpt?"252":"75")+'px;height:14px;font-size:13.4px;" value="'+e+'"></form>'}function openAddressToEdit(e){e.innerHTML=addressInputText(e.innerHTML),document.getElementById("aForm").focus(),document.getElementById("aForm").setAttribute("onblur","loseAddress(this)")}function getAddressValue(){return document.getElementById("aForm").value}function resetAddressInput(){document.getElementById("aForm").removeAttribute("onblur")}var breakpoint="breakpoint",current="current",error="error";function updateDisplayedMemory(e,t){var a=""+t,r=a;t>2147483647&&(r="-"+(4294967296-t));for(var n="0b",s=0;s<32;++s)n+=t<<s&2147483648?"1":"0";var i="0x"+padHex(t,8),o="";0==memOpt?(t=r,o=a==r?i+" "+n:"("+a+") "+i+" "+n):1==memOpt?(t=a,o=a==r?i+" "+n:r+" "+i+" "+n):3==memOpt?(t=n,o=a==r?r+" "+i:r+" ("+a+") "+i):(t=i,o=a==r?r+" "+n:r+" ("+a+") "+n);var d=document.getElementById("a"+e);d?(d.innerHTML=t,d.title=o):debug&&alert("Simulator bug - cannot find a"+e+" to set new contents "+t)}function removeCodeHighlight(){lastCodeHighlight>=0&&(document.getElementById("lin"+lastCodeHighlight).classList.remove(current),lastCodeHighlight=-1)}function showExecute(e){removeCodeHighlight(),addClassToLineNumber(e,current),lastCodeHighlight=e}function showExecuteStop(e){removeCodeHighlight(),addClassToLineNumber(e,current),lastCodeHighlight=e;var t=15.2395*(e-18);e<30&&(t=0),document.getElementById("source").scrollTop=t}function showError(e){if(byteCount=0,errorLineNum=e,!serviceMode){addClassToLineNumber(e,error);var t=15.2395*(e-18);e<30&&(t=0),document.getElementById("source").scrollTop=t}}function removeError(){errorLineNum>=0&&(removeClassFromLineNumber(errorLineNum,error),errorLineNum=-1)}function addClassToLineNumber(e,t){if(!(e<0)){var a=document.getElementById("lin"+e);a?a.classList.add(t):debug&&alert("could not find line "+e+" to add class "+t)}}function removeClassFromLineNumber(e,t){if(!(e<0)){var a=document.getElementById("lin"+e);a?a.classList.remove(t):debug&&alert("could not find line "+e+" to remove class "+t)}}function removeMemHighlight(){if(lastMemHighlight>=0){var e=256*overlay;lastMemHighlight>=e&&lastMemHighlight<e+512&&(e=Math.floor((lastMemHighlight-e)/4),document.getElementById("a"+e).classList.remove(current)),lastMemHighlight=-1}}function setMemHighlight(e){if(removeMemHighlight(),!(e<0)){var t=256*overlay;e>=t&&e<t+512&&(t=Math.floor((e-t)/4),document.getElementById("a"+t).classList.add(current)),lastMemHighlight=e}}function IEKeyEnable(){document.getElementById("xxbody").focus()}function clearInputArea(){setValue("input","&nbsp;")}function enableInput(e){setValue("input",e?inputFormSecret:inputForm),document.getElementById("iForm").focus()}var inputForm='<form action="javascript:inputSubmit()"><input id="iForm" type="text" placeholder="Input expected"></form>',inputFormSecret='<form action="javascript:inputSubmit()"><input id="iForm" type="password" placeholder="Input expected"></form>';function showChar(e,t){if(e<0||e>=512)debug&&alert("Bad index for showChar() "+e);else{var a="";t>32&&t<128&&(a="<"==t?"&lt;":">"==t?"&gt;":"&"==t?"&amp;":String.fromCharCode(t)),setValue("c"+e,a)}}function getInput(){var e=document.getElementById("iForm");return e?e.value:(debug&&alert("Bad getInput call"),!1)}function inputRestore(e){setValue("input",e)}function clearIR(){setValue("ir","&nbsp;"),setValue("ur","&nbsp;")}function setIR(e){setValue("ir",e)}function addIR(e){setValue("ur",e)}function fileOpen(){setValue("outer_console",'<textarea class="console" id="console" readonly>'+output1+"\n</textarea>"+fileText),document.getElementById("read-file").click()}var fileText='<input type="file" id="read-file" onchange="read_file(this)" autocomplete="off"><button onclick="document.getElementById(&#39;read-file&#39;).click()">File Open required</button>';function consoleReset(){setValue("outer_console",'<textarea class="console" id="console" readonly>'+output1+"\n</textarea>")}function saveFile(e,t){var a=new Blob([e],{type:"text/plain"}),r=window.URL.createObjectURL(a),n=document.createElement("a");n.download=t,n.innerHTML="Download File",n.href=r,n.onclick=destroyClickedElement,n.style.display="none",document.body.appendChild(n),n.click()}function destroyClickedElement(e){document.body.removeChild(e.target)}function setValue(e,t){if(!serviceMode){var a=document.getElementById(e);a?a.innerHTML=t:debug&&alert("Simulator bug - cannot find "+e+" to set new contents "+t)}}function setClass(e,t){if(!serviceMode){var a=document.getElementById(e);a||(debug?alert("Simulator bug - cannot find "+e+" to set new class "+t):a.className=t)}}function addClass(e,t){if(!serviceMode){var a=document.getElementById(e);a?a.classList.add(t):debug&&alert("Simulator bug - cannot find "+e+" to add class "+t)}}function removeClass(e,t){if(!serviceMode){var a=document.getElementById(e);a?a.classList.remove(t):debug&&alert("Simulator bug - cannot find "+e+" to remove class "+newClass)}}function setProgramWidth(e){if(!serviceMode){editWin=e-4;var t,a=e+50,r=e+400;3==memOpt&&(r+=170),(t=document.getElementById("mxx"))?t.style.left=r+"px":debug&&alert("Simulator bug - cannot find mxx to set left "+r),(t=document.getElementById("processor"))?t.style.left=a+"px":debug&&alert("Simulator bug - cannot find processor to set left "+a),(t=document.getElementById("io"))?t.style.left=a+"px":debug&&alert("Simulator bug - cannot find io to set left "+a),(t=document.getElementById("program"))?t.style.width=e+"px":debug&&alert("Simulator bug - cannot find program to set width "+e),modifyingProgram&&((t=document.getElementById("pForm")).style.width=editWin+"px")}}function setMemBinary(e){if(!serviceMode){var t=editWin+404;e&&(t+=170);var a=document.getElementById("mxx");a?(a.style.left=t+"px",a.style.fontSize=e?binarySize+"%":"100%"):debug&&alert("Simulator bug - cannot find mxx to set left "+t),(a=document.getElementById("registers"))?a.style.fontSize=e?binarySize+"%":"100%":debug&&alert("Simulator bug - cannot find registers to set fontSize")}}function changeDimensions(){if(getDimensions(),dynamicProgramWidth){var e=maxWidth-834;e<300&&(e=300),e>3e3&&(e=3e3),setProgramWidth(e)}}