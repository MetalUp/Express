var maxHeight,maxWidth,speed,inst,addr,stopping,oneStep,runTimer,lineNo,plhtmp,lastKey=0,noKeyEffects=!1;function startIt(){getDimensions(),main()}function getDimensions(){"number"==typeof window.innerWidth?(maxWidth=window.innerWidth,maxHeight=window.innerHeight):(maxWidth=document.documentElement.clientWidth,maxHeight=document.documentElement.clientHeight)}function randomInt(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function getMilliseconds(){return new Date().getTime()}function delay(e,t){for(var a=t+"(",r=2;r<arguments.length;r++)r>2&&(a+=","),a+=arguments[r];return setTimeout(a+=")",e)}var chrsToMatch=[],dnFnCall=[],upFnCall=[],chrsDown=[];function trapKey(e,t,a){var r=chrsToMatch.indexOf(e);-1==r&&(chrsDown[r=chrsToMatch.push(e)-1]=0),dnFnCall[r]=t,upFnCall[r]=a}function keyDown(e){var t=e.keyCode;if(8==t){var a,r=e.srcElement||e.target;switch(r.tagName.toUpperCase()){case"TEXTAREA":a=r.readOnly||r.disabled;break;case"INPUT":a=r.readOnly||r.disabled||r.attributes.type&&["radio","checkbox","submit","button"].indexOf(r.attributes.type.value.toLowerCase())>=0;break;case"DIV":a=r.readOnly||r.disabled||!(r.attributes.contentEditable&&"true"==r.attributes.contentEditable.value);break;default:a=!0}a&&e.preventDefault()}var n=String.fromCharCode(t);(27==t||9==t)&&(n=t);var $=chrsToMatch.indexOf(n);if(-1==$){if(noKeyEffects){if((4&keyboardMask)==0){if(t>90)return;if((2&keyboardMask)==0){if(t<48)return}else if(t<37||t>40&&t<48)return}lastKey=t,testKeyInterrupt(),e.preventDefault()}}else chrsDown[$]=1,dnFnCall[$]&&window[dnFnCall[$]](e)}function keyUp(e){var t=e.keyCode,a=String.fromCharCode(t);(27==t||9==t)&&(a=t);var r=chrsToMatch.indexOf(a);-1!=r&&1==chrsDown[r]&&(chrsDown[r]=0,upFnCall[r]&&window[upFnCall[r]](e))}var myTimeout=!1,scrollTimeout=!1,register=[],flags=0,pCounter=0,programText="",programHTML="",programEdit="",programSave="",output1="",fileRead="",fileResult=-1,address=[],v1address=[],v2address=[],instructionTxt=[],addrToLine=[],lineToByteAddress=[],slowSpeed=40,delayTime=4,comment_align=24,dynamicProgramWidth=!1,fileWriteBuffer=[],waitingForInput=!1,registerToInput=0,modifyingProgram=!1,running=!1,lastCodeHighlight=-1,lastMemHighlight=-1,breakpointAddr=-1,errorLineNum=-1,memOpt=2,maxUsableMem=1048576,overlay=0,lastPixelClick=-1,waitingForOverlay=!1,byteCount=0,instructionCount=0,measureSpeed=0,breakPoint=-1,hex=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],debug=0,xTime=0,interruptCnt=0,dotDataAddress=0,firstDataDefn=0,dontDisplay=0,binarySize=100,lastMessage="",oldPCMarker=-1,stepTxt="",step1Code=0,halted="Program HALTED. STOP, LOAD or EDIT",IOBase=4294967040,fakeBig=4294963968,charMax=512,charBase=4294963424,pixelBase=4294914048,vaddressBase=pixelBase,pixelAreaSize=3072,IOVectorBase=4294967168,IOVectors=[-1,-1,-1,-1,-1],interruptMask=0,keyboardMask=0,pinMask=0,clockIntFreq=0,pixelMask=0,interruptRequest=0,canSave=!1,haveSaved=!1,saveSeq=0,eventCount=0,eventList="",eventStep=0,logTime=Date.now(),plh_id=0,plh_url="",dotLabelNames=[".WriteSignedNum",".WriteUnsignedNum",".WriteHex",".WriteChar",".WriteString",".InputNum",".LastKey",".LastKeyAndReset",".Random",".InstructionCount",".Time",".PinISR",".SysISR",".KeyboardISR",".ClockISR",".InterruptRegister",".PinMask",".KeyboardMask",".ClockInterruptFrequency",".CodeLimit",".PixelScreen",".CharScreen",".OpenFile",".FileLength",".ReadFileChar",".ReadString",".InputFP",".WriteFP",".PixelAreaSize",".WriteFileChar",".WriteFile",".ClearScreen",".ReadSecret",".PixelISR",".LastPixelClicked",".LastPixelAndReset",".PixelMask",".Resolution"],dotLabelValues=[IOBase+16,IOBase+20,IOBase+24,IOBase+28,IOBase+32,IOBase+8,IOBase+16,IOBase+20,IOBase+32,IOBase+64,IOBase+68,IOVectorBase+4,IOVectorBase,IOVectorBase+8,IOVectorBase+12,IOBase+72,IOBase+76,IOBase+52,IOBase+56,IOBase+80,pixelBase,charBase,IOBase+84,IOBase+88,IOBase+92,IOBase+96,IOBase+100,IOBase+104,IOBase+108,IOBase+112,IOBase+116,IOBase+108,IOBase+36,IOVectorBase+16,IOBase+40,IOBase+44,IOBase+48,IOBase+60],dotLabelMode=[1,1,1,3,1,4,12,12,4,4,4,5,21,5,5,5,5,5,5,4,31,31,4,4,12,1,4,1,4,3,1,1,1,5,4,4,5,5];function matchDotLabel(e){var t;for(t=0;t<dotLabelNames.length;++t)if(e==dotLabelNames[t])return t;if(e.length>6&&e.startsWith(".Pixel")){var a=parseIntGen(e.substring(6));return isNaN(a)||a<0||a>767?-1:fakeBig+4*a}return -1}function matchIOAddress(e){var t;for(t=0;t<dotLabelValues.length;++t)if(e==dotLabelValues[t])return t;return -1}function main(){var e=new URL(location),t=e.searchParams.get("slow_delay");if(t){var a=parseInt(t);a>1&&a<1e3&&(slowSpeed=a)}if(t=e.searchParams.get("fast_delay")){var a=parseInt(t);a>0&&a<251&&(delayTime=a)}if((t=e.searchParams.get("data"))&&((t=t.toLowerCase()).startsWith("sig")&&(memOpt=0),t.startsWith("dec")&&(memOpt=0),t.startsWith("uns")&&(memOpt=1),t.startsWith("hex")&&(memOpt=2),t.startsWith("bin")&&(memOpt=3,addClass("xxbody","binary"))),t=e.searchParams.get("mem_k")){var a=parseInt(t);a>=1&&a<=1024&&(maxUsableMem=1024*a)}if(t=e.searchParams.get("debug")){var a=parseInt(t);debug=a}if(t=e.searchParams.get("profile"))addClass("xxbody","profile-"+t);else{dynamicProgramWidth=!0;var r=maxWidth-826;if(t=e.searchParams.get("progw")){var a=parseInt(t);a>=300&&a<=3e3&&(r=a,dynamicProgramWidth=!1)}setProgramWidth(r)}if(t=e.searchParams.get("alcom")){var a=parseInt(t);a>5&&a<301&&(comment_align=a)}if(binarySize=navigator.platform.indexOf("Win32")>-1?100:92,t=e.searchParams.get("binsiz")){var a=parseInt(t);a>79&&a<101&&(binarySize=a)}window.document.title="ARMlite Assembly Language Simulator by Peter Higginson",trapKey(9,"tabKey",null),trapKey(27,"escKey",null),setupDivs(),updateR(0,0),updateR(1,0),updateR(2,0),updateR(3,0),updateR(4,0),updateR(5,0),updateR(6,0),updateR(7,0),updateR(8,0),updateR(9,0),updateR(10,0),updateR(11,0),updateR(12,0),updateR(13,maxUsableMem),updateR(14,0),updateFlags(0),updatePC(0),clearIR(),output1="System Messages",message("LOAD, EDIT a program or modify memory"),removeClass("program","edit"),setStateReady();for(var n=0;n<maxUsableMem;n+=4)setAddress(n,0)}function escKey(e){if(waitingForInput&&!myTimeout&&!myMaybe){if(e.preventDefault(),waitingForInput=!1,setStateReady(),savOpenAddress){var t=parseInt(savOpenAddress.id[1]);savOpenAddress.id.length>=3&&(t=10*t+parseInt(savOpenAddress.id[2])),savOpenAddress.id.length>=4&&(t=10*t+parseInt(savOpenAddress.id[3])),5==savOpenAddress.id.length&&(t=10*t+parseInt(savOpenAddress.id[4])),setAddress(4*(t+=64*overlay),address[t]),savOpenAddress=!1}else modifyingProgram&&(modifyingProgram=!1,textToHtml());message("ESC pressed to abort input")}}function tabKey(e){if(e.preventDefault(),waitingForInput&&!myTimeout&&!myMaybe){if(savOpenAddress){var t=parseInt(savOpenAddress.id[1]);savOpenAddress.id.length>=3&&(t=10*t+parseInt(savOpenAddress.id[2])),savOpenAddress.id.length>=4&&(t=10*t+parseInt(savOpenAddress.id[3])),5==savOpenAddress.id.length&&(t=10*t+parseInt(savOpenAddress.id[4]));var a=document.getElementById("aForm"),r=checkInput(a.value);loseAddress(a),t<127?(++t,r&&message("Modifying memory contents"),savOpenAddress=openNextMem(t),waitingForInput=!0,setStateEdit(),evPush("An")):(waitingForInput=!1,setStateReady())}else modifyingProgram&&insertTabInProgramArea()}}function openProgram(){if(!waitingForInput&&!myTimeout&&!myMaybe){evPush("Ed"),message("Modifying Program Area");var e=Math.floor(document.getElementById("source").scrollTop);setStateEdit(),openProgramArea(programEdit),waitingForInput=!0,modifyingProgram=!0,e&&(document.getElementById("pForm").scrollTop=e)}}function programSubmit(){if(!waitingForInput)return debug&&alert("Bad - Submit when not waiting for input"),!1;programSubmit2(!0)}function programSubmit2(e){if(waitingForInput=!1,modifyingProgram=!1,removeClass("program","edit"),programText=getProgramArea(),e&&programText.length<10&&programText.toLowerCase().startsWith("demo")){evPush("Dm"),demoSetup(),textToHtml(),assemble(),delay(100,"run");return}e?evPush("Sb"):evPush("SvSb"),textToHtml(),assemble()}function demoSetup(){programText="MOV R11,#.black// Constant\nMOV R12,#.white// Constant\nMOV R1,#screen2 \nADD R3,R1,#12288// End\nclearPixel:\nSTR R12,[R1]// set everything white\nADD R1,R1,#4\nCMP R1,R3\nBLT clearPixel\n// Initialise 2nd screen with random pattern\nMOV R2,#screen2// 1st pixel\nADD R3,R2,#12288// End\nrandLoop:LDR R0,.Random\nAND R0,R0,#3// start with 25% set only\nCMP R0,#0\nBNE skip// only need to set blacks\nSTR R11,[R2]// set black\nskip:\nADD R2,R2,#4\nCMP R2,R3\nBLT randLoop\ncopyScreen2to1:\nMOV R1,#.PixelScreen\nMOV R2,#screen2\nADD R3,R1,#12288\ncopyLoop:\nLDR R0,[R2]\nSTR R0,[R1]\nADD R1,R1,#4\nADD R2,R2,#4\nCMP R1,R3\nBLT copyLoop\n// Next generation\nMOV R3,#0// R3 is cell offset,0 to 12288 (incr by 4)\nnextGenLoop:\nBL countBlock// count neighbours in R6\n// Now decide fate of cell\nMOV R2,#screen2\nADD R2,R2,R3\nCMP R6,#4\nBLT .+3 \nSTR R12,[R2]// Cell dies (or remains empty) if 4 or more neighbours\nB continue\nCMP R6,#3\nBLT .+3 \nSTR R11,[R2]// Cell born (or remains) if 3 or 4 neighbours\nB continue\nCMP R6,#2\nBEQ continue// Cell remains in present state if 2 neighbours\nSTR R12,[R2]// Cell dies (or remains empty) if < 2 neighbours\ncontinue:\nADD R3,R3,#4\nCMP R3,#12288\nBLT nextGenLoop\nB copyScreen2to1\n\n// R3 is pixel index,R6 return count\n// R11,R12 do not change,R5 used by countIfLive()\n// we use R1,R4 and R10 (as temp for LR!!!!)\ncountBlock:\nMOV R10,LR\nMOV R6,#0// Reset live count\nMOV R1,#.PixelScreen\nADD R1,R1,R3\nAND R4,R3,#255// index in row\nCMP R3,#256\nBLT topRow// remove all the special cases\nCMP R3,#12032\nBEQ leftBot// because BGE not in AQA set\nBGT botRow// and #12028 is > 8 bits\nCMP R4,#0\nBEQ leftCol\nCMP R4,#252\nBEQ rightCol\n// now can do original count neighbours\nSUB R1,R1,#256// North \nBL countIfLive\nADD R1,R1,#4// Northeast\nBL countIfLive\nADD R1,R1,#256// East\nBL countIfLive\nADD R1,R1,#256// Southeast\nBL countIfLive\nSUB R1,R1,#4// South\nBL countIfLive\nSUB R1,R1,#4// Southwest\nBL countIfLive\nSUB R1,R1,#256// West\nBL countIfLive\nSUB R1,R1,#256// Northwest\nBL countIfLive\nMOV PC,R10// RET\nrightCol:// but not top or bottom\nSUB R1,R1,#256// North \nBL countIfLive\nSUB R1,R1,#252// Northeast\nBL countIfLive\nADD R1,R1,#256// East\nBL countIfLive\nADD R1,R1,#256// Southeast\nBL countIfLive\nADD R1,R1,#252// South\nBL countIfLive\nSUB R1,R1,#4// Southwest\nBL countIfLive\nSUB R1,R1,#256// West\nBL countIfLive\nSUB R1,R1,#256// Northwest\nBL countIfLive\nMOV PC,R10// RET\nleftCol:// but not top or bottom\nSUB R1,R1,#256// North \nBL countIfLive\nADD R1,R1,#4// Northeast\nBL countIfLive\nADD R1,R1,#256// East\nBL countIfLive\nADD R1,R1,#256// Southeast\nBL countIfLive\nSUB R1,R1,#4// South\nBL countIfLive\nADD R1,R1,#252// Southwest\nBL countIfLive\nSUB R1,R1,#256// West\nBL countIfLive\nSUB R1,R1,#256// Northwest\nBL countIfLive\nMOV PC,R10// RET\ntopRow:\nCMP R4,#0// note R3=R4\nBEQ leftTop\nCMP R4,#252\nBEQ rightTop\n// now top but not sides\nADD R1,R1,#12032// North \nBL countIfLive\nADD R1,R1,#4// Northeast\nBL countIfLive\nSUB R1,R1,#12032// East\nBL countIfLive\nADD R1,R1,#256// Southeast\nBL countIfLive\nSUB R1,R1,#4// South\nBL countIfLive\nSUB R1,R1,#4// Southwest\nBL countIfLive\nSUB R1,R1,#256// West\nBL countIfLive\nADD R1,R1,#12032// Northwest\nBL countIfLive\nMOV PC,R10// RET\nbotRow:// removed leftBot already\nCMP R4,#252\nBEQ rightBot\nSUB R1,R1,#256// North \nBL countIfLive\nADD R1,R1,#4// Northeast\nBL countIfLive\nADD R1,R1,#256// East\nBL countIfLive\nSUB R1,R1,#12032// Southeast\nBL countIfLive\nSUB R1,R1,#4// South\nBL countIfLive\nSUB R1,R1,#4// Southwest\nBL countIfLive\nADD R1,R1,#12032// West\nBL countIfLive\nSUB R1,R1,#256// Northwest\nBL countIfLive\nMOV PC,R10// RET\n// There must be a way to improve this but I'm not short of space! \nleftTop:\nADD R1,R1,#12032// North \nBL countIfLive\nADD R1,R1,#4// Northeast\nBL countIfLive\nSUB R1,R1,#12032// East\nBL countIfLive\nADD R1,R1,#256// Southeast\nBL countIfLive\nSUB R1,R1,#4// South\nBL countIfLive\nADD R1,R1,#252// Southwest\nBL countIfLive\nSUB R1,R1,#256// West\nBL countIfLive\nADD R1,R1,#12032// Northwest\nBL countIfLive\nMOV PC,R10// RET\nrightTop:\nADD R1,R1,#12032// North \nBL countIfLive\nSUB R1,R1,#252// Northeast\nBL countIfLive\nMOV R1,#.PixelScreen// East (SUB is > 8 bits)\nBL countIfLive\nADD R1,R1,#256// Southeast\nBL countIfLive\nADD R1,R1,#252// South\nBL countIfLive\nSUB R1,R1,#4// Southwest\nBL countIfLive\nSUB R1,R1,#256// West\nBL countIfLive\nADD R1,R1,#12032// Northwest\nBL countIfLive\nMOV PC,R10// RET\nleftBot:\nSUB R1,R1,#256// North \nBL countIfLive\nADD R1,R1,#4// Northeast\nBL countIfLive\nADD R1,R1,#256// East\nBL countIfLive\nSUB R1,R1,#12032// Southeast\nBL countIfLive\nSUB R1,R1,#4// South (=#.PixelScreen)\nBL countIfLive\nADD R1,R1,#252// Southwest\nBL countIfLive\nADD R1,R1,#12032// West\nBL countIfLive\nSUB R1,R1,#256// Northwest\nBL countIfLive\nMOV PC,R10// RET\nrightBot:\nSUB R1,R1,#256// North \nBL countIfLive\nSUB R1,R1,#252// Northeast\nBL countIfLive\nADD R1,R1,#256// East\nBL countIfLive\nSUB R1,R1,#12032// Southeast (=#.PixelScreen)\nBL countIfLive\nADD R1,R1,#252// South\nBL countIfLive \nSUB R1,R1,#4// Southwest\nBL countIfLive\nADD R1,R1,#12032// West\nBL countIfLive\nSUB R1,R1,#256// Northwest\nBL countIfLive\nMOV PC,R10// RET\n// Subroutines\ncountIfLive:LDR R5,[R1]// Sub\nCMP R5,R12\nBEQ .+2\nADD R6,R6,#1\nRET\nHALT\n.ALIGN 1024\nscreen2:.DATA\n"}function programCancel(){if(!waitingForInput)return debug&&alert("Bad - Cancel when not waiting for input"),!1;evPush("Rv"),waitingForInput=!1,modifyingProgram=!1,""==programText?message("LOAD or EDIT a program"):message("RUN/STEP your program or LOAD/EDIT a program"),removeClass("program","edit"),resetProgramArea(programHTML),setStateReady()}function saveProgram(){evPush("Sv"),!0==modifyingProgram&&programSubmit2(!1),saveFile(programSave,"myprog.txt"),message("Saving File")}function iclick(){(1&pinMask)!=0&&IOVectors[1]>=0?(interruptRequest|=1,intButtonGrey()):(2&pinMask)!=0?(pinMask|=4,intButtonGrey()):debug&&alert("clicked but not enabled")}function checkClickColour(){(6&pinMask)==2?intButtonShow():(1&pinMask)==1&&IOVectors[1]>=0&&(3&IOVectors[1])==0&&IOVectors[1]<maxUsableMem?(1&interruptMask)!=0?intButtonShow():intButtonSetup():IOVectors[1]>=0||(2&pinMask)!=0?(intButtonSetup(),intButtonGrey()):intButtonReset()}function testKeyInterrupt(){(1&keyboardMask)==1&&IOVectors[2]>=0&&(3&IOVectors[2])==0&&IOVectors[2]<maxUsableMem&&(interruptRequest|=2)}function checkClockEnabled(){0==xTime&&0!=clockIntFreq&&(1&interruptMask)!=0&&IOVectors[3]>=0&&(3&IOVectors[3])==0&&IOVectors[3]<maxUsableMem&&(xTime=Date.now()+clockIntFreq)}function clearMem(){evPush("Clr"),reset2(),overlay=0,rewriteSide();for(var e=0;e<maxUsableMem;e+=4)setAddress(e,0);byteCount=0,programText="",textToHtml(),message("System Cleared")}function op2(){var e=document.getElementById("data").value;if(evPush(e),3==memOpt){if("bin"==e)return;removeClass("xxbody","binary"),setMemBinary(!1)}switch(e){case"sig":memOpt=0;break;case"uns":memOpt=1;break;case"bin":memOpt=3,addClass("xxbody","binary"),setMemBinary(!0);break;default:memOpt=2}var t=dontDisplay;dontDisplay=0,rewriteMemoryAndRegs(!1),dontDisplay=t}function rewriteMemoryAndRegs(e){updateFlags(flags);for(var t=64*overlay,a=0;a<128;++a)setAddress((a+t)*4,address[a+t]);if(!e){for(var a=0;a<15;++a)updateR(a,register[a]);updatePC(pCounter)}}function read_chg(e){evPush("Ld"),!0==modifyingProgram&&programCancel(),reset2();var t=e.files;if(!t){message("BAD FILE SELECTION RETURN");return}var a=new FileReader;a.readAsText(t[0],"utf-8"),a.onload=function(){programText=a.result,textToHtml(),assemble(),resetLoadButton()}}function read_file(e){var t=e.files;if(consoleReset(),!t){message("BAD FILE SELECTION RETURN"),fileResult>=0&&updateR(fileResult,4294967295),fileResult=-1,waitingForInput=!1;return}var a=new FileReader;a.onload=function(){fileRead=a.result,fileResult>=0&&updateR(fileResult,fileRead.length),waitingForInput=!1,fileResult=-1},a.readAsText(t[0],"utf-8")}function do_count(e){for(var t=0,a=0;t<e.length;)"	"==e[t]?a=a+4&1048572:++a,++t;return a}function textToHtml(){programHTML="",programEdit="",programSave="";var e=1,t=1,a=0,r="",n="",$=!1,s="",o="",l=!1,f=programText.length;"\n"!=programText[f-1]&&(programText+="\n",++f);for(var d=0;d<f;++d){var u,_=programText[d];if("	"==_){if($){for(var c=4-(3&do_count(n));c>0;)r+="&nbsp;",--c;n+="	";continue}_=" "}if(!(_<" ")||"\n"==_){if(!1==l){for(l=!0,u=d;u<f;++u){if("|"==programText[u]){d=u;break}if(" "!=programText[u]&&"	"!=programText[u]&&(programText[u]<"0"||programText[u]>"9")){u=-1;break}}if(d==u)continue}if(s){if(n+=_," "==_?r+="&nbsp;":"&"==_?r+="&amp;":"<"==_?r+="&lt;":">"==_?r+="&gt;":r+=_,"\\"==o){o="";continue}if(o=_,s==_){s="";continue}if("\n"!=_)continue;s=""}if(!$&&('"'==_||"'"==_)){s=_,n+=_,r+=_;continue}if(" "==_&&d+1<f&&(" "==programText[d+1]||"	"==programText[d+1])){$&&(r+="&nbsp;",n+=" ");continue}if(0==a){if("\n"==_){l=!1;continue}if(" "==_)continue;if("/"==_||";"==_){a=11,$=!0,r+='<span class="comment">',r+=_,n+=_;continue}for(var p=""+_,u=1;d+u<f&&programText[d+u]>" "&&(p+=programText[d+u],":"!=programText[d+u]);)++u;":"!=programText[d+u]&&(r+="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",n+="      ",a=5)}for(;a<5&&" "==_&&programText[d+1]>" ";)n+=" ",r+="&nbsp;",++a;if("\n"==_)programHTML+='<div id="lin'+t+'" class="selectable"><span class="line">',++t,e<10&&(programHTML+="&nbsp;",programEdit+=" "),e<100&&(programHTML+="&nbsp;",programEdit+=" "),programHTML+=e+"|</span>"+r,$&&(programHTML+="</span>"),programEdit+=e+"|",++e,programHTML+="</div>",r="",programEdit+=n+"\n",programSave+=n+"\r\n",n="",a=0,$=!1,l=!1;else{if(++a,!$&&("/"==_||";"==_)){$=!0;var m=programText[d-1];(" "==m||"	"==m)&&(r=";"==r[r.length-1]?r.slice(0,-6):r.slice(0,-1),n=n.slice(0,-1));var c=do_count(n);if(c>=comment_align)n+=" ",r+="&nbsp;";else for(;c<comment_align;)r+="&nbsp;",n+=" ",++c;r+='<span class="comment">'}"&"==_?r+="&amp;":"<"==_?r+="&lt;":">"==_?r+="&gt;":r+=_,n+=_}}}resetProgramArea(programHTML)}function assemble(){if(!waitingForInput){reset2();for(var e=0;e<maxUsableMem;e+=4)setAddress(e,0);var t=[],a=programText.length;"\n"!=programText[a-1]&&(programText+="\n",++a);var r=0;byteCount=0,dotDataAddress=-1,firstDataDefn=-1;var n=0,$="",s="",o=[],l=[],f=[],d=!1,u=!1,_=!1,c=!1,p=!1,m=1;addrToLine=[],lineToByteAddress=[];for(var g=!1,x=0;x<a;++x){var b=programText[x];if("\r"!=b){if(!1==g){for(g=!0,e=x;e<a;++e){if("|"==programText[e]){x=e;break}if(" "!=programText[e]&&"	"!=programText[e]&&(programText[e]<"0"||programText[e]>"9")){e=-1;break}}if(x==e)continue}if(!d||"\n"==b){if("	"==b&&(b=" "),p){if("\n"==b){message("Closing quotes missing at line "+(r+m)),showError(r+m);return}if("\\"==s){$+=b,s="";continue}if($+=b,s=b,b!=$[0])continue;f[r]=$,$="",++n,p=!1;continue}if("/"==b||";"==b){d=!0;continue}if(","==b)u=!0;else if(u){if(" "==b)continue;u=!1}if(":"==b){if(0!=n){o[r]?message("cannot have two labels at one address at line "+(r+m)):message("label must be first item at line "+(r+m)),showError(r+m);return}var e,v,y=RegExp("^(r([0-9]|1[0-5])|pc|lr|sp)$"),R=y.test($.toLowerCase());if(R){message("cannot use a register as a label  at line "+(r+m)),showError(r+m);return}if(R=(y=RegExp("^(ret|rfe|halt|hlt|svc)$")).test($.toLowerCase())){message("cannot use "+$+" as a label at line "+(r+m)),showError(r+m);return}if(!RegExp("^[a-zA-Z_][0-9a-zA-Z_]*$").test($)){message("bad character in label at line "+(r+m)),showError(r+m);return}for(v=0;v<r&&$!=o[v];++v);if(v<r){message("duplicate label at lines "+t[v]+" and "+(r+m)+" &nbsp;"+$),showError(r+m);return}if(-1!=matchDotLabel($)){message("invalid label at line "+(r+m)+" &nbsp;"+$),showError(r+m);return}o[r]=$,_=!0,c=!0,$="",++n;continue}if(_){if(" "==b)continue;if("\n"==b){(c||d)&&(++m,c=!1),d=!1,g=!1;continue}if("."==b&&x<a-5&&".DATA"==programText.substring(x,x+5).toUpperCase()){dotDataAddress=byteCount,d=!0,x+=4,c=!1;continue}_=!1,c=!1}if(" "==b||"\n"==b){if(".DATA"==$.toUpperCase()){if(-1!=dotDataAddress){message("cannot have more than one .data"),showError(r+m);return}dotDataAddress=byteCount,$="","\n"==b?(++m,g=!1):d=!0;continue}""!=$&&(0==n&&(o[r]=0,++n),1==n&&(200>instruction($.toUpperCase())?l[r]=$.toUpperCase():(l[r]=".WORD",++n)),2==n?f[r]=$:n>2&&(f[r]+=$),$="",++n)}if(2==n&&""==$&&('"'==b||"'"==b)){$=b,p=!0;continue}if("\n"==b){if(n>0){1==n&&(l[r]=0),n<3&&(f[r]=0),n=0;var h=getLen(l[r],f[r],byteCount);if(-2==h){message("bad ascii string at line "+(r+m)),showError(r+m);return}if(h<-1){message("bad .block or .align count at line "+(r+m)),showError(r+m);return}h<0&&(3&byteCount)!=0&&(byteCount=(268435452&byteCount)+4),(3&byteCount)==0&&(addrToLine[byteCount/4]=r+m),t[r]=r+m,lineToByteAddress[r]=byteCount,++r,h>=0?byteCount+=h:byteCount+=4}else d&&++m;d=!1,g=!1}b>" "&&($+=b)}}}if(n&&(1!=n?debug&&alert("Simulator bug - wordCount = "+n):(l[r]=".WORD",f[r]=0,t[r]=r+m-1,lineToByteAddress[r]=byteCount,++r)),byteCount>=maxUsableMem){message("program too long - found "+Math.floor((byteCount+3)/4)+" words. Max is "+maxUsableMem),showError(r+m);return}-1==dotDataAddress&&(dotDataAddress=-1==firstDataDefn?byteCount:firstDataDefn);for(var B=0,C=!1;B<r;){var I=instruction(l[B]);if(200==I){C="unknown instruction at line "+X(B,l[B]);break}var L=instKey[I],k=inst1[I];if(f[B]){if('"'==f[B][0]||"'"==f[B][0]){if((4096&L)==0){C="syntax error at line "+X(B,l[B]);break}for(var e=1,S=0;e<f[B].length&&f[B][e]!=f[B][0];){var A=f[B].charCodeAt(e);"\\"==f[B][e]&&(++e,A="n"==f[B][e]?10:"r"==f[B][e]?13:"t"==f[B][e]?8:f[B].charCodeAt(e)),setAddressByte(lineToByteAddress[B]+S,A),++e,++S}if(f[B][e]!=f[B][0]){C="bad string at line "+X(B,l[B]);break}if(f[B].length>e+1){C="syntax error at line "+X(B,l[B]);break}29==I?setAddressByte(lineToByteAddress[B]+S,0):--S,setData(t[B],"0x"+padHex(lineToByteAddress[B],5)+"-0x"+padHex(lineToByteAddress[B]+S,5)),++B;continue}if("{"==f[B][0]){if(22!=I&&23!=I){C="syntax error at line "+X(B,l[B]);break}for(var e=1;e<f[B].length;++e){if("}"==f[B][e]){f[B].length>e+1&&(C="syntax error at line "+X(B,l[B]));break}if(" "!=f[B][e]&&","!=f[B][e]){var T=2;f[B][e+2]>="0"&&f[B][e+2]<="9"&&++T;var M=regDecode(f[B].substring(e,e+T));if(e>f[B].length-T||M>15||"-"!=f[B][e+T]&&","!=f[B][e+T]&&" "!=f[B][e+T]&&"}"!=f[B][e+T]){C="syntax error at line "+X(B,l[B]);break}if("-"!=f[B][e+T])e+=T-1,k|=1<<M;else{e+=T+1,T=2,f[B][e+2]>="0"&&f[B][e+2]<="9"&&++T;var D=regDecode(f[B].substring(e,e+T));if(e>f[B].length-T||D>15||","!=f[B][e+T]&&" "!=f[B][e+T]&&"}"!=f[B][e+T]||M>D){C="syntax error at line "+X(B,l[B]);break}for(e+=T-1;M<=D;)k|=1<<M,++M}}}if(C)break}else{var E=f[B].indexOf(",",0),v=0;if(-1==E){var w=regDecode(f[B]);if(21==w){if((1024&L)==0||isNaN(v=parseIntGen(f[B]))||v>4294967295||v<-4294967296){C="syntax error at line "+X(B,l[B]);break}if(27==I){if(v>255||v<0){C="illegal byte value at line "+X(B,"");break}setAddressByte(lineToByteAddress[B],v),setData(t[B],"0x"+padHex(lineToByteAddress[B],5)),++B;continue}if(19==I){if(v<=0||v+lineToByteAddress[B]>maxUsableMem){C="illegal .block count "+X(B,"");break}for(var e=0;e<v;++e)setAddressByte(lineToByteAddress[B]+e,0);setData(t[B],"0x"+padHex(lineToByteAddress[B],5)+"-0x"+padHex(lineToByteAddress[B]+v-1,5)),++B;continue}if(35==I){++B;continue}k+=v}else if(20==w){var F=f[B].substring(0,1);if((128&L)==0||"#"==F){C="syntax error at line "+X(B,l[B]);break}if("."==F){var O=matchDotLabel(f[B]);if(-1!=O&&0==k)k=2147483648&O?O:dotLabelValues[O];else if(-1!=(O=getColourVal(f[B]))&&0==k)k=O;else{if(1==f[B].length)v=0;else{F=f[B].substring(1,2);var P=f[B].substring(2,3);if(v=parseIntGen(f[B].substring(2)),"+"!=F&&"-"!=F||P<"0"||P>"9"||isNaN(v)){C="bad address offset at line "+X(B,"");break}"-"==F&&(v=-v)}var V=(lineToByteAddress[B]>>2)+v;if(V<0||V>=maxUsableMem/4){C="bad address offset at line "+X(B,"");break}if(0==k)k=4*V;else{var N=v-2;if(N<-8388607||N>8388607){C="bad address offset at line "+X(B,"");break}k+=16777215&N}}}else{for(v=0;v<r&&f[B]!=o[v];++v);if(v>=r){C="unknown address label at line "+X(B,"");break}if(0==k)k=lineToByteAddress[v];else{if((3&lineToByteAddress[v])!=0){C="unaligned address at line "+X(B,l[B]);break}var V=(lineToByteAddress[v]>>2)-(lineToByteAddress[B]>>2)-2;if(V<-8388607||V>8388607){C="address out of range at line "+X(B,"");break}k+=16777215&V}}}else{C="syntax error at line "+X(B,l[B]);break}}else{var U=f[B].indexOf(",",E+1),M=regDecode(f[B].substring(0,E));if("["==f[B].substring(E+1,E+2)&&(U=-1),-1==U){var D=regDecode(f[B].substring(E+1));if(M>15){C="syntax error at line "+X(B,l[B]);break}if(D<16){if((2&L)==0){C="syntax error at line "+X(B,l[B]);break}2==I&&(M*=16),k+=(M<<12)+D}else if(21==D){if(!isNaN(v=parseIntGen(f[B].substring(E+1)))&&v>=2147483648&&(v-=4294967296),(16&L)!=0&&!isNaN(v)&&v<maxUsableMem){if((3&v)!=0&&(14==I||15==I)){C="Unaligned access at line "+X(B,l[B]);break}if((v-=lineToByteAddress[B]+8)>4095||v<-4095){C="range error at line "+X(B,l[B]);break}v>=0?k+=8388608+v:k+=-v,k+=M<<12}else{C="syntax error at line "+X(B,l[B]);break}}else if(20==D){var F=f[B].substring(E+1,E+2);if("#"==F){if((4&L)==0){C="syntax error at line "+X(B,l[B]);break}if((F=f[B].substring(E+2,E+3))>="0"&&F<="9"||"+"==F||"-"==F){if(-2==(v=checkImm(f[B].substring(E+2)))&&3==I){if(isNaN(v=parseIntGen(f[B].substring(E+2)))){C="syntax error at line "+X(B,l[B]);break}if(v>2147483648&&(v-=4294967296),v<0&&v>=-65535)k=(M<<12)+3810525184+(4095&(v=-v))+(v<<4&983040);else if(v>=0&&v<=65535)k=(M<<12)+3808428032+(4095&v)+(v<<4&983040);else if(v<-33554432||v>33554431||M>=13&&v<0){C="immediate out of range at line "+X(B,l[B]);break}else k=(M<<28)+201326592+(67108863&v)}else{if(v<0){C="syntax error at line "+X(B,l[B]);break}2==I&&(M*=16),k+=(M<<12)+v+33554432}}else{var V,_=f[B].substring(E+2);if("."==_.substring(0,1)){var O=matchDotLabel(_);if(-1!=O)V=2147483648&O?O:dotLabelValues[O];else if(-1==(V=getColourVal(_))){C="unknown dot label at line "+X(B,"");break}}else{for(v=0;v<r&&_!=o[v];++v);if(v>=r||(4&L)==0){C="unknown address label at line "+X(B,"");break}V=lineToByteAddress[v]}if(-2==(v=checkImm(""+V))&&3==I){if(V>2147483648&&(V-=4294967296),V<0&&V>=-65535)k=(M<<12)+3810525184+(4095&(V=-V))+(V<<4&983040);else if(V>=0&&V<=65535)k=(M<<12)+3808428032+(4095&V)+(V<<4&983040);else if(V<-33554432||V>33554431||M>=13&&V<0){C="too many bits in address at line "+X(B,l[B]);break}else k=(M<<28)+201326592+(67108863&V)}else{if(v<0){C="too many bits in address at line "+X(B,l[B]);break}2==I&&(M*=16),k+=(M<<12)+v+33554432}}}else if("["==F){var H=f[B].indexOf("]",E+1),W=f[B].indexOf("+",E+1),z=f[B].indexOf("-",E+1);if(-1==H||(512&L)==0||-1!=W&&-1!=z||f[B].length>H+1){C="syntax error at line "+X(B,l[B]);break}var K=1;-1!=z&&(W=z,K=-1);var q=f[B].indexOf(",",E+1);if(-1!=q&&(-1==W||q<W)&&(W=q),-1!=W&&W>H&&(W=-1),-1==W)D=regDecode(f[B].substring(E+2,H)),v=0;else{D=regDecode(f[B].substring(E+2,W)),"#"==(F=f[B].substring(W+1,W+2))?(++W,("+"==(F=f[B].substring(W+1,W+2))||"-"==F)&&(++W,F=f[B].substring(W+1,W+2))):"-"==F&&++W;var G=regDecode(f[B].substring(W+1,H));if(21==G){if(v=parseIntGen(f[B].substring(W+1,H)),isNaN(v)||v<0||v>4095){C="syntax error at line "+X(B,l[B]);break}}else if(20==G){var _=f[B].substring(W+1,H),O=matchDotLabel(_);if(-1!=O)v=2147483648&O?O:dotLabelValues[O];else{for(v=0;v<r&&_!=o[v];++v);if(v>=r){C="unknown address label at line "+X(B,"");break}v=lineToByteAddress[v]}if(-1==K){C="cannot subtract a label at line "+X(B,"");break}if(v>4294963200&&(K=-1,v=4294967296-v),isNaN(v)||v<0||v>4095){C="label out of range at line "+X(B,l[B]);break}}else{if(G>15||G<0){C="unknown 2nd indirect register at line "+X(B,"");break}v=G,k+=33554432}}if(D>15){C="unknown indirect register at line "+X(B,"");break}if(v>4095||v<0){C="problem with offset calculation at line "+X(B,"");break}k=(4293918720&k)+(D<<16)+(M<<12)+v,K>0&&(k+=8388608)}else{var F=f[B].substring(E+1,E+2);if((16&L)==0||"#"==F){C="syntax error at line "+X(B,l[B]);break}var _=f[B].substring(E+1),O=matchDotLabel(_);if(-1!=O){if(2147483648&O){if(v=O,14!=I&&15!=I){C="bad I/O address for operation at line "+X(B,"");break}}else{v=dotLabelValues[O];var j=dotLabelMode[O];if(14==I?j&=4:15==I?j&=1:25==I?j&=8:26==I?j&=2:j=0,0==j){C="bad I/O address for operation at line "+X(B,"");break}}v>2147483648&&(v-=4294967296)}else{for(v=0;v<r&&_!=o[v];++v);if(v>=r){C="unknown address label at line "+X(B,"");break}if(isNaN(v=lineToByteAddress[v])||v<0||v>=maxUsableMem){C="label out of range at line "+X(B,l[B]);break}}if((4194304&k)==0&&(3&v)!=0){C="label not word aligned at line "+X(B,l[B]);break}if((v-=lineToByteAddress[B]+8)<-4095||v>4095){C="label out of range at line "+X(B,l[B]);break}v>=0?k+=8388608+v:k+=-v,k+=M<<12}}else{C="unknown problem at line "+X(B,"");break}}else{var D=regDecode(f[B].substring(E+1,U)),G=regDecode(f[B].substring(U+1));if(D>15){C="2nd parameter not a valid register at line "+X(B,"");break}if(G<16){if((256&L)==0){C="syntax error at line "+X(B,l[B]);break}(266338304&(k+=M<<12))==27262976?k+=(G<<8)+16+D:k+=(D<<16)+G}else if(20==G&&"#"==f[B].substring(U+1,U+2)){if((2056&L)==0){C="syntax error at line "+X(B,l[B]);break}if((F=f[B].substring(U+2,U+3))>="0"&&F<="9")v=checkImm(f[B].substring(U+2));else{for(v=0;v<r&&f[B].substring(U+2)!=o[v];++v);if(v>=r){C="unknown address label at line "+X(B,"");break}if(-1==(v=checkImm(""+lineToByteAddress[v]))){C="too many bits in address at line "+X(B,l[B]);break}}if(-1==v){C="syntax error at line "+X(B,l[B]);break}if((8&L)==0){if((96&k)==0||(96&k)==96){if(0==v||v>31){C="immediate must be 1-31 at line "+X(B,l[B]);break}}else{if(0==v||v>32){C="immediate must be 1-32 at line "+X(B,l[B]);break}32==v&&(v=0)}}if(v<0){C="immediate more than 8 bits at line "+X(B,l[B]);break}(266338304&(k+=M<<12))==27262976?k+=(v<<7)+D:k+=(D<<16)+v+33554432}else{C="syntax error at line "+X(B,l[B]);break}}}}}else if((1&L)==0){C="parameters needed at line "+X(B,l[B]);break}(3&lineToByteAddress[B])!=0&&debug&&alert("issue: line "+B+" badly aligned "+lineToByteAddress[B]),setAddress(lineToByteAddress[B],k),setCode(t[B],"0x"+padHex(lineToByteAddress[B],5)),++B}if(C){for(var Q=Math.floor((byteCount+3)/4),e=0;e<=Q;++e)setAddress(4*e,0);byteCount=0,message(C),showError(t[B])}else updateR(13,maxUsableMem),message("Program assembled. Run or Step to execute")}function X(e,a){return".WORD"==a&&(a=""),""!==a&&(a=" "+a),t[e]+a}}function convert2(e){return 4*e>=byteCount?"unknown (PC=0x"+padHex(4*e,5)+")":addrToLine[e]}function regDecode(e){if("PC"==e||"pc"==e)return 15;if("SP"==e||"sp"==e)return 13;if("LR"==e||"lr"==e)return 14;if(2==e.length&&("R"==e[0]||"r"==e[0])){var t=e[1]-"0";if(t>=0&&t<10)return t}if(3==e.length&&("R"==e[0]||"r"==e[0])&&"1"==e[1]){var t=e[2]-"0";if(t>=0&&t<6)return t+10}return isNaN(e)?20:21}function checkImm(e){var t=parseIntGen(e);if(isNaN(t))return -1;if(t<0&&(t+=4294967296)<0)return -2;if((4294967040&t)==0)return 255&t;for(var a=0;++a<16;){var r=t>>30&3;if(t<<=2,(4294967040&(t|=r))==0)return(255&t)+(a<<8)}return -2}function parseIntGen(e){var t=1,a=10;if(0==e.length||("-"==e[0]?(t=-1,e=e.substring(1)):"+"==e[0]&&(e=e.substring(1)),0==e.length||e[0]<"0"||e[0]>"9")||(e.length>2&&"0"==e[0]&&(e=e.substring(1)),"b"==e[0]||"B"==e[0]?(a=2,e=e.substring(1)):("x"==e[0]||"X"==e[0])&&(a=16,e=e.substring(1)),0==e.length))return NaN;for(var r=0;r<e.length;){if(e[r]<"0")return NaN;if(2==a){if(e[r]>"1")return NaN}else if(10==a){if(e[r]>"9")return NaN}else if(e[r]>"9"&&e[r]<"A"||e[r]>"F"&&e[r]<"a"||e[r]>"f")return NaN;++r}return t*parseInt(e,a)}function decodeImm(e){var t=e>>8&15;for(e&=255;t>0;){var a=3&e;e=e>>2&1073741823,e|=a<<30,--t}return e}function updatePC(e){for(;e<0;)e+=4294967296;for(;e>=maxUsableMem;)e-=maxUsableMem;pCounter=e,0==dontDisplay&&updateRDisplay(15,e)}function updateR(e,t){if(15==e){updatePC(t);return}if(e>=0&&e<15){for(;t<0;)t+=4294967296;for(;t>4294967295;)t-=4294967296;register[e]=t,0==dontDisplay&&updateRDisplay(e,t)}}var instructions=["ADD","SUB","CMP","MOV","AND","ORR","EOR","LSR","LSL","B","BEQ","BNE","BLT","BGT","LDR","STR","HALT","MVN","RFE",".BLOCK",".WORD","BL","PUSH","POP","RET","LDRB","STRB",".BYTE",".ASCII",".ASCIZ","ADDS","SUBS","BCS","BVS","BMI",".ALIGN","SVC","ASR","ROR","RRX","LSRS","LSLS","ASRS","RORS","RRXS","BIS","XOR","OR","JMS","HLT","ASL","ASLS"],instKey=[264,264,6,6,264,264,264,2304,2304,128,128,128,128,128,528,528,1,6,1,1024,1153,128,64,64,1,528,528,1024,4096,4096,264,264,128,128,128,1024,1025,2304,2304,2,2304,2304,2304,2304,2],inst1=[3766484992,3762290688,3780116480,3785359360,3758096384,3783262208,3759144960,3785359392,3785359360,3925868544,167772160,436207616,3120562176,3388997632,3844014080,3842965504,3774873712,3789553664,4173138432,0,0,3942645760,3912040448,3904700416,3785420814,3848208384,3847159808,0,0,0,3767533568,3763339264,704643072,1778384896,1241513984,0,4009754624,3785359424,3785359456,3785359456,3786407968,3786407936,3786408e3,3786408032,3786408032];function instruction(e){for(var t=0;t<52&&e!=instructions[t];++t);return t<45?t:45==t?5:46==t?6:47==t?5:48==t?21:49==t?16:50==t?8:51==t?41:200}function getLen(e,t,a){var r=instruction(e);if(19==r){-1==firstDataDefn&&(firstDataDefn=a);var n=parseIntGen(t);return isNaN(n)||n<=0||n+a>maxUsableMem?-3:n}if(35==r){var n=parseIntGen(t);return isNaN(n)||n<=0||n>268435455?-3:(0==a%n?n=a:n+=a-a%n,n>maxUsableMem)?-3:n-a}if(r<27||r>29)return 20==r&&-1==firstDataDefn&&(firstDataDefn=a),-1;if(27==r)return -1==firstDataDefn&&(firstDataDefn=a),1;if('"'!=t[0]&&"'"!=t[0])return debug&&alert("Bad call to getLen, offset = "+t),-2;for(var $=1,s=0;$<t.length&&t[$]!=t[0];)"\\"==t[$]&&++$,++$,++s;return t[$]!=t[0]?(debug&&alert("Bad call to getLen, offset = "+t),-2):28==r?s:29==r?s+1:(debug&&alert("Bad call to getLen, inst = "+r+" i = "+$),-1)}var savOpenAddress=!1;function openAddress(e){!waitingForInput&&(myTimeout||myMaybe||(evPush("A"+e.id),message("Modifying memory contents"),openAddressToEdit(e),waitingForInput=!0,savOpenAddress=e,setStateEdit()))}function pixelInt(e){if("p"!=e.id[0]){debug&&alert("Bad pixel click decode");return}if((1&pixelMask)!=0&&IOVectors[4]>=0)interruptRequest|=4;else if((2&pixelMask)!=0)pixelMask|=4;else{lastPixelClick=parseInt(e.id.substring(1)),debug&&alert("Pixel click when not enabled "+lastPixelClick);return}lastPixelClick=parseInt(e.id.substring(1))}function checkInput(e){if(!waitingForInput||(3==memOpt&&(e=e.replace(" ","")),""==e))return!1;var t=parseIntGen(e);return!isNaN(t)&&!(t>4294967295)&&!(t<-2147483648)}function addressSubmit(){if(!waitingForInput){debug&&alert("Bad input - not waiting for input");return}var e=getAddressValue();if(""==e){message("Bad input - must be a number");return}var t=parseIntGen(e);if(isNaN(t)||t>4294967295||t<-2147483648){message("Bad number format or value");return}document.getElementById("aForm").removeAttribute("onblur");var a=parseInt(savOpenAddress.id[1]);savOpenAddress.id.length>=3&&(a=10*a+parseInt(savOpenAddress.id[2])),savOpenAddress.id.length>=4&&(a=10*a+parseInt(savOpenAddress.id[3])),5==savOpenAddress.id.length&&(a=10*a+parseInt(savOpenAddress.id[4])),setAddress(4*(a+=64*overlay),t),waitingForInput=!1,setStateReady(),savOpenAddress=!1,""==programText?message("LOAD or EDIT a program"):message("RUN/STEP your program or LOAD/EDIT a program")}function loseAddress(e){if(waitingForInput){if(checkInput(e.value))addressSubmit();else{resetAddressInput();var t=parseInt(savOpenAddress.id[1]);savOpenAddress.id.length>=3&&(t=10*t+parseInt(savOpenAddress.id[2])),savOpenAddress.id.length>=4&&(t=10*t+parseInt(savOpenAddress.id[3])),5==savOpenAddress.id.length&&(t=10*t+parseInt(savOpenAddress.id[4])),setAddress(4*(t+=64*overlay),address[t]),waitingForInput=!1,setStateReady(),savOpenAddress=!1,message("BAD input ignored")}}}function setAddressByte(e,t){var a=255<<(3&e)*8,r=address[Math.floor(e/4)]&(4294967295^a);setAddress(268435452&e,t<<(3&e)*8&a|r)}function setAddress(e,t){if(isNaN(t)){debug&&alert("attempt to store NaN at "+e);return}if(e<0||e>=maxUsableMem){debug&&alert("store at bad address "+e);return}if((3&e)!=0){debug&&alert("store at unaligned address "+e+" caller should trap this");return}for(e/=4;t<0;)t+=4294967296;for(;t>4294967295;)t-=4294967296;if(address[e]=t,1!=dontDisplay){var a=64*overlay;!(e<a)&&((e-=a)>=128||updateDisplayedMemory(e,t))}}function step3(){evStep(),oneStep=!0,speed=11,1==dontDisplay?(myMaybe&&clearTimeout(myMaybe),myMaybe=!1,dontDisplay=0,rewriteMemoryAndRegs(!1)):(myTimeout&&clearTimeout(myTimeout),myTimeout=!1),run2(),setValue("counter",""+instructionCount)}function runSlow(){if(myTimeout){speed=Math.floor((speed+2)/2);return}if(0==pCounter&&0==address[0]){message("No program to run");return}evPush("Slw"),oneStep=!1,speed=slowSpeed,setStateSlow(),1==dontDisplay?(myMaybe&&clearTimeout(myMaybe),myMaybe=!1,dontDisplay=0,rewriteMemoryAndRegs(!1),waitingForInput||(myTimeout=delay(speed,"runContinue"))):run2()}function run(){if(!waitingForInput&&!myMaybe){if(myTimeout&&(clearTimeout(myTimeout),myTimeout=!1),evPush("Rn"),0==pCounter&&0==address[0]){message("No program to run");return}oneStep=!1,measureSpeed=instructionCount,setValue("counter","0"),runTimer=getMilliseconds(),speed=1,setStateRunning(),message(""),dontDisplay=1,removeCodeHighlight(),removeMemHighlight(),clearIR(),myMaybe=delay(delayTime,"maybeRunContinue"),run2()}}function run2(){waitingForInput||(stopping=!1,noKeyEffects=!0,IEKeyEnable(),runContinue())}function runContinuey(){1==dontDisplay&&(myMaybe&&clearTimeout(myMaybe),myMaybe=!1,dontDisplay=0,rewriteMemoryAndRegs(!1)),running=!1,setStatePaused(),noKeyEffects=!1,message(halted),myTimeout=!1}function runContinuez(){if(waitingForInput)myTimeout=delay(speed,"runContinuez"),fileResult>=20&&(fileResult-=20,document.getElementById("read-file").click());else{if(lastKey=0,breakpointAddr==pCounter){myMaybe&&alert("BUG - myMaybe"),dontDisplay&&(dontDisplay=0,rewriteMemoryAndRegs(!1),message(lastMessage),4*lineNo<byteCount&&showExecuteStop(addrToLine[lineNo]),setMemHighlight(4*lineNo),setValue("counter",""+instructionCount)),message("Breakpoint detect at PC = 0x"+padHex(pCounter,5)),running=!1,setStatePaused(),noKeyEffects=!1;return}message(stepTxt),1==speed&&!1==oneStep?(message(""),dontDisplay=1,clearIR(),maybeWaiting=0,myMaybe=delay(delayTime,"maybeRunContinue"),runContinue()):myTimeout=delay(speed,"runContinue")}}function badStack(){var e=(4294967292&register[13])-4;return(e>=maxUsableMem||e<0)&&(1==dontDisplay&&(myMaybe&&clearTimeout(myMaybe),myMaybe=!1,dontDisplay=0,rewriteMemoryAndRegs(!1)),message("Bad SP value on interrupt"),running=!1,setStatePaused(),noKeyEffects=!1,!0)}function doClockInt(){if(xTime=0,0!=clockIntFreq&&!(IOVectors[3]<0)&&(3&IOVectors[3])==0&&!(IOVectors[3]>=maxUsableMem)){interruptMask&=4294967294;var e=(4294967292&register[13])-4;setAddress(e,flags<<28|1),setAddress(e-=4,pCounter),updateR(13,e),updatePC(IOVectors[3]),message("Accepted interrupt from the timer")}}function doInterrupt(){if(!0&++interruptCnt||0==xTime||xTime>=Date.now()){var e=(4294967292&register[13])-4;if((1&interruptRequest)!=0&&(1&pinMask)!=0&&IOVectors[1]>=0&&(3&IOVectors[1])==0&&IOVectors[1]<maxUsableMem){interruptMask&=4294967294,interruptRequest&=4294967294,setAddress(e,flags<<28|1),setAddress(e-=4,pCounter),updateR(13,e),updatePC(IOVectors[1]),message("Accepted interrupt from the push button");return}if((2&interruptRequest)!=0&&(1&keyboardMask)!=0&&IOVectors[2]>=0&&(3&IOVectors[2])==0&&IOVectors[2]<maxUsableMem){interruptMask&=4294967294,interruptRequest&=4294967293,setAddress(e,flags<<28|1),setAddress(e-=4,pCounter),updateR(13,e),updatePC(IOVectors[2]),message("Accepted interrupt from the keyboard");return}if((4&interruptRequest)!=0&&(1&pixelMask)!=0&&IOVectors[4]>=0&&(3&IOVectors[4])==0&&IOVectors[4]<maxUsableMem){interruptMask&=4294967294,interruptRequest&=4294967291,setAddress(e,flags<<28|1),setAddress(e-=4,pCounter),updateR(13,e),updatePC(IOVectors[4]),message("Accepted interrupt from the pixel click");return}}xTime&&xTime<Date.now()&&doClockInt()}var myMaybe=0,maybeWaiting=0;function maybeRunContinue(){if(0==myMaybe&&debug&&alert("myMaybe == 0 should not happen"),0==maybeWaiting){myMaybe=0;return}maybeWaiting=0,myMaybe=delay(delayTime,"maybeRunContinue"),runContinue()}var DC=[4e3,750,750,300,100,40,20,10,5,2,1];function runContinue(){if(myTimeout=!1,stopping){if(1==dontDisplay){myMaybe&&clearTimeout(myMaybe),myMaybe=!1,dontDisplay=0,rewriteMemoryAndRegs(!1),4*lineNo<byteCount&&showExecuteStop(addrToLine[lineNo]),setMemHighlight(4*lineNo),setValue("counter",""+instructionCount);var e=Math.floor((measureSpeed=instructionCount-measureSpeed)/(runTimer=getMilliseconds()-runTimer)/10),t=Math.floor(runTimer/100);2!=step1Code&&message("Program paused. "+measureSpeed+" ins in "+t/10+" secs, "+e/100+"M ins/sec")}else oneStep?2!=step1Code&&message(stepTxt):2!=step1Code&&message("Program paused. RUN or STEP to continue, STOP to abort.");running=!1,setStatePaused(),noKeyEffects=!1;return}if(oneStep&&(stopping=!0),(1&interruptMask)!=0&&(0!=interruptRequest||xTime&&xTime<Date.now())){if(badStack())return;doInterrupt()}if(step1Code=0,0==dontDisplay){var a=Math.floor(pCounter/4);if(4*a<byteCount&&showExecuteStop(addrToLine[a]),setMemHighlight(pCounter),!step1(1)&&breakpointAddr!=pCounter){message(stepTxt),setValue("counter",""+instructionCount),myTimeout=delay((speed-10)*4,"runContinue");return}if(setValue("counter",""+instructionCount),waitingForInput){myTimeout=delay(speed,"runContinuez");return}breakpointAddr==pCounter&&message("Breakpoint detect at PC = 0x"+padHex(pCounter,5)),running=!1,setStatePaused(),noKeyEffects=!1;return}if(step1(751)){if(breakpointAddr==pCounter&&5==step1Code&&(step1Code=2),step1Code<3){myMaybe&&clearTimeout(myMaybe),myMaybe=!1,dontDisplay=0,rewriteMemoryAndRegs(!1),message(lastMessage),2==step1Code&&message("Stopped on Breakpoint at PC = 0x"+padHex(pCounter,5)),4*lineNo<byteCount&&showExecuteStop(addrToLine[lineNo]),setMemHighlight(4*lineNo),setValue("counter",""+instructionCount),running=!1,setStatePaused(),noKeyEffects=!1;return}if(waitingForInput){myMaybe&&clearTimeout(myMaybe),myMaybe=!1,dontDisplay=0,rewriteMemoryAndRegs(!1),message(lastMessage),setValue("counter",""+instructionCount),myTimeout=delay(speed,"runContinuez");return}}maybeWaiting=1,0==myMaybe&&debug&&alert("myMaybe == 0 - interlock went wrong"),setValue("counter",""+instructionCount),1!=speed&&(dontDisplay=0,rewriteMemoryAndRegs(!1),dontDisplay=1)}function stop(){evPush("Ps"),stopping=!0}function stop2(){myMaybe&&clearTimeout(myMaybe),myMaybe=!1,myTimeout&&clearTimeout(myTimeout),myTimeout=!1,running=!1,noKeyEffects=!1,fileResult=-1,consoleReset(),removeCodeHighlight(),removeMemHighlight(),removeError()}function reset1(){evPush("Stp"),reset2(),message("Stop done, edit &amp; Submit, RUN/STEP or alter memory")}function reset2(){if(dontDisplay=0,stop2(),updateR(0,0),updateR(1,0),updateR(2,0),updateR(3,0),updateR(4,0),updateR(5,0),updateR(6,0),updateR(7,0),updateR(8,0),updateR(9,0),updateR(10,0),updateR(11,0),updateR(12,0),updateR(13,maxUsableMem),updateR(14,0),updatePC(0),updateFlags(0),output1="",clearIR(),lastKey=0,savOpenAddress){var e=parseInt(savOpenAddress.id[1]);savOpenAddress.id.length>=3&&(e=10*e+parseInt(savOpenAddress.id[2])),savOpenAddress.id.length>=4&&(e=10*e+parseInt(savOpenAddress.id[3])),5==savOpenAddress.id.length&&(e=10*e+parseInt(savOpenAddress.id[4])),setAddress(4*(e+=64*overlay),address[e]),waitingForInput=!1,savOpenAddress=!1}modifyingProgram&&(modifyingProgram=!1,textToHtml(),waitingForInput=!1,removeClass("program","edit")),waitingForInput&&(waitingForInput=!1),clearInputArea(),interruptRequest=0,interruptMask=0,keyboardMask=0,pinMask=0,clockIntFreq=0,pixelMask=0,IOVectors[0]=-1,IOVectors[1]=-1,IOVectors[2]=-1,IOVectors[3]=-1,IOVectors[4]=-1,pixelAreaSize=3072,clearPixelArea(),lastPixelClick=-1,instructionCount=0,setValue("counter","0"),rewriteMemoryAndRegs(!1),intButtonReset(),setStateReady()}function clearPixelArea(){setPixelAreaSize(pixelAreaSize);for(var e=pixelAreaSize,t=0;t<e;++t)v1address[t]=16777215;e=charMax/4;for(var t=0;t<e;)v2address[t]=0,++t;for(clearCharMap(),e=(IOBase-charBase)/4;t<e;)v2address[t]=16777215,++t}var startFm=[0,6,0,13,40,19,40,23,27,29,30,38,40,40,40,39],newIValue=[3766484992,3762290688,3758096384,3759144960,3767533568,3763339264,3785359360,3785359392,3785359360,3785359424,3785359456,3785359456,3774873712,3783262208,3785359360,3789553664,3780116480,3810525184,3808428032,3843031040,3841982464,3847225344,3846176768,3876585472,3875536896,3880779776,3879731200,3904700416,4173138432,3912040448,3925868544,167772160,436207616,3120562176,3388997632,704643072,1778384896,1241513984,3942645760,4009754624,201326592,0],newIMask=[4260364288,4260364288,4260364288,4260364288,4260364288,4260364288,4294905840,4293853280,4293853280,4293853280,4293857264,4293853280,4294967295,4260364288,4261347328,4261347328,4260425728,4293918720,4293918720,4285530112,4285530112,4285530112,4285530112,4285530112,4285530112,4285530112,4285530112,4294901760,4294967295,4294901760,4278190080,4278190080,4278190080,4278190080,4278190080,4278190080,4278190080,4278190080,4278190080,4278190080,201326592,0],newINmame=["ADD","SUB","AND","EOR","ADDS","SUBS","MOV","LSR","LSL","ASR","RRX","ROR","HALT","ORR","MOV","MVN","CMP","MOV","MOV","LDR","STR","LDRB","STRB","LDR","STR","LDRB","STRB","POP","RFE","PUSH","B","BEQ","BNE","BLT","BGT","BCS","BVS","BMI","BL","SVC","MOV","ILLEGAL"],newIDecode=[7,7,7,7,7,7,3,5,5,5,5,5,0,7,3,3,4,8,8,2,2,2,2,1,1,1,1,9,0,9,6,6,6,6,6,6,6,6,6,0,10,0];function step1(e){var t,a,r,n,$,s,o,l,f,d,u,_,c,p,m="";if(waitingForInput)return 0;setStateForceRunning();for(var g=0;g<e;++g){for(var x=0;x<201;++x){for(inst=address[lineNo=Math.floor(pCounter/4)],0==dontDisplay?(setIR(padHex(inst,8)),updatePC(pCounter+4)):(pCounter+=4)>=maxUsableMem&&(pCounter=0),++instructionCount,t=startFm[inst>>24&15];t<38&&(inst&newIMask[t])!=(4294967295&newIValue[t]);++t);switch(a=newINmame[t],r="",n=100,$=100,s=NaN,o=1e4,newIDecode[t]){case 0:break;default:debug&&alert("step1() fault on decode "+newIDecode[t]+" "+t),m="emulator fault";case 1:n=inst>>12&15,o=($=inst>>16&15)<15?register[$]:pCounter+4;var b=15&inst;b=b<15?register[b]:pCounter+4,(8388608&inst)!=0?(o+=b,r="&nbsp;Rd,[Rn+Rm]"):(o-=b,r="&nbsp;Rd,[Rn-Rm]"),o>2147483648&&(o-=4294967296),(o<(l=vaddressBase-4294967296)||o>=maxUsableMem)&&(m="bad address");break;case 2:o=4095&inst,n=inst>>12&15,15==($=inst>>16&15)?(r=" Rd,addr",(8388608&inst)!=0?o+=(268435452&pCounter)+4:o=(268435452&pCounter)+4-o):(r="&nbsp;Rd,[Rn+nn]",(8388608&inst)!=0?o+=register[$]:o=register[$]-o),o>2147483648&&(o-=4294967296),(o<(l=vaddressBase-4294967296)||o>=maxUsableMem)&&(m="bad address");break;case 3:n=inst>>12&15,(33554432&inst)!=0?(r=" Rd,#im",s=decodeImm(4095&inst)):(r=" Rd,Rm",s=(15&inst)<15?register[15&inst]:pCounter+4);break;case 4:$=inst>>16&15,(33554432&inst)!=0?(r=" Rn,#im",s=decodeImm(4095&inst)):(r=" Rn,Rm",s=(15&inst)<15?register[15&inst]:pCounter+4);break;case 5:n=inst>>12&15,$=15&inst,(1048576&inst)!=0&&(a+="S"),(16&inst)!=0?(r=" Rd,Rn,Rm",s=(inst>>8&15)<15?register[inst>>8&15]:pCounter+4,(s&=255)>32&&(s=32)):(r=" Rd,Rn,#im",0==(s=inst>>7&31)&&((96&inst)!=0&&(s=32),(96&inst)==96&&(r=" Rd,Rn")));break;case 6:r=" addr",(8388608&(o=16777215&inst))!=0&&(o-=16777216),((o=4*o+pCounter+4)<0||o>maxUsableMem)&&(m="bad address");break;case 7:n=inst>>12&15,$=inst>>16&15,(33554432&inst)!=0?(r=" Rd,Rn,#im",s=decodeImm(4095&inst)):(r=" Rd,Rn,Rm",s=(15&inst)<15?register[15&inst]:pCounter+4);break;case 8:n=inst>>12&15,r=" Rd,#im",s=(4095&inst)+(inst>>4&61440);break;case 9:n=inst>>16&15,s=65535&inst,r=" {regs}";break;case 10:n=inst>>28&15,r=" Rd,#im",s=67108863&inst,(33554432&inst)!=0&&(s|=4227858432),n>=13&&((3&s)!=0||s<0||s>maxUsableMem)&&(m="bad address")}if(0==dontDisplay&&addIR(a+r),""!=m)return message("Error: "+m+" at line "+convert2(lineNo)),1;switch(t){case 38:updateR(14,pCounter);case 30:updatePC(o);break;case 31:(4&flags)!=0?updatePC(o):r+=" Branch not taken";break;case 32:(4&flags)==0?updatePC(o):r+=" Branch not taken";break;case 33:(9&flags)==8||(9&flags)==1?updatePC(o):r+=" Branch not taken";break;case 34:(4&flags)==0&&((9&flags)==9||(9&flags)==0)?updatePC(o):r+=" Branch not taken";break;case 7:f=$<15?register[$]:pCounter+4,s>0?(d=f>>1&2147483647,s>1&&(d>>=s-1)):d=f,updateR(n,d),(1048576&inst)!=0&&(u=1&flags,0==s?u+=2&flags:(f&1<<s-1)!=0&&(u+=2),(4294967295&d)==0&&(u|=4),(2147483648&d)!=0&&(u|=8),updateFlags(u));break;case 8:f=$<15?register[$]:pCounter+4,updateR(n,d=s>31?0:f<<s),(1048576&inst)!=0&&(u=1&flags,0==s?u+=2&flags:(f<<s-1&2147483648)!=0&&(u+=2),(4294967295&d)==0&&(u|=4),(2147483648&d)!=0&&(u|=8),updateFlags(u));break;case 9:f=$<15?register[$]:pCounter+4,updateR(n,d=s>31?f>>31:f>>s),(1048576&inst)!=0&&(u=1&flags,0==s?u+=2&flags:(f&1<<s-1)!=0&&(u+=2),(4294967295&d)==0&&(u|=4),(2147483648&d)!=0&&(u|=8),updateFlags(u));break;case 10:d=(f=$<15?register[$]:pCounter+4)>>1&2147483647,(2&flags)!=0&&(d+=2147483648),updateR(n,d),(1048576&inst)!=0&&(u=1&flags,(1&f)!=0&&(u+=2),(4294967295&d)==0&&(u|=4),(2147483648&d)!=0&&(u|=8),updateFlags(u));break;case 11:for(f=$<15?register[$]:pCounter+4,d=s;s>31;)s-=32;for(;s>0;)f=(1&f)==0?f>>1&2147483647:(f>>1&2147483647)+2147483648,--s;updateR(n,f),(1048576&inst)!=0&&(u=1&flags,0==d?u+=2&flags:(2147483648&f)!=0&&(u+=2),(4294967295&f)==0&&(u|=4),(2147483648&f)!=0&&(u|=8),updateFlags(u));break;case 12:return step1Code=1,message(halted),1;case 28:if((o=4294967292&register[13])>=maxUsableMem-4||o<0)return message("Bad SP value at line = "+convert2(lineNo)),1;if((d=address[o/4])>=maxUsableMem||d<0)return message("Bad return address at line = "+convert2(lineNo)),1;updatePC(d),o+=4,updateFlags((d=address[o/4])>>28&15),(1&d)!=0&&(interruptMask|=1),updateR(13,o+4),checkClickColour(),checkClockEnabled(),dontDisplay&&(1&interruptMask)!=0&&(0!=interruptRequest||xTime&&xTime<Date.now())&&doInterrupt();break;case 6:case 14:case 18:case 40:if(updateR(n,s),dontDisplay&&3785359360==inst)return step1Code=5,1;break;case 17:updateR(n,4294967296-s);break;case 15:updateR(n,4294967295^s);break;case 16:u=0,(4294967295&(f=($<15?register[$]:pCounter+4)-s))==0&&(u|=4),0!=(_=f>>31&1)&&(u|=8),c=($<15?register[$]:pCounter+4)>>31&1,p=-s>>31&1,0==c?1==p&&0==_&&(u|=2):(1==p||0==_)&&(u|=2),c+p!=1&&c!=_&&(u|=1),updateFlags(u);break;case 23:case 19:if((3&o)!=0)return message("Unaligned access on LDR at line "+convert2(lineNo)),1;if(o<0){if((o+=4294967296)<pixelBase+4*pixelAreaSize&&o>=pixelBase)updateR(n,v1address[(o-pixelBase)/4]);else if(o<IOBase&&o>=charBase)updateR(n,v2address[(o-charBase)/4]);else if(o==dotLabelValues[5])return inputNum(n,0),step1Code=4,stepTxt="Done instruction "+a+r+" at line "+convert2(lineNo),1;else if(o==dotLabelValues[26])return inputNum(n,1),step1Code=4,stepTxt="Done instruction "+a+r+" at line "+convert2(lineNo),1;else if(o==dotLabelValues[6])updateR(n,lastKey);else if(o==dotLabelValues[7])updateR(n,lastKey),lastKey=0;else if(o==dotLabelValues[34])updateR(n,lastPixelClick);else if(o==dotLabelValues[35])updateR(n,lastPixelClick),pixelMask&=4294967291,lastPixelClick=-1;else if(o==dotLabelValues[8])updateR(n,4294967296*Math.random()&4294967295);else if(o==dotLabelValues[9])updateR(n,instructionCount);else if(o==dotLabelValues[10])updateR(n,Math.floor(Date.now()/1e3)-946684800);else if(o==dotLabelValues[11])updateR(n,IOVectors[1]);else if(o==dotLabelValues[12])updateR(n,IOVectors[0]);else if(o==dotLabelValues[13])updateR(n,IOVectors[2]);else if(o==dotLabelValues[14])updateR(n,IOVectors[3]);else if(o==dotLabelValues[33])updateR(n,IOVectors[4]);else if(o==dotLabelValues[15])updateR(n,interruptMask);else if(o==dotLabelValues[16])updateR(n,pinMask);else if(o==dotLabelValues[17])updateR(n,keyboardMask);else if(o==dotLabelValues[18])updateR(n,clockIntFreq);else if(o==dotLabelValues[36])updateR(n,pixelMask);else if(o==dotLabelValues[37])12288==pixelAreaSize?updateR(n,2):3072==pixelAreaSize?updateR(n,1):updateR(n,0);else if(o==dotLabelValues[19])updateR(n,byteCount);else if(o==dotLabelValues[22])return fileRead="",fileResult=n,fileOpen(),waitingForInput=!0,inst=0,step1Code=4,stepTxt="Done instruction "+a+r+" at line "+convert2(lineNo),1;else if(o==dotLabelValues[23])updateR(n,fileRead?fileRead.length:0);else if(o==dotLabelValues[24])fileRead?(updateR(n,fileRead.charCodeAt(0)),fileRead=fileRead.substr(1)):updateR(n,4294967295);else{if(o!=dotLabelValues[28])return message("Bad I/O address for LDR at line "+convert2(lineNo)),1;updateR(n,pixelAreaSize)}}else updateR(n,address[o/4]);break;case 24:case 20:if((3&o)!=0)return message("Unaligned access on STR at line "+convert2(lineNo)),1;if(o>=0&&o<dotDataAddress)return message("Attempt to STR into the code area at line "+convert2(lineNo)),1;if(f=n<15?register[n]:pCounter+4,o<0){if((o+=4294967296)<IOBase&&o>=vaddressBase){var v=(o-vaddressBase)/4;if(v<pixelAreaSize){if(v1address[v]==f)break;v1address[v]=f,videoWrite(v,f)}else if(v=(o-charBase)/4,o>charBase&&v<charMax/4){if(v2address[v]==f)break;v2address[v]=f,showChar(o-=charBase,255&f),showChar(o+1,f>>8&255),showChar(o+2,f>>16&255),showChar(o+3,f>>24&255)}else{if(!(o>=fakeBig))return message("Bad I/O address for STR at line "+convert2(lineNo)),1;v2address[v]=f,v=(o-fakeBig)/2;var y=!0;if(3072==pixelAreaSize?(v+=16777152&v,y=videoProc(y,v,f),y=videoProc(y,++v,f),v+=63,y=videoProc(y,v,f),y=videoProc(y,++v,f)):(v*=2,v+=(268435328&v)*3,y=videoProc(y,v,f),y=videoProc(y,++v,f),y=videoProc(y,++v,f),y=videoProc(y,++v,f),v+=125,y=videoProc(y,v,f),y=videoProc(y,++v,f),y=videoProc(y,++v,f),y=videoProc(y,++v,f),v+=125,y=videoProc(y,v,f),y=videoProc(y,++v,f),y=videoProc(y,++v,f),y=videoProc(y,++v,f),v+=125,y=videoProc(y,v,f),y=videoProc(y,++v,f),y=videoProc(y,++v,f),y=videoProc(y,++v,f)),y)break}x=1e3}else if(o==dotLabelValues[0])outputNum(f,4),x=1e3;else if(o==dotLabelValues[1])outputNum(f,5),x=1e3;else if(o==dotLabelValues[2])outputNum(f,6),x=1e3;else if(o==dotLabelValues[3])outputNum(f,7),x=1e3;else if(o==dotLabelValues[4])outputNum(f,8),x=1e3;else if(o==dotLabelValues[25]||o==dotLabelValues[32]){if(n>14||f<0||f>maxUsableMem-128)return message("Bad address for .ReadString at line "+convert2(lineNo)),1;if(f<dotDataAddress)return message("Attempt to .ReadString into the code area at line "+convert2(lineNo)),1;return o==dotLabelValues[25]?inputNum(n,-1):inputNum(n,-2),step1Code=4,stepTxt="Done instruction "+a+r+" at line "+convert2(lineNo),1}else if(o==dotLabelValues[27])outputNum(f,3),x=1e3;else if(o==dotLabelValues[15]){if(interruptMask=f,checkClickColour(),checkClockEnabled(),dontDisplay&&(1&interruptMask)!=0&&(0!=interruptRequest||xTime&&xTime<Date.now()))return step1Code=3,1}else if(o==dotLabelValues[16])pinMask=f,checkClickColour();else if(o==dotLabelValues[17])keyboardMask=f;else if(o==dotLabelValues[18])clockIntFreq=f,checkClockEnabled();else if(o==dotLabelValues[36]){var R=!1;((3&pixelMask)==0&&(3&f)!=0||(3&pixelMask)!=0&&(3&f)==0)&&(R=!0),pixelMask=f,R&&clearPixelArea()}else if(o==dotLabelValues[37])pixelAreaSize=2==f?12288:3072,v1address=[],clearPixelArea();else if(o==dotLabelValues[28])clearPixelArea();else if(o==dotLabelValues[29])fileWriteBuffer+=String.fromCharCode(255&f),fileWriteBuffer+=String.fromCharCode(f>>8&255),fileWriteBuffer+=String.fromCharCode(f>>16&255),fileWriteBuffer+=String.fromCharCode(f>>24&255);else if(o==dotLabelValues[30]){if(-1==f)fileWriteBuffer=[];else{if(f<0||f>=maxUsableMem)return message("Bad I/O data or address for STR at line "+convert2(lineNo)),1;for(var h="",B=0;B<64;++B){var C=address[Math.floor(f/4)]>>(3&f)*8&255;if(C<32||C>127||(h+=String.fromCharCode(C),++f>=maxUsableMem))break}return saveFile(fileWriteBuffer,h),fileWriteBuffer=[],stepTxt="Done instruction "+a+r+" at line "+convert2(lineNo),0}}else{if(f<0||f>=maxUsableMem||(3&f)!=0)return message("Bad I/O data or address for STR at line "+convert2(lineNo)),1;if(o==dotLabelValues[11])IOVectors[1]=f,checkClickColour();else if(o==dotLabelValues[12])IOVectors[0]=f;else if(o==dotLabelValues[13])IOVectors[2]=f;else if(o==dotLabelValues[14])IOVectors[3]=f,checkClockEnabled();else{if(o!=dotLabelValues[33])return message("Bad I/O address for STR at line "+convert2(lineNo)),1;IOVectors[4]=f}}}else setAddress(o,f);break;case 0:updateR(n,($<15?register[$]:pCounter+4)+s);break;case 1:updateR(n,($<15?register[$]:pCounter+4)-s);break;case 4:u=0,(4294967295&(f=($<15?register[$]:pCounter+4)+s))==0&&(u|=4),0!=(_=f>>31&1)&&(u|=8),c=($<15?register[$]:pCounter+4)>>31&1,p=s>>31&1,0==c?1==p&&0==_&&(u|=2):(1==p||0==_)&&(u|=2),c+p!=1&&c!=_&&(u|=1),updateFlags(u),updateR(n,f);break;case 5:u=0,(4294967295&(f=($<15?register[$]:pCounter+4)-s))==0&&(u|=4),0!=(_=f>>31&1)&&(u|=8),c=($<15?register[$]:pCounter+4)>>31&1,p=-s>>31&1,0==c?1==p&&0==_&&(u|=2):(1==p||0==_)&&(u|=2),c+p!=1&&c!=_&&(u|=1),updateFlags(u),updateR(n,f);break;case 35:(2&flags)!=0?updatePC(o):r+=" Branch not taken";break;case 36:(1&flags)!=0?updatePC(o):r+=" Branch not taken";break;case 37:(8&flags)!=0?updatePC(o):r+=" Branch not taken";break;case 2:updateR(n,($<15?register[$]:pCounter+4)&s);break;case 13:updateR(n,($<15?register[$]:pCounter+4)|s);break;case 3:updateR(n,($<15?register[$]:pCounter+4)^s);break;case 29:for(o=4294967292&register[n],$=15;$>=0;){if(s&1<<$){if(o>maxUsableMem||o<4)return message("Bad SP value at line = "+convert2(lineNo)),1;if((o-=4)<byteCount)return message("Stack overflow error at line = "+convert2(lineNo)),1;15==$?setAddress(o,pCounter+4):setAddress(o,register[$])}--$}updateR(n,o);break;case 27:for(o=4294967292&register[n],$=0;$<16;){if(s&1<<$){if(o>=maxUsableMem||o<0)return message("Bad SP value at line = "+convert2(lineNo)),1;updateR($,address[o/4]),o+=4}++$}updateR(n,o);break;case 25:case 21:if(o<0){if((o+=4294967296)<pixelBase+4*pixelAreaSize&&o>=pixelBase)updateR(n,v1address[Math.floor((o-pixelBase)/4)]>>(3&o)*8&255);else if(o<IOBase&&o>=charBase)updateR(n,v2address[Math.floor((o-charBase)/4)]>>(3&o)*8&255);else if(o==dotLabelValues[6])updateR(n,255&lastKey);else if(o==dotLabelValues[7])updateR(n,255&lastKey),lastKey=0;else{if(o!=dotLabelValues[19])return message("Bad I/O address for LDRB at line "+convert2(lineNo)),1;fileRead?(updateR(n,255&fileRead.charCodeAt(0)),fileRead=fileRead.substr(1)):updateR(n,255)}}else updateR(n,address[Math.floor(o/4)]>>(3&o)*8&255);break;case 26:case 22:if(o>=0&&o<dotDataAddress)return message("Attempt to STRB into the code area at line "+convert2(lineNo)),1;if(f=(n<15?register[n]:pCounter+4)&255,o<0){if((o+=4294967296)<charBase+charMax&&o>=charBase){var I=255<<(3&o)*8,L=f<<(3&o)*8&I,k=Math.floor((o-charBase)/4);v2address[k]&=4294967295^I,v2address[k]|=L,showChar(o-charBase,f),x=1e3}else if(o==dotLabelValues[3])outputNum(f,7),x=1e3;else{if(o!=dotLabelValues[29])return message("Bad I/O address for STRB at line "+convert2(lineNo)),1;fileWriteBuffer+=String.fromCharCode(255&f)}}else setAddressByte(o,f);break;case 39:if((o=(4294967292&register[13])-4)>=maxUsableMem||o<0)return message("Bad SP address for SVC at line "+convert2(lineNo)),1;if(!(IOVectors[0]>=0)||(3&IOVectors[0])!=0||!(IOVectors[0]<maxUsableMem))return message("Bad vector address for SVC at line "+convert2(lineNo)),1;setAddress(o,flags<<28|255&interruptMask),setAddress(o-=4,pCounter),updateR(13,o),updatePC(IOVectors[0]),interruptMask&=4294967294;break;default:return message("Bad instruction at line "+convert2(lineNo)),1}if(breakpointAddr==pCounter)return step1Code=2,1;if(!dontDisplay)return stepTxt="Done instruction "+a+r+" at line "+convert2(lineNo),0}if(xTime&&xTime<Date.now()&&(1&interruptMask)!=0){var o=(4294967292&register[13])-4;if(o>=maxUsableMem||o<0)return stepTxt="Done instruction "+a+r+" at line "+convert2(lineNo),0;doClockInt()}}return stepTxt="Done instruction "+a+r+" at line "+convert2(lineNo),0}function videoProc(e,t,a){return v1address[t]==a?e:(v1address[t]=a,videoWrite(t,a),!1)}function inputNum(e,t){registerToInput=e,waitingForInput=!0,inst=t,noKeyEffects=!1,enableInput(-2==t)}function outputNum(e,t){if(8==t){for(var a;!(e<0)&&!(e>=maxUsableMem)&&0!=(a=address[Math.floor(e/4)]>>(3&e)*8&255);){var r=String.fromCharCode(a);10==a?output1+="\n":a>31&&(output1+=r),++e}justConsole();return}switch(7!=t&&output1.length>0&&" "!=output1[output1.length-1]&&"\n"!=output1[output1.length-1]&&(output1+=" "),t){case 3:if((4294967040&e)==0)output1+="0";else{for(var n=(4294967040&e)/2147483648,$=255&e;$>127;)n/=2,++$,$&=255;for(;$>0;)n*=2,--$;output1+=e=n.toPrecision(6)}break;case 4:e>2147483647?output1+="-"+(e=4294967296-e)+" ":output1+=e+" ";break;case 5:output1+=e+" ";break;case 6:output1+="0x",(4026531840&e)!=0&&(output1+=hex[e>>28&15]),(4278190080&e)!=0&&(output1+=hex[e>>24&15]),(4293918720&e)!=0&&(output1+=hex[e>>20&15]),(4294901760&e)!=0&&(output1+=hex[e>>16&15]),(4294963200&e)!=0&&(output1+=hex[e>>12&15]),(4294967040&e)!=0&&(output1+=hex[e>>8&15]),(4294967280&e)!=0&&(output1+=hex[e>>4&15]),output1+=hex[e%16]+" ";break;case 7:var r=String.fromCharCode(e);10==e?output1+="\n":e>31&&(output1+=r)}justConsole()}function clearCharMap(){for(var e=0;e<charMax;++e)showChar(e,0)}function inputSubmit(){var e=getInput();if(!1!==e){if(!waitingForInput){debug&&alert("Bad input - not waiting for input");return}if(""==e){message("Bad input - must not be empty");return}if(0==inst){if(isNaN(t=parseIntGen(e))||t>4294967295||t<-2147483648){message("Bad number format or value");return}}else if(inst<0){var t,a,r=(t=e).length;if(registerToInput>14||0==r)return;var n=register[registerToInput];if(r>127&&(r=127),n>=0&&n<maxUsableMem-r){for(a=0;a<r;++a)setAddressByte(n,t.charCodeAt(a)),++n;setAddressByte(n,0)}-2==inst?inputRestore(""):inputRestore(e),noKeyEffects=!0,message("String read into memory at "+n),waitingForInput=!1;return}else{var $=parseFloat(e);if(isNaN($)){message("Bad input - must be a floating point number");return}for(var s=0;($>=1||$<-1)&&($/=2,!(++s>127)););for(;$<.5&&$>=-.5&&0!=$&&($*=2,!(--s<-128)););if(s>127){message("Bad input - number out of range");return}t=0==$||s<-128?0:(4294967040&(tmp=2147483648*$))+(255&s)}inputRestore(e),noKeyEffects=!0,updateR(registerToInput,t),waitingForInput=!1}}var coloursNam=[".background",".aliceblue",".antiquewhite",".aqua",".aquamarine",".azure",".beige",".bisque",".black",".blanchedalmond",".blue",".blueviolet",".brown",".burlywood",".cadetblue",".chartreuse",".chocolate",".coral",".cornflowerblue",".cornsilk",".crimson",".cyan",".darkblue",".darkcyan",".darkgoldenrod",".darkgray",".darkgreen",".darkgrey",".darkkhaki",".darkmagenta",".darkolivegreen",".darkorange",".darkorchid",".darkred",".darksalmon",".darkseagreen",".darkslateblue",".darkslategray",".darkslategrey",".darkturquoise",".darkviolet",".deeppink",".deepskyblue",".dimgray",".dimgrey",".dodgerblue",".firebrick",".floralwhite",".forestgreen",".fuchsia",".gainsboro",".ghostwhite",".gold",".goldenrod",".gray",".green",".greenyellow",".grey",".honeydew",".hotpink",".indianred",".indigo",".ivory",".khaki",".lavender",".lavenderblush",".lawngreen",".lemonchiffon",".lightblue",".lightcoral",".lightcyan",".lightgoldenrodyellow",".lightgray",".lightgreen",".lightgrey",".lightpink",".lightsalmon",".lightseagreen",".lightskyblue",".lightslategray",".lightslategrey",".lightsteelblue",".lightyellow",".lime",".limegreen",".linen",".magenta",".maroon",".mediumaquamarine",".mediumblue",".mediumorchid",".mediumpurple",".mediumseagreen",".mediumslateblue",".mediumspringgreen",".mediumturquoise",".mediumvioletred",".midnightblue",".mintcream",".mistyrose",".moccasin",".navajowhite",".navy",".oldlace",".olive",".olivedrab",".orange",".orangered",".orchid",".palegoldenrod",".palegreen",".paleturquoise",".palevioletred",".papayawhip",".peachpuff",".peru",".pink",".plum",".powderblue",".purple",".red",".rosybrown",".royalblue",".saddlebrown",".salmon",".sandybrown",".seagreen",".seashell",".sienna",".silver",".skyblue",".slateblue",".slategray",".slategrey",".snow",".springgreen",".steelblue",".tan",".teal",".thistle",".tomato",".turquoise",".violet",".wheat",".white",".whitesmoke",".yellow",".yellowgreen",""],coloursVal=["0xffffff","0xf0f8ff","0xfaebd7","0x00ffff","0x7fffd4","0xf0ffff","0xf5f5dc","0xffe4c4","0x000000","0xffebcd","0x0000ff","0x8a2be2","0xa52a2a","0xdeb887","0x5f9ea0","0x7fff00","0xd2691e","0xff7f50","0x6495ed","0xfff8dc","0xdc143c","0x00ffff","0x00008b","0x008b8b","0xb8860b","0xa9a9a9","0x006400","0xa9a9a9","0xbdb76b","0x8b008b","0x556b2f","0xff8c00","0x9932cc","0x8b0000","0xe9967a","0x8fbc8f","0x483d8b","0x2f4f4f","0x2f4f4f","0x00ced1","0x9400d3","0xff1493","0x00bfff","0x696969","0x696969","0x1e90ff","0xb22222","0xfffaf0","0x228b22","0xff00ff","0xdcdcdc","0xf8f8ff","0xffd700","0xdaa520","0x808080","0x008000","0xadff2f","0x808080","0xf0fff0","0xff69b4","0xcd5c5c","0x4b0082","0xfffff0","0xf0e68c","0xe6e6fa","0xfff0f5","0x7cfc00","0xfffacd","0xadd8e6","0xf08080","0xe0ffff","0xfafad2","0xd3d3d3","0x90ee90","0xd3d3d3","0xffb6c1","0xffa07a","0x20b2aa","0x87cefa","0x778899","0x778899","0xb0c4de","0xffffe0","0x00ff00","0x32cd32","0xfaf0e6","0xff00ff","0x800000","0x66cdaa","0x0000cd","0xba55d3","0x9370db","0x3cb371","0x7b68ee","0x00fa9a","0x48d1cc","0xc71585","0x191970","0xf5fffa","0xffe4e1","0xffe4b5","0xffdead","0x000080","0xfdf5e6","0x808000","0x6b8e23","0xffa500","0xff4500","0xda70d6","0xeee8aa","0x98fb98","0xafeeee","0xdb7093","0xffefd5","0xffdab9","0xcd853f","0xffc0cb","0xdda0dd","0xb0e0e6","0x800080","0xff0000","0xbc8f8f","0x4169e1","0x8b4513","0xfa8072","0xf4a460","0x2e8b57","0xfff5ee","0xa0522d","0xc0c0c0","0x87ceeb","0x6a5acd","0x708090","0x708090","0xfffafa","0x00ff7f","0x4682b4","0xd2b48c","0x008080","0xd8bfd8","0xff6347","0x40e0d0","0xee82ee","0xf5deb3","0xffffff","0xf5f5f5","0xffff00","0x9acd32"];function getColourVal(e){for(i=0;i<200&&""!=coloursNam[i];++i)if(e==coloursNam[i])return coloursVal[i];return -1}var editWin=296;function setupDivs(){resetLoadButton(),consoleReset();for(var e="",t=0,a=0;a<32;++a){e+='<div class="row"><div class="address" id="meml'+a+'">0x'+padHex(a,4)+"</div>";for(var r=0;r<4;++r)e+='<div class="word" id="a'+t+'" onclick="openAddress(this)" >0x0</div>',++t;e+="</div>"}setValue("memory",e),setPixelAreaSize(pixelAreaSize),e="";for(var a=0;a<512;++a)e+='<div id="c'+a+'"></div>';setValue("chars",e)}function setPixelAreaSize(e){var t="";if(12288==e?(pixelAreaSize=12288,removeClass("pixels","pixels1"),addClass("pixels","pixels2")):(pixelAreaSize=3072,removeClass("pixels","pixels2"),addClass("pixels","pixels1")),(5&pixelMask)!=0){document.getElementById("chars").style.display="none";for(var a=0;a<pixelAreaSize;++a)t+='<div id="p'+a+'" onclick="pixelInt(this)"></div>'}else{document.getElementById("chars").style.display="block";for(var a=0;a<pixelAreaSize;++a)t+='<div id="p'+a+'"></div>'}setValue("pixels",t)}function padHex(e,t){var a=Number(e).toString(16);for(t=null==t?t=2:t;a.length<t;)a="0"+a;return a}function message(e){if(0==dontDisplay){var t=document.getElementById("console");e?t.innerHTML=output1+"\n"+e:t.innerHTML=output1,scrollTimeout||(scrollTimeout=setTimeout(scroll_to_max,10),plhtmp=0)}lastMessage=e}function justConsole(){document.getElementById("console").innerHTML=output1,scrollTimeout||(scrollTimeout=setTimeout(scroll_to_max,10),plhtmp=0)}function scroll_to_max(){++plhtmp;var e=document.getElementById("console"),t=e.scrollTop;e.scrollTop=t+4e3,e.scrollTop!=t?scrollTimeout=setTimeout(scroll_to_max,10):(scrollTimeout=!1,debug&&plhtmp>100&&alert("Scroll attempts are "+plhtmp))}function videoWrite(e,t){e<0||e>=pixelAreaSize||(t&=16777215,document.getElementById("p"+e).style.background="#"+padHex(t,6))}function openNextMem(e){var t=document.getElementById("a"+e);return t.innerHTML=addressInputText(t.innerHTML),document.getElementById("aForm").focus(),document.getElementById("aForm").setAttribute("onblur","loseAddress(this)"),t}function insertTabInProgramArea(){var e=document.getElementById("pForm"),t=e.selectionStart;e.value=e.value.substring(0,e.selectionStart)+"	"+e.value.substring(e.selectionEnd),e.selectionEnd=t+1}function openProgramArea(e){addClass("program","edit");var t=document.getElementById("source");t.style.overflow="initial",t.style.whiteSpace="normal",t.innerHTML='<form action="javascript:programSubmit()"><textarea id="pForm" rows="36" cols="36"  spellcheck="false" >'+e.replace(/&/g,"&amp;"),(t=document.getElementById("pForm")).style.width=editWin+"px",t.focus()}function getProgramArea(){return document.getElementById("pForm").value}function resetProgramArea(e){setValue("source",e);var t=document.getElementById("source");t.style.overflow="auto",t.style.whiteSpace="nowrap",t.scrollTop=0,lastCodeHighlight=-1,breakpointAddr=-1,errorLineNum=-1}var lastState=0;function setStateReady(){changeState(1)}function setStateEdit(){changeState(2)}function setStateRunning(){changeState(4)}function setStateForceRunning(){5!=lastState&&changeState(4)}function setStateSlow(){changeState(5)}function setStatePaused(){changeState(6)}var plhComCnt=0;function changeState(e){function t(e){return 1==e?"ready":2==e?"edit":4==e?"running":5==e?"running+slow":6==e?"running+paused":e}if(lastState==e){++plhComCnt,2==debug&&setValue("credits","New state "+t(e)+" == Old state "+t(lastState)+" == Dup "+plhComCnt);return}if(plhComCnt=0,2==debug&&setValue("credits","New state "+t(e)+" == Old state "+t(lastState)),0!=lastState){if(6==lastState&&(removeClass("xxbody","paused"),lastState=4),5==lastState&&(removeClass("xxbody","slow"),lastState=4),lastState==e)return;if(4==lastState&&e>=4){if(lastState=e,4==e)return;5==e&&addClass("xxbody","slow"),6==e&&addClass("xxbody","paused");return}4==lastState&&removeClass("xxbody","running"),2==lastState&&removeClass("xxbody","edit"),1==lastState&&removeClass("xxbody","ready")}if(lastState=e,e>=4){addClass("xxbody","running"),5==e&&addClass("xxbody","slow"),6==e&&addClass("xxbody","paused");return}2==lastState&&addClass("xxbody","edit"),1==lastState&&addClass("xxbody","ready")}function intButtonReset(){removeClass("irq","enabled"),removeClass("irq","active")}function intButtonSetup(){addClass("irq","enabled")}function intButtonGrey(){removeClass("irq","active")}function intButtonShow(){addClass("irq","enabled"),addClass("irq","active")}function rewriteSide(){for(var e=16*overlay,t=0;t<32;++t)setValue("meml"+t,"0x"+padHex(e+t,4));setValue("page",padHex(overlay,3))}function changePage(){if(myMaybe||myTimeout)return!1;message("Modifying memory overlay"),setValue("page",overlayForm),document.getElementById("oForm").focus(),waitingForOverlay=!0}var overlayForm='<form action="javascript:pageSubmit()"><input id="oForm" type="text"></form>';function pageSubmit(){var e=document.getElementById("oForm");if(!e||!waitingForOverlay)return debug&&alert("Bad pageSubmit call"),!1;waitingForOverlay=!1;var t=parseInt(e.value,16);if(isNaN(t)||256*t>=maxUsableMem){setValue("page",padHex(overlay,3)),message("Bad page value");return}256*t==maxUsableMem-256&&--t,evPush("Pg"+padHex(t,3));var a=lastMemHighlight;removeMemHighlight(),overlay=t;var r=dontDisplay;dontDisplay=0,rewriteSide(),rewriteMemoryAndRegs(!0),a>=0&&setMemHighlight(a),dontDisplay=r,message("Page value set")}function resetLoadButton(){setValue("program-controls",loadText)}var loadText='<input type="file" id="read-input" onchange="read_chg(this)" autocomplete="off"><button id="load" onclick="document.getElementById(&#39;read-input&#39;).click()">Load</button><button  id="save" onclick="saveProgram()">Save</button><button  id="edit" onclick="openProgram()">Edit</button><button  id="submit" onclick="programSubmit()">Submit</button><button  id="revert" onclick="programCancel()">Revert</button>';function setLabel(e){var t=document.getElementById("lin"+e);t?t.classList.add("label"):debug&&alert("could not find line "+e+" to set label class")}function setCode(e,t){var a=document.getElementById("lin"+e);a?(a.classList.add("selectable"),a.title=t,a.setAttribute("onclick","javascript:setBreakpoint(this);")):debug&&alert("could not find line "+e+" to set code options")}function setData(e,t){var a=document.getElementById("lin"+e);a?a.title=t:debug&&alert("could not find line "+e+" to set data options")}function setBreakpoint(e){if(!waitingForInput&&!myTimeout&&!myMaybe){var t=parseInt(e.id.substring(3)),a=parseInt(e.title);if(isNaN(t)||isNaN(a)){debug&&alert("could not parse breakpoint id "+e.id+" title "+a);return}a==breakpointAddr?(e.classList.remove(breakpoint),breakpointAddr=-1,message("Breakpoint removed at line "+t+" address 0x"+padHex(a,5))):(breakpointAddr>=0&&removeClassFromLineNumber(addrToLine[breakpointAddr/4],breakpoint),breakpointAddr=a,e.classList.add(breakpoint),message("Breakpoint set at line "+t+" address 0x"+padHex(a,5)))}}function updateRDisplay(e,t){Math.floor(t)!=t&&(debug&&alert("Attempt to put non-integer value into register "+t),t=Math.floor(t));var a=""+t,r=a;t>2147483647&&(r="-"+(4294967296-t));for(var n="0b",$=0;$<32;++$)n+=t<<$&2147483648?"1":"0";var s="0x"+padHex(t,8),o="";0==memOpt?(t=r,o=a==r?s+" "+n:"("+a+") "+s+" "+n):1==memOpt?(t=a,o=a==r?s+" "+n:r+" "+s+" "+n):3==memOpt?(t=n,o=a==r?r+" "+s:r+" ("+a+") "+s):(t=s,o=a==r?r+" "+n:r+" ("+a+") "+n);var l=document.getElementById("R"+e);l?(l.innerHTML=t,l.title=o):debug&&alert("Simulator bug - cannot find R"+e+" to set new contents "+t)}function updateFlags(e){if(flags=15&e,1!=dontDisplay){var t=(8&e)!=0?"1":"0";t+=(4&e)!=0?"1":"0",t+=(2&e)!=0?"1":"0",setValue("flags",t+=(1&e)!=0?"1":"0")}}function addressInputText(e){return("0"==e||"0x00000000"==e||"0b00000000000000000000000000000000"==e)&&(e=""),'<form action="javascript:addressSubmit()"><input id="aForm" type="text" style="padding:0; border:0; font-family: monospace; width:'+(3==memOpt?"252":"75")+'px;height:14px;font-size:13.4px;" value="'+e+'"></form>'}function openAddressToEdit(e){e.innerHTML=addressInputText(e.innerHTML),document.getElementById("aForm").focus(),document.getElementById("aForm").setAttribute("onblur","loseAddress(this)")}function getAddressValue(){return document.getElementById("aForm").value}function resetAddressInput(){document.getElementById("aForm").removeAttribute("onblur")}var breakpoint="breakpoint",current="current",error="error";function updateDisplayedMemory(e,t){var a=""+t,r=a;t>2147483647&&(r="-"+(4294967296-t));for(var n="0b",$=0;$<32;++$)n+=t<<$&2147483648?"1":"0";var s="0x"+padHex(t,8),o="";0==memOpt?(t=r,o=a==r?s+" "+n:"("+a+") "+s+" "+n):1==memOpt?(t=a,o=a==r?s+" "+n:r+" "+s+" "+n):3==memOpt?(t=n,o=a==r?r+" "+s:r+" ("+a+") "+s):(t=s,o=a==r?r+" "+n:r+" ("+a+") "+n);var l=document.getElementById("a"+e);l?(l.innerHTML=t,l.title=o):debug&&alert("Simulator bug - cannot find a"+e+" to set new contents "+t)}function removeCodeHighlight(){lastCodeHighlight>=0&&(document.getElementById("lin"+lastCodeHighlight).classList.remove(current),lastCodeHighlight=-1)}function showExecute(e){removeCodeHighlight(),addClassToLineNumber(e,current),lastCodeHighlight=e}function showExecuteStop(e){removeCodeHighlight(),addClassToLineNumber(e,current),lastCodeHighlight=e;var t=(e-18)*15.2395;e<30&&(t=0),document.getElementById("source").scrollTop=t}function showError(e){addClassToLineNumber(e,error),byteCount=0,errorLineNum=e;var t=(e-18)*15.2395;e<30&&(t=0),document.getElementById("source").scrollTop=t}function removeError(){errorLineNum>=0&&(removeClassFromLineNumber(errorLineNum,error),errorLineNum=-1)}function addClassToLineNumber(e,t){if(!(e<0)){var a=document.getElementById("lin"+e);a?a.classList.add(t):debug&&alert("could not find line "+e+" to add class "+t)}}function removeClassFromLineNumber(e,t){if(!(e<0)){var a=document.getElementById("lin"+e);a?a.classList.remove(t):debug&&alert("could not find line "+e+" to remove class "+t)}}function removeMemHighlight(){if(lastMemHighlight>=0){var e=256*overlay;lastMemHighlight>=e&&lastMemHighlight<e+512&&(e=Math.floor((lastMemHighlight-e)/4),document.getElementById("a"+e).classList.remove(current)),lastMemHighlight=-1}}function setMemHighlight(e){if(removeMemHighlight(),!(e<0)){var t=256*overlay;e>=t&&e<t+512&&(t=Math.floor((e-t)/4),document.getElementById("a"+t).classList.add(current)),lastMemHighlight=e}}function IEKeyEnable(){document.getElementById("xxbody").focus()}function clearInputArea(){setValue("input","&nbsp;")}function enableInput(e){e?setValue("input",inputFormSecret):setValue("input",inputForm),document.getElementById("iForm").focus()}var inputForm='<form action="javascript:inputSubmit()"><input id="iForm" type="text" placeholder="Input expected"></form>',inputFormSecret='<form action="javascript:inputSubmit()"><input id="iForm" type="password" placeholder="Input expected"></form>';function showChar(e,t){if(e<0||e>=512){debug&&alert("Bad index for showChar() "+e);return}var a="";t>32&&t<128&&(a="<"==t?"&lt;":">"==t?"&gt;":"&"==t?"&amp;":String.fromCharCode(t)),setValue("c"+e,a)}function getInput(){var e=document.getElementById("iForm");return e?e.value:(debug&&alert("Bad getInput call"),!1)}function inputRestore(e){setValue("input",e)}function clearIR(){setValue("ir","&nbsp;"),setValue("ur","&nbsp;")}function setIR(e){setValue("ir",e)}function addIR(e){setValue("ur",e)}function fileOpen(){setValue("outer_console",'<textarea class="console" id="console" readonly>'+output1+"\n</textarea>"+fileText),document.getElementById("read-file").click()}var fileText='<input type="file" id="read-file" onchange="read_file(this)" autocomplete="off"><button onclick="document.getElementById(&#39;read-file&#39;).click()">File Open required</button>';function consoleReset(){setValue("outer_console",'<textarea class="console" id="console" readonly>'+output1+"\n</textarea>")}function saveFile(e,t){var a=new Blob([e],{type:"text/plain"}),r=window.URL.createObjectURL(a),n=document.createElement("a");n.download=t,n.innerHTML="Download File",n.href=r,n.onclick=destroyClickedElement,n.style.display="none",document.body.appendChild(n),n.click()}function destroyClickedElement(e){document.body.removeChild(e.target)}function setValue(e,t){var a=document.getElementById(e);a?a.innerHTML=t:debug&&alert("Simulator bug - cannot find "+e+" to set new contents "+t)}function setClass(e,t){var a=document.getElementById(e);a||(debug?alert("Simulator bug - cannot find "+e+" to set new class "+t):a.className=t)}function addClass(e,t){var a=document.getElementById(e);a?a.classList.add(t):debug&&alert("Simulator bug - cannot find "+e+" to add class "+t)}function removeClass(e,t){var a=document.getElementById(e);a?a.classList.remove(t):debug&&alert("Simulator bug - cannot find "+e+" to remove class "+newClass)}function setProgramWidth(e){editWin=e-4;var t=e+50,a=e+400;3==memOpt&&(a+=170);var r=document.getElementById("mxx");r?r.style.left=a+"px":debug&&alert("Simulator bug - cannot find mxx to set left "+a);var r=document.getElementById("processor");r?r.style.left=t+"px":debug&&alert("Simulator bug - cannot find processor to set left "+t);var r=document.getElementById("io");r?r.style.left=t+"px":debug&&alert("Simulator bug - cannot find io to set left "+t);var r=document.getElementById("program");r?r.style.width=e+"px":debug&&alert("Simulator bug - cannot find program to set width "+e),modifyingProgram&&((r=document.getElementById("pForm")).style.width=editWin+"px")}function setMemBinary(e){var t=editWin+404;e&&(t+=170);var a=document.getElementById("mxx");a?(a.style.left=t+"px",e?a.style.fontSize=binarySize+"%":a.style.fontSize="100%"):debug&&alert("Simulator bug - cannot find mxx to set left "+t),(a=document.getElementById("registers"))?e?a.style.fontSize=binarySize+"%":a.style.fontSize="100%":debug&&alert("Simulator bug - cannot find registers to set fontSize")}function changeDimensions(){if(getDimensions(),dynamicProgramWidth){var e=maxWidth-826;e<300&&(e=300),e>3e3&&(e=3e3),setProgramWidth(e)}}function evStep(){if(0==eventCount){evFirst(),evPusha("St1");return}++eventStep<100&&Date.now()-logTime<3e5||(evPusha("St"+eventStep),eventStep=0)}function evFirst(){_paq.push(["trackEvent","First",plh_url+" "+plh_id]),eventCount=55}function evPush(e){0==eventCount&&evFirst(),0!=eventStep&&(evPusha("St"+eventStep),eventStep=0),evPusha(e)}function evPusha(e){if(""==eventList?eventList=e:eventList+=" "+e,!(eventList.length<1500&&Date.now()-logTime<3e5&&++eventCount<53)){var t="https://www.peterhigginson.co.uk:/log/log.php?u="+plh_url+"&i="+plh_id+"&x="+eventList;if(window.fetch)fetch(new Request(t),{method:"GET",mode:"no-cors",keepalive:!0});else{var a=new XMLHttpRequest;a.open("GET",t+" OLD",!0),a.send()}logTime=Date.now(),eventList="",eventCount=2}}function flushLog(){eventCount>1&&(eventCount=55,evPush("Unld"),eventCount=1)}